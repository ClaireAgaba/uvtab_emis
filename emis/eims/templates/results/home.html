{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-4 text-gray-900">Results Management</h1>

    <!-- Action Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 max-w-2xl">
      <!-- Generate Marksheets Card -->
      <button id="generate-marksheet-btn"
          data-occupation-id="{{ filters.occupation|default:'' }}"
          data-level-id="{{ filters.level|default:'' }}"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg shadow-md hover:shadow-lg text-sm font-semibold flex flex-col items-center transform hover:scale-105 transition-all duration-200">
        <span class="text-2xl mb-1">üìÑ</span>
        Generate Marksheets
      </button>
      <!-- Print Marksheet Card -->
      <button id="print-marksheet-btn"
          class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg shadow-md hover:shadow-lg text-sm font-semibold flex flex-col items-center transform hover:scale-105 transition-all duration-200">
        <span class="text-2xl mb-1">üñ®Ô∏è</span>
        Print Marksheet
      </button>
      <!-- Upload Marks Card -->
      <a href="#" id="upload-marks-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg shadow-md hover:shadow-lg text-sm font-semibold flex flex-col items-center transform hover:scale-105 transition-all duration-200">
        <span class="text-2xl mb-1">‚¨ÜÔ∏è</span>
        Upload Marks
      </a>
    </div>

  <!-- Modal for Generate Marksheets -->
  <div id="marksheet-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-8 relative">
      <button id="close-marksheet-modal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
      <h2 class="text-xl font-bold mb-4">Generate Marksheet Template</h2>
      <form id="marksheet-form" method="post" action="{% url 'generate_marksheet' %}">
        {% csrf_token %}
        <div id="marksheet-msg" class="mb-2 text-sm text-red-600"></div>
        <div id="marksheet-download-link" class="mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Assessment Series <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <select name="assessment_month" id="assessment-month" required class="border px-3 py-2 rounded w-full">
                <option value="">Month</option>
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
              </select>
              <select name="assessment_year" id="assessment-year" required class="border px-3 py-2 rounded w-full">
                <!-- Years will be populated by JS -->
              </select>
            </div>
          </div>
          <div>
            <label class="block font-medium mb-1">Registration Category <span class="text-red-500">*</span></label>
            <select name="registration_category" id="reg-category-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <option value="modular">Modular</option>
              <option value="formal">Formal</option>
              <option value="workers_pas">Worker's PAS</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Occupation <span class="text-red-500">*</span></label>
            <select name="occupation" id="occupation-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="level-field" class="hidden">
            <label class="block font-medium mb-1">Level <span class="text-red-500">*</span></label>
            <select name="level" id="level-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="modules-field" class="hidden">
            <label class="block font-medium mb-1">Select Module(s) <span class="text-red-500">*</span></label>
            <select name="modules" id="modules-select" multiple class="border px-3 py-2 rounded w-full">
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Assessment Center (optional)</label>
            <select name="assessment_center" id="center-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Centers --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" id="cancel-marksheet-modal" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">Generate</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Print Marksheet -->
  <div id="print-marksheet-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-8 relative">
      <button id="close-print-marksheet-modal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
      <h2 class="text-xl font-bold mb-4">Print Marksheet</h2>
      <form id="print-marksheet-form" method="post" action="{% url 'print_marksheet' %}">
        {% csrf_token %}
        <div id="print-marksheet-msg" class="mb-2 text-sm text-red-600"></div>
        <div id="print-marksheet-download-link" class="mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Assessment Series <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <select name="assessment_month" id="print-assessment-month" required class="border px-3 py-2 rounded w-full">
                <option value="">Month</option>
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
              </select>
              <select name="assessment_year" id="print-assessment-year" required class="border px-3 py-2 rounded w-full">
                <!-- Years will be populated by JS -->
              </select>
            </div>
          </div>
          <div>
            <label class="block font-medium mb-1">Registration Category <span class="text-red-500">*</span></label>
            <select name="registration_category" id="print-reg-category-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <option value="modular">Modular</option>
              <option value="formal">Formal</option>
              <option value="workers_pas">Worker's PAS</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Occupation <span class="text-red-500">*</span></label>
            <select name="occupation" id="print-occupation-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="print-level-field" class="hidden">
            <label class="block font-medium mb-1">Level <span class="text-red-500">*</span></label>
            <select name="level" id="print-level-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="print-modules-field" class="hidden">
            <label class="block font-medium mb-1">Select Module(s) <span class="text-red-500">*</span></label>
            <select name="modules" id="print-modules-select" multiple class="border px-3 py-2 rounded w-full">
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Assessment Center (optional)</label>
            <select name="assessment_center" id="print-center-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Centers --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" id="cancel-print-marksheet-modal" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">Print</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Upload Marks -->
  <div id="upload-marks-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-8 relative">
      <button id="close-upload-marks-modal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
      <h2 class="text-xl font-bold mb-4">Upload Marks (Bulk)</h2>
      <form id="upload-marks-form" method="post" enctype="multipart/form-data" action="{% url 'upload_marks' %}">
        {% csrf_token %}
        <div id="upload-marks-msg" class="mb-2 text-sm text-red-600"></div>
        <div id="upload-marks-success" class="mb-2 text-sm text-green-600"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Assessment Series <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <select name="assessment_month" id="upload-assessment-month" required class="border px-3 py-2 rounded w-full">
                <option value="">Month</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
              <select name="assessment_year" id="upload-assessment-year" required class="border px-3 py-2 rounded w-full">
                <!-- Years will be populated by JS -->
              </select>
            </div>
          </div>
          <div>
            <label class="block font-medium mb-1">Registration Category <span class="text-red-500">*</span></label>
            <select name="registration_category" id="upload-reg-category-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <option value="modular">Modular</option>
              <option value="formal">Formal</option>
              <option value="workers_pas">Worker's PAS</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Occupation <span class="text-red-500">*</span></label>
            <select name="occupation" id="upload-occupation-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="upload-level-field" class="hidden">
            <label class="block font-medium mb-1">Level <span class="text-red-500">*</span></label>
            <select name="level" id="upload-level-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="upload-modules-field" class="hidden">
            <label class="block font-medium mb-1">Select Module(s) <span class="text-red-500">*</span></label>
            <select name="modules" id="upload-modules-select" multiple class="border px-3 py-2 rounded w-full">
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Assessment Center (optional)</label>
            <select name="assessment_center" id="upload-center-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Centers --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div class="col-span-2">
            <label class="block font-medium mb-1">Excel File <span class="text-red-500">*</span></label>
            <input type="file" name="marks_file" id="marks-file-input" accept=".xlsx,.xls" required class="border px-3 py-2 rounded w-full" />
          </div>
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" id="cancel-upload-marks-modal" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">Upload</button>
        </div>
      </form>
    </div>
  </div>

    <!-- Enrolled Candidates Table -->
    <div class="bg-white rounded-lg shadow-md border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Enrolled Candidates</h2>
        
        <!-- Filter Form -->
        <form method="get" class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <input type="text" name="reg_number" value="{{ filters.reg_number }}" 
                   placeholder="Reg Number" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <input type="text" name="name" value="{{ filters.name }}" 
                   placeholder="Name" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <select name="registration_category" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">All Categories</option>
              {% for value, label in reg_categories %}
                <option value="{{ value }}" {% if filters.registration_category == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
              Filter
            </button>
            <a href="{% url 'results_home' %}" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
              Reset
            </a>
          </div>
        </form>
      </div>
      
      <!-- Count and Pagination Info -->
      <div class="px-6 py-2 bg-gray-50 text-sm text-gray-600 flex justify-between items-center">
        <span>
          {{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ paginator.count }}
        </span>
        <span>
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="inline-block px-2">&#60;</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="inline-block px-2">&#62;</a>
          {% endif %}
        </span>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reg Number</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registration Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Occupation</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Status</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for item in candidates_with_status %}
            <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location.href='{% url 'candidate_view' item.candidate.id %}?from=results'">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                {{ item.candidate.reg_number }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ item.candidate.full_name }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ item.candidate.get_registration_category_display }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ item.candidate.occupation.name|default:"N/A" }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                {% if item.upload_status == 'Uploaded' %}
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    Uploaded
                  </span>
                {% else %}
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                    Not Uploaded
                  </span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                No enrolled candidates found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      // --- CACHED DATA ---
      let allOccupations = [];
      let allLevels = [];
      let allCenters = [];
      let dataFetched = false;

      // --- ASYNC DATA FETCHER ---
      async function fetchDataIfNeeded() {
          if (dataFetched) return;
          try {
              const [occResponse, lvlResponse, centerResponse] = await Promise.all([
                  fetch('/eims/api/occupations/'),
                  fetch('/eims/api/levels/'),
                  fetch('/eims/api/centers/')
              ]);
              if (occResponse.ok) allOccupations = await occResponse.json();
              if (lvlResponse.ok) allLevels = await lvlResponse.json();
              if (centerResponse.ok) allCenters = await centerResponse.json();
              dataFetched = true;
          } catch (error) {
              console.error('Failed to fetch initial data:', error);
          }
      }

      // --- UI HELPER FUNCTIONS ---
      function populateYearDropdown(selectElement) {
          selectElement.innerHTML = '';
          const now = new Date();
          const currentYear = now.getFullYear();
          for (let y = currentYear - 5; y <= currentYear + 5; y++) {
              const opt = document.createElement('option');
              opt.value = y;
              opt.text = y;
              if (y === currentYear) opt.selected = true;
              selectElement.appendChild(opt);
          }
      }

      function populateCentersDropdown(selectElement) {
          selectElement.innerHTML = '<option value="">-- All Centers --</option>';
          allCenters.forEach(c => {
              selectElement.innerHTML += `<option value="${c.id}">${c.name}</option>`;
          });
      }

      // --- CORE MODAL LOGIC ---
      function setupModal(config) {
          const openBtn = document.getElementById(config.openBtnId);
          const modal = document.getElementById(config.modalId);
          const closeBtn = document.getElementById(config.closeBtnId);
          const cancelBtn = document.getElementById(config.cancelBtnId);
          const form = document.getElementById(config.formId);
          const regCategorySelect = document.getElementById(config.regCategorySelectId);
          const occupationSelect = document.getElementById(config.occupationSelectId);
          const levelField = document.getElementById(config.levelFieldId);
          const levelSelect = document.getElementById(config.levelSelectId);
          const modulesField = document.getElementById(config.modulesFieldId);
          const modulesSelect = document.getElementById(config.modulesSelectId);
          const yearSelect = document.getElementById(config.yearSelectId);
          const centerSelect = document.getElementById(config.centerSelectId);
          const msgDiv = document.getElementById(config.msgId);
          const linkDiv = document.getElementById(config.linkId);

          // Attach event listeners
          openBtn.addEventListener('click', async () => {
              await fetchDataIfNeeded();
              populateYearDropdown(yearSelect);
              populateCentersDropdown(centerSelect);
              updateOccupationOptions();
              modal.classList.remove('hidden');
          });

          closeBtn.onclick = cancelBtn.onclick = () => modal.classList.add('hidden');
          window.addEventListener('click', (e) => {
              if (e.target === modal) modal.classList.add('hidden');
          });

          regCategorySelect.onchange = updateOccupationOptions;
          occupationSelect.onchange = updateLevelAndModuleOptions;

          function updateOccupationOptions() {
              const regcat = regCategorySelect.value;
              occupationSelect.innerHTML = '<option value="">-- Select --</option>';
              let filtered = allOccupations;

              if (regcat === 'formal') {
                  filtered = allOccupations.filter(o => o.category === 'formal');
              } else if (regcat === 'workers_pas') {
                  filtered = allOccupations.filter(o => o.category === 'informal');
              } else if (regcat === 'modular') {
                  filtered = allOccupations.filter(o => o.category === 'formal' && o.has_modular);
              }

              filtered.forEach(o => {
                  occupationSelect.innerHTML += `<option value="${o.id}">${o.name}</option>`;
              });
              updateLevelAndModuleOptions();
          }

          function updateLevelAndModuleOptions() {
              const regcat = regCategorySelect.value;
              const occId = parseInt(occupationSelect.value, 10);
              levelSelect.innerHTML = '<option value="">-- Select --</option>';
              modulesSelect.innerHTML = '';

              // Handle modules for 'Modular' category
              if (regcat === 'modular' && occId) {
                  modulesField.classList.remove('hidden');
                  levelField.classList.add('hidden');
                  fetch(`/eims/api/modules/?occupation_id=${occId}`)
                      .then(res => res.json())
                      .then(data => {
                          const modulesArray = Array.isArray(data) ? data : (data.modules || []);
                          modulesSelect.innerHTML = '';
                          modulesArray.forEach(m => {
                              modulesSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                          });
                      }).catch(err => console.error('Failed to fetch modules:', err));
              } else {
                  modulesField.classList.add('hidden');
              }

              // Handle levels for other categories
              if ((regcat === 'formal' || regcat === 'workers_pas') && occId) {
                  levelField.classList.remove('hidden');
                  const occLevels = allLevels.filter(lvl => lvl.occupation_id === occId);
                  occLevels.forEach(lvl => {
                      levelSelect.innerHTML += `<option value="${lvl.id}">${lvl.name}</option>`;
                  });
              } else if (regcat !== 'modular') {
                  levelField.classList.add('hidden');
              }
          }

          form.onsubmit = async function(e) {
              e.preventDefault();
              const formData = new FormData(form);
              msgDiv.textContent = '';
              if(linkDiv) linkDiv.innerHTML = '';

              try {
                  const response = await fetch(form.action, {
                      method: 'POST',
                      body: formData,
                      headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
                  });
                  const data = await response.json();
                  if (data.success) {
                      if(linkDiv) linkDiv.innerHTML = `<a href="${data.download_url}" class="text-blue-600 font-bold hover:underline" target="_blank">${config.linkText}</a>`;
                  } else {
                      msgDiv.textContent = data.error || 'An unknown error occurred.';
                  }
              } catch (error) {
                  console.error('Error submitting form:', error);
                  msgDiv.textContent = 'A network error occurred. Please try again.';
              }
          };
      }

      // --- INITIALIZE ALL MODALS ---
      setupModal({
          openBtnId: 'generate-marksheet-btn',
          modalId: 'marksheet-modal',
          closeBtnId: 'close-marksheet-modal',
          cancelBtnId: 'cancel-marksheet-modal',
          formId: 'marksheet-form',
          regCategorySelectId: 'reg-category-select',
          occupationSelectId: 'occupation-select',
          levelFieldId: 'level-field',
          levelSelectId: 'level-select',
          modulesFieldId: 'modules-field',
          modulesSelectId: 'modules-select',
          yearSelectId: 'assessment-year',
          centerSelectId: 'center-select',
          msgId: 'marksheet-msg',
          linkId: 'marksheet-download-link',
          linkText: 'Download Marksheet'
      });

      setupModal({
          openBtnId: 'print-marksheet-btn',
          modalId: 'print-marksheet-modal',
          closeBtnId: 'close-print-marksheet-modal',
          cancelBtnId: 'cancel-print-marksheet-modal',
          formId: 'print-marksheet-form',
          regCategorySelectId: 'print-reg-category-select',
          occupationSelectId: 'print-occupation-select',
          levelFieldId: 'print-level-field',
          levelSelectId: 'print-level-select',
          modulesFieldId: 'print-modules-field',
          modulesSelectId: 'print-modules-select',
          yearSelectId: 'print-assessment-year',
          centerSelectId: 'print-center-select',
          msgId: 'print-marksheet-msg',
          linkId: 'print-marksheet-download-link',
          linkText: 'Download Printable Marksheet'
      });
      
      // --- UPLOAD MARKS MODAL LOGIC ---
      const uploadBtn = document.getElementById('upload-marks-btn');
      const uploadModal = document.getElementById('upload-marks-modal');
      const closeUploadBtn = document.getElementById('close-upload-marks-modal');
      const cancelUploadBtn = document.getElementById('cancel-upload-marks-modal');
      const uploadForm = document.getElementById('upload-marks-form');
      const uploadRegCategorySelect = document.getElementById('upload-reg-category-select');
      const uploadOccupationSelect = document.getElementById('upload-occupation-select');

      if (uploadBtn) {
          uploadBtn.onclick = async (e) => {
              e.preventDefault();
              await fetchDataIfNeeded();
              populateYearDropdown(document.getElementById('upload-assessment-year'));
              populateCentersDropdown(document.getElementById('upload-center-select'));
              uploadUpdateOccupationOptions();
              uploadModal.classList.remove('hidden');
          };
      }

      if(closeUploadBtn) closeUploadBtn.onclick = () => uploadModal.classList.add('hidden');
      if(cancelUploadBtn) cancelUploadBtn.onclick = () => uploadModal.classList.add('hidden');
      window.addEventListener('click', (e) => {
          if (e.target === uploadModal) uploadModal.classList.add('hidden');
      });

      function uploadUpdateOccupationOptions() {
          const regcat = uploadRegCategorySelect.value;
          uploadOccupationSelect.innerHTML = '<option value="">-- Select --</option>';
          let filtered = allOccupations;
          if (regcat === 'formal') {
              filtered = allOccupations.filter(o => o.category === 'formal');
          } else if (regcat === 'workers_pas') {
              filtered = allOccupations.filter(o => o.category === 'informal');
          } else if (regcat === 'modular') {
              filtered = allOccupations.filter(o => o.category === 'formal' && o.has_modular);
          }
          filtered.forEach(o => {
              uploadOccupationSelect.innerHTML += `<option value="${o.id}">${o.name}</option>`;
          });
          uploadUpdateLevelAndModuleOptions();
      }

      function uploadUpdateLevelAndModuleOptions() {
          const regcat = uploadRegCategorySelect.value;
          const occId = parseInt(uploadOccupationSelect.value, 10);
          const levelField = document.getElementById('upload-level-field');
          const levelSelect = document.getElementById('upload-level-select');
          levelSelect.innerHTML = '<option value="">-- Select --</option>';
          const modulesField = document.getElementById('upload-modules-field');
          const modulesSelect = document.getElementById('upload-modules-select');
          modulesSelect.innerHTML = '';

          if (regcat === 'modular' && occId) {
              modulesField.classList.remove('hidden');
              levelField.classList.add('hidden');
              fetch(`/eims/api/modules/?occupation_id=${occId}`)
                  .then(res => res.json())
                  .then(data => {
                      const modulesArray = Array.isArray(data) ? data : (data.modules || []);
                      modulesSelect.innerHTML = '';
                      modulesArray.forEach(m => {
                          modulesSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                      });
                  }).catch(err => console.error('Failed to fetch modules for upload:', err));
          } else {
              modulesField.classList.add('hidden');
          }

          if ((regcat === 'formal' || regcat === 'workers_pas') && occId) {
              levelField.classList.remove('hidden');
              const occupationLevels = allLevels.filter(lvl => lvl.occupation_id === occId);
              occupationLevels.forEach(lvl => {
                  levelSelect.innerHTML += `<option value="${lvl.id}">${lvl.name}</option>`;
              });
          } else if (regcat !== 'modular') {
              levelField.classList.add('hidden');
          }
      }

      if(uploadRegCategorySelect) uploadRegCategorySelect.onchange = uploadUpdateOccupationOptions;
      if(uploadOccupationSelect) uploadOccupationSelect.onchange = uploadUpdateLevelAndModuleOptions;

      if(uploadForm) {
          uploadForm.addEventListener('submit', async function(e) {
              e.preventDefault();
              const formData = new FormData(uploadForm);
              const msgDiv = document.getElementById('upload-marks-msg');
              const successDiv = document.getElementById('upload-marks-success');
              msgDiv.textContent = '';
              successDiv.textContent = '';

              try {
                  const response = await fetch(uploadForm.action, {
                      method: 'POST',
                      body: formData,
                      headers: {
                          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                      },
                  });

                  const data = await response.json();

                  if (data.success) {
                      successDiv.textContent = `Successfully uploaded marks for ${data.updated_count} records.`;
                      uploadForm.reset();
                  }

                  if (data.errors && data.errors.length > 0) {
                      msgDiv.innerHTML = '<strong>Upload failed with the following errors:</strong><br>' + data.errors.join('<br>');
                  } else if (!data.success) {
                      msgDiv.textContent = data.error || 'An unknown error occurred.';
                  }
              } catch (error) {
                  console.error('Error uploading marks:', error);
                  msgDiv.textContent = 'A network error occurred. Please try again.';
              }
          });
      }

  });
  </script>
  <script src="/static/js/results_marksheet_modules.js"></script>
  {% endblock %}
