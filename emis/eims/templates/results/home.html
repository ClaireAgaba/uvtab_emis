{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto mt-10 bg-white rounded shadow p-8">
  <h1 class="text-2xl font-bold mb-6">Results</h1>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
    <!-- Generate Marksheets Card -->
    <button id="generate-marksheet-btn"
        data-occupation-id="{{ filters.occupation|default:'' }}"
        data-level-id="{{ filters.level|default:'' }}"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-lg shadow text-lg font-semibold flex flex-col items-center">
      <span class="text-3xl mb-2">üìÑ</span>
      Generate Marksheets
    </button>
    <!-- Upload Marks Card -->
    <a href="#" class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-lg shadow text-lg font-semibold flex flex-col items-center">
      <span class="text-3xl mb-2">‚¨ÜÔ∏è</span>
      Upload Marks
    </a>
  </div>
  <!-- Modal for Generate Marksheets -->
  <div id="marksheet-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-8 relative">
      <button id="close-marksheet-modal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
      <h2 class="text-xl font-bold mb-4">Generate Marksheet Template</h2>
      <form id="marksheet-form" method="post">
        {% csrf_token %}
        <div id="marksheet-msg" class="mb-2 text-sm text-red-600"></div>
        <div id="marksheet-download-link" class="mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Assessment Series <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <select name="assessment_month" id="assessment-month" required class="border px-3 py-2 rounded w-full">
                <option value="">Month</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
              <select name="assessment_year" id="assessment-year" required class="border px-3 py-2 rounded w-full">
                <!-- Years will be populated by JS -->
              </select>
            </div>
          </div>
          <div>
            <label class="block font-medium mb-1">Registration Category <span class="text-red-500">*</span></label>
            <select name="registration_category" id="reg-category-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <option value="modular">Modular</option>
              <option value="formal">Formal</option>
              <option value="workers_pas">Worker's PAS</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Occupation <span class="text-red-500">*</span></label>
            <select name="occupation" id="occupation-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="level-field" class="hidden">
            <label class="block font-medium mb-1">Level <span class="text-red-500">*</span></label>
            <select name="level" id="level-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="modules-field" class="hidden">
            <label class="block font-medium mb-1">Select Module(s) <span class="text-red-500">*</span></label>
            <select name="modules" id="modules-select" multiple class="border px-3 py-2 rounded w-full">
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Assessment Center (optional)</label>
            <select name="assessment_center" id="center-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Centers --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" id="cancel-marksheet-modal" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">Generate</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Modal open/close logic
const openBtn = document.getElementById('generate-marksheet-btn');
const modal = document.getElementById('marksheet-modal');
const closeBtn = document.getElementById('close-marksheet-modal');
const cancelBtn = document.getElementById('cancel-marksheet-modal');
openBtn.onclick = () => modal.classList.remove('hidden');
closeBtn.onclick = cancelBtn.onclick = () => modal.classList.add('hidden');
window.onclick = function(e) { if (e.target === modal) modal.classList.add('hidden'); };

// --- Dynamic Occupation/Level Population ---
let allOccupations = [];
let allLevels = [];

// Fetch all occupations and levels from backend when modal opens
openBtn.onclick = async () => {
  modal.classList.remove('hidden');
  populateYearDropdown();
  await populateCentersDropdown();
  // Fetch occupations
  const occResp = await fetch('/eims/api/occupations/');
  if (occResp.ok) {
    allOccupations = await occResp.json();
  }
  // Fetch levels
  const lvlResp = await fetch('/eims/api/levels/');
  if (lvlResp.ok) {
    allLevels = await lvlResp.json();
  }
  updateOccupationOptions();
  // --- Pre-select occupation and level if provided ---
  const preOccId = openBtn.getAttribute('data-occupation-id');
  const preLvlId = openBtn.getAttribute('data-level-id');
  if (preOccId) {
    document.getElementById('occupation-select').value = String(parseInt(preOccId, 10));
    updateLevelOptions();
    if (preLvlId) {
      document.getElementById('level-select').value = String(parseInt(preLvlId, 10));
    }
  }
};

function updateOccupationOptions() {
  const regcat = document.getElementById('reg-category-select').value;
  const occSelect = document.getElementById('occupation-select');
  occSelect.innerHTML = '<option value="">-- Select --</option>';
  let filtered = allOccupations;
  if (regcat === 'formal') {
    filtered = allOccupations.filter(o => o.category === 'formal');
  } else if (regcat === "workers_pas") {
    filtered = allOccupations.filter(o => o.category === 'informal');
  } else if (regcat === 'modular') {
    filtered = allOccupations.filter(o => o.category === 'formal' && o.has_modular);
  }
  filtered.forEach(o => {
    occSelect.innerHTML += `<option value="${o.id}">${o.name}</option>`;
  });
  updateLevelOptions();
}

function updateLevelOptions() {
  const regcat = document.getElementById('reg-category-select').value;
  const occId = parseInt(document.getElementById('occupation-select').value);
  const levelField = document.getElementById('level-field');
  const levelSelect = document.getElementById('level-select');
  levelSelect.innerHTML = '<option value="">-- Select --</option>';
  if ((regcat === 'formal' || regcat === 'informal') && occId) {
    levelField.classList.remove('hidden');
    // Filter levels by occupation
    const occLevels = allLevels.filter(lvl => lvl.occupation_id === occId);
    occLevels.forEach(lvl => {
      levelSelect.innerHTML += `<option value="${lvl.id}">${lvl.name}</option>`;
    });
  } else {
    levelField.classList.add('hidden');
  }
}

document.getElementById('reg-category-select').onchange = updateOccupationOptions;
document.getElementById('occupation-select').onchange = updateLevelOptions;
// Populate centers dynamically from API
async function populateCentersDropdown() {
  const centerSelect = document.getElementById('center-select');
  centerSelect.innerHTML = '<option value="">-- All Centers --</option>';
  try {
    const resp = await fetch('/eims/api/centers/');
    if (resp.ok) {
      const centers = await resp.json();
      centers.forEach(c => {
        centerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      });
    }
  } catch (err) {
    // Optionally show error
  }
}

function populateYearDropdown() {
  const yearSelect = document.getElementById('assessment-year');
  yearSelect.innerHTML = '';
  const now = new Date();
  const currentYear = now.getFullYear();
  for (let y = currentYear - 5; y <= currentYear + 5; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.text = y;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}

// --- AJAX for marksheet generation ---
document.getElementById('marksheet-form').onsubmit = async function(e) {
  e.preventDefault();
  const form = e.target;
  const msgDiv = document.getElementById('marksheet-msg');
  const linkDiv = document.getElementById('marksheet-download-link');
  msgDiv.textContent = '';
  linkDiv.innerHTML = '';
  const data = new FormData(form);
  try {
    const resp = await fetch("/eims/results/generate-marksheet/", {
      method: "POST",
      headers: {
        'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: data
    });
    if (!resp.ok) throw new Error('Server error');
    const json = await resp.json();
    if (json.success && json.download_url) {
      // Ensure download link is prefixed with /eims/ if not already
      let downloadUrl = json.download_url;
      if (!downloadUrl.startsWith('/eims/')) {
        if (downloadUrl.startsWith('/')) downloadUrl = '/eims' + downloadUrl;
        else downloadUrl = '/eims/' + downloadUrl;
      }
      linkDiv.innerHTML = `<a href="${downloadUrl}" target="_blank" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Download Marksheet Template</a>`;
      msgDiv.textContent = '';
    } else {
      msgDiv.textContent = json.error || 'An error occurred.';
    }
  } catch (err) {
    msgDiv.textContent = err.message || 'An error occurred.';
  }
};
</script>
<script src="/static/js/results_marksheet_modules.js"></script>
{% endblock %}
