{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-4 text-gray-900">Results Management</h1>

    {% if results_not_released %}
    <!-- Results Not Released Message (Only shown to center representatives) -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">
            Results Not Yet Released
          </h3>
          <div class="mt-2 text-sm text-yellow-700">
            <p>
              Results for {% if current_series %}{{ current_series.name }}{% else %}the current assessment series{% endif %} have not been released yet. 
              Please contact your administrator to release results before they can be viewed.
            </p>
          </div>
        </div>
      </div>
    </div>
    {% else %}
      <!-- Action Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 max-w-2xl">
      <!-- Generate Marksheets Card -->
      <button id="generate-marksheet-btn"
          data-occupation-id="{{ filters.occupation|default:'' }}"
          data-level-id="{{ filters.level|default:'' }}"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg shadow-md hover:shadow-lg text-sm font-semibold flex flex-col items-center transform hover:scale-105 transition-all duration-200">
        <span class="text-2xl mb-1">üìÑ</span>
        Generate Marksheets
      </button>
      <!-- Print Marksheet Card -->
      <button id="print-marksheet-btn"
          class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg shadow-md hover:shadow-lg text-sm font-semibold flex flex-col items-center transform hover:scale-105 transition-all duration-200">
        <span class="text-2xl mb-1">üñ®Ô∏è</span>
        Print Marksheet
      </button>
      <!-- Upload Marks Card -->
      <a href="#" id="upload-marks-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg shadow-md hover:shadow-lg text-sm font-semibold flex flex-col items-center transform hover:scale-105 transition-all duration-200">
        <span class="text-2xl mb-1">‚¨ÜÔ∏è</span>
        Upload Marks
      </a>
    </div>

  <!-- Modal for Generate Marksheets -->
  <div id="marksheet-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-lg">
        <h2 class="text-2xl font-bold text-gray-900">Generate Marksheet Template</h2>
        <button id="close-marksheet-modal" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="px-6 py-6">
      <form id="marksheet-form" method="post" action="{% url 'generate_marksheet' %}">
        {% csrf_token %}
        <div id="marksheet-msg" class="mb-2 text-sm text-red-600"></div>
        <div id="marksheet-download-link" class="mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label class="block font-medium mb-1">Assessment Series <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <select name="assessment_month" id="assessment-month" required class="border px-3 py-2 rounded w-full">
                <option value="">Month</option>
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
              </select>
              <select name="assessment_year" id="assessment-year" required class="border px-3 py-2 rounded w-full">
                <!-- Years will be populated by JS -->
              </select>
            </div>
          </div>
          <div>
            <label class="block font-medium mb-1">Registration Category <span class="text-red-500">*</span></label>
            <select name="registration_category" id="reg-category-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <option value="modular">Modular</option>
              <option value="formal">Formal</option>
              <option value="workers_pas">Worker's PAS</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Occupation <span class="text-red-500">*</span></label>
            <select name="occupation" id="occupation-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="level-field" class="hidden">
            <label class="block font-medium mb-1">Level <span class="text-red-500">*</span></label>
            <select name="level" id="level-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="modules-field" class="hidden col-span-full">
            <label class="block font-medium mb-3 text-lg">Select Module <span class="text-red-500">*</span></label>
            <div class="bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300">
              <div class="mb-3">
                <input type="text" id="module-search" placeholder="Search modules..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg bg-white">
                <div id="modules-checkbox-container" class="p-3">
                  <!-- Module checkboxes will be populated dynamically -->
                </div>
              </div>
              <div class="mt-3 flex gap-2">
                <button type="button" id="select-all-modules" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Select All</button>
                <button type="button" id="clear-all-modules" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Clear All</button>
                <span id="selected-modules-count" class="px-3 py-1 text-sm text-gray-600">0 selected</span>
              </div>
            </div>
            <select name="modules" id="modules-select" multiple class="hidden">
              <!-- Hidden select for form submission -->
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Assessment Center (optional)</label>
            <select name="assessment_center" id="center-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Centers --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <!-- Branch selector: only for Generate Marksheet -->
          <div id="branch-field" class="hidden">
            <label class="block font-medium mb-1">Branch (optional)</label>
            <select name="assessment_center_branch" id="branch-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Branches --</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end gap-4 rounded-b-lg">
        <button type="button" id="cancel-marksheet-modal" class="bg-gray-200 hover:bg-gray-300 px-6 py-3 rounded-lg font-medium transition-colors">Cancel</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors">Generate Marksheet</button>
      </div>
      </form>
    </div>
  </div>

  <!-- Modal for Print Marksheet -->
  <div id="print-marksheet-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-lg">
        <h2 class="text-2xl font-bold text-gray-900">Print Marksheet</h2>
        <button id="close-print-marksheet-modal" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="px-6 py-6">
      <form id="print-marksheet-form" method="post" action="{% url 'print_marksheet' %}">
        {% csrf_token %}
        <div id="print-marksheet-msg" class="mb-2 text-sm text-red-600"></div>
        <div id="print-marksheet-download-link" class="mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label class="block font-medium mb-1">Assessment Series <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <select name="assessment_month" id="print-assessment-month" required class="border px-3 py-2 rounded w-full">
                <option value="">Month</option>
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
              </select>
              <select name="assessment_year" id="print-assessment-year" required class="border px-3 py-2 rounded w-full">
                <!-- Years will be populated by JS -->
              </select>
            </div>
          </div>
          <div>
            <label class="block font-medium mb-1">Registration Category <span class="text-red-500">*</span></label>
            <select name="registration_category" id="print-reg-category-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <option value="modular">Modular</option>
              <option value="formal">Formal</option>
              <option value="workers_pas">Worker's PAS</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Occupation <span class="text-red-500">*</span></label>
            <select name="occupation" id="print-occupation-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="print-level-field" class="hidden">
            <label class="block font-medium mb-1">Level <span class="text-red-500">*</span></label>
            <select name="level" id="print-level-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="print-modules-field" class="hidden col-span-full">
            <label class="block font-medium mb-3 text-lg">Select Module <span class="text-red-500">*</span></label>
            <div class="bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300">
              <div class="mb-3">
                <input type="text" id="print-module-search" placeholder="Search modules..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
              </div>
              <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg bg-white">
                <div id="print-modules-checkbox-container" class="p-3">
                  <!-- Module checkboxes will be populated dynamically -->
                </div>
              </div>
              <div class="mt-3 flex gap-2">
                <button type="button" id="print-select-all-modules" class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded hover:bg-purple-200">Select All</button>
                <button type="button" id="print-clear-all-modules" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Clear All</button>
                <span id="print-selected-modules-count" class="px-3 py-1 text-sm text-gray-600">0 selected</span>
              </div>
            </div>
            <select name="modules" id="print-modules-select" multiple class="hidden">
              <!-- Hidden select for form submission -->
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Assessment Center (optional)</label>
            <select name="assessment_center" id="print-center-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Centers --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end gap-4 rounded-b-lg">
        <button type="button" id="cancel-print-marksheet-modal" class="bg-gray-200 hover:bg-gray-300 px-6 py-3 rounded-lg font-medium transition-colors">Cancel</button>
        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-medium transition-colors">Print Marksheet</button>
      </div>
      </form>
    </div>
  </div>

  <!-- Modal for Upload Marks -->
  <div id="upload-marks-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-lg">
        <h2 class="text-2xl font-bold text-gray-900">Upload Marks (Bulk)</h2>
        <button id="close-upload-marks-modal" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="px-6 py-6">
      <form id="upload-marks-form" method="post" enctype="multipart/form-data" action="{% url 'upload_marks' %}">
        {% csrf_token %}
        <div id="upload-marks-msg" class="mb-2 text-sm text-red-600"></div>
        <div id="upload-marks-success" class="mb-2 text-sm text-green-600"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label class="block font-medium mb-1">Assessment Series <span class="text-red-500">*</span></label>
            <select name="assessment_series" id="upload-assessment-series" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select Assessment Series --</option>
              <!-- Options will be populated dynamically -->
            </select>
            <div class="mt-1 text-sm text-blue-600" id="upload-series-info"></div>
          </div>
          <div>
            <label class="block font-medium mb-1">Registration Category <span class="text-red-500">*</span></label>
            <select name="registration_category" id="upload-reg-category-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <option value="modular">Modular</option>
              <option value="formal">Formal</option>
              <option value="workers_pas">Worker's PAS</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Occupation <span class="text-red-500">*</span></label>
            <select name="occupation" id="upload-occupation-select" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="upload-level-field" class="hidden">
            <label class="block font-medium mb-1">Level <span class="text-red-500">*</span></label>
            <select name="level" id="upload-level-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- Select --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="upload-modules-field" class="hidden col-span-full">
            <label class="block font-medium mb-3 text-lg">Select Module <span class="text-red-500">*</span></label>
            <div class="bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300">
              <div class="mb-3">
                <input type="text" id="upload-module-search" placeholder="Search modules..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg bg-white">
                <div id="upload-modules-checkbox-container" class="p-3">
                  <!-- Module checkboxes will be populated dynamically -->
                </div>
              </div>
              <div class="mt-3 flex gap-2">
                <button type="button" id="upload-select-all-modules" class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">Select All</button>
                <button type="button" id="upload-clear-all-modules" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Clear All</button>
                <span id="upload-selected-modules-count" class="px-3 py-1 text-sm text-gray-600">0 selected</span>
              </div>
            </div>
            <select name="modules" id="upload-modules-select" multiple class="hidden">
              <!-- Hidden select for form submission -->
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Assessment Center (optional)</label>
            <select name="assessment_center" id="upload-center-select" class="border px-3 py-2 rounded w-full">
              <option value="">-- All Centers --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div class="col-span-2">
            <label class="block font-medium mb-1">Excel File <span class="text-red-500">*</span></label>
            <input type="file" name="marks_file" id="marks-file-input" accept=".xlsx,.xls" required class="border px-3 py-2 rounded w-full" />
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end gap-4 rounded-b-lg">
        <button type="button" id="cancel-upload-marks-modal" class="bg-gray-200 hover:bg-gray-300 px-6 py-3 rounded-lg font-medium transition-colors">Cancel</button>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors">Upload Marks</button>
      </div>
      </form>
    </div>
  </div>

    <!-- Enrolled Candidates Table -->
    <div class="bg-white rounded-lg shadow-md border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Enrolled Candidates</h2>
        
        <!-- Filter Form -->
        <form method="get" class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <input type="text" name="reg_number" value="{{ filters.reg_number }}" 
                   placeholder="Reg Number" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <input type="text" name="name" value="{{ filters.name }}" 
                   placeholder="Name" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <select name="registration_category" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">All Categories</option>
              {% for value, label in reg_categories %}
                <option value="{{ value }}" {% if filters.registration_category == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
              Filter
            </button>
            <a href="{% url 'results_home' %}" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
              Reset
            </a>
          </div>
        </form>
      </div>
      
      <!-- Count and Pagination Info -->
      <div class="px-6 py-2 bg-gray-50 text-sm text-gray-600 flex justify-between items-center">
        <span>
          {{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ paginator.count }}
        </span>
        <span>
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="inline-block px-2">&#60;</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="inline-block px-2">&#62;</a>
          {% endif %}
        </span>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reg Number</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registration Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Occupation</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Status</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for item in candidates_with_status %}
            <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location.href='{% url 'candidate_view' item.candidate.id %}?from=results'">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                {{ item.candidate.reg_number }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ item.candidate.full_name }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ item.candidate.get_registration_category_display }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ item.candidate.occupation.name|default:"N/A" }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                {% if item.upload_status == 'Uploaded' %}
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    Uploaded
                  </span>
                {% else %}
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                    Not Uploaded
                  </span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                No enrolled candidates found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      // --- CACHED DATA ---
      let allOccupations = [];
      let allLevels = [];
      let allCenters = [];
      let dataFetched = false;

      // --- ASYNC DATA FETCHER ---
      async function fetchDataIfNeeded() {
          if (dataFetched) return;
          try {
              const [occResponse, lvlResponse, centerResponse] = await Promise.all([
                  fetch('/eims/api/occupations/'),
                  fetch('/eims/api/levels/'),
                  fetch('/eims/api/centers/')
              ]);
              if (occResponse.ok) allOccupations = await occResponse.json();
              if (lvlResponse.ok) allLevels = await lvlResponse.json();
              if (centerResponse.ok) allCenters = await centerResponse.json();
              dataFetched = true;
          } catch (error) {
              console.error('Failed to fetch initial data:', error);
          }
      }

      // --- UI HELPER FUNCTIONS ---
      function populateYearDropdown(selectElement) {
          selectElement.innerHTML = '';
          const now = new Date();
          const currentYear = now.getFullYear();
          for (let y = currentYear - 5; y <= currentYear + 5; y++) {
              const opt = document.createElement('option');
              opt.value = y;
              opt.text = y;
              if (y === currentYear) opt.selected = true;
              selectElement.appendChild(opt);
          }
      }

      // --- Generate-only: load branches for selected center ---
      async function loadGenerateBranches(centerId) {
        const branchField = document.getElementById('branch-field');
        const branchSelect = document.getElementById('branch-select');
        if (!branchField || !branchSelect) return;
        branchSelect.innerHTML = '<option value="">-- All Branches --</option>';
        branchField.classList.add('hidden');
        if (!centerId) return;
        try {
          console.debug('[Generate] Loading branches for center', centerId);
          let resp = await fetch(`/eims/api/center-branches/?center_id=${encodeURIComponent(centerId)}`);
          let data = null;
          if (!resp.ok) {
            // fallback JSON endpoint
            resp = await fetch(`/eims/api/assessment-centers/${encodeURIComponent(centerId)}/branches/`);
          }
          if (resp.ok) {
            data = await resp.json();
          }
          if (data && data.has_branches) {
            // Add explicit "Main Center" option so user can target candidates registered under the head center
            const centerSelectEl = document.getElementById('center-select');
            if (centerSelectEl && centerSelectEl.value === String(centerId)) {
              const centerName = centerSelectEl.options[centerSelectEl.selectedIndex]?.text || 'Main Center';
              const mainOpt = document.createElement('option');
              mainOpt.value = 'main';
              mainOpt.textContent = `${centerName} (Main Center)`;
              branchSelect.appendChild(mainOpt);
            }
            if (Array.isArray(data.branches) && data.branches.length) {
              data.branches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.branch_code;
                branchSelect.appendChild(opt);
              });
            }
            branchField.classList.remove('hidden');
          } else {
            console.debug('[Generate] Center has no branches or API returned none');
          }
        } catch (err) {
          console.warn('Could not load branches for center', centerId, err);
        }
      }

      function populateCentersDropdown(selectElement) {
          selectElement.innerHTML = '<option value="">-- All Centers --</option>';
          allCenters.forEach(c => {
              selectElement.innerHTML += `<option value="${c.id}">${c.name}</option>`;
          });
      }

      async function populateAssessmentSeriesDropdown(selectElement) {
          try {
              const response = await fetch('/eims/api/assessment-series/');
              const data = await response.json();
              selectElement.innerHTML = '<option value="">-- Select Assessment Series --</option>';
              const list = (data && Array.isArray(data.assessment_series)) ? data.assessment_series : [];
              if (list.length === 0) {
                  const opt = document.createElement('option');
                  opt.value = '';
                  opt.textContent = 'No assessment series found';
                  selectElement.appendChild(opt);
                  return;
              }
              list.forEach(series => {
                  const option = document.createElement('option');
                  option.value = series.id;
                  option.textContent = series.name + (series.is_current ? ' (Current)' : '');
                  option.dataset.startDate = series.start_date || '';
                  option.dataset.endDate = series.end_date || '';
                  option.dataset.isCurrent = series.is_current ? 'true' : 'false';
                  if (series.is_current) option.selected = true;
                  selectElement.appendChild(option);
              });
              // Update info text when selection changes
              selectElement.addEventListener('change', function() {
                  const selectedOption = this.options[this.selectedIndex];
                  const infoDiv = document.getElementById('upload-series-info');
                  if (selectedOption && selectedOption.value && infoDiv) {
                      const start = selectedOption.dataset.startDate ? new Date(selectedOption.dataset.startDate).toLocaleDateString() : '';
                      const end = selectedOption.dataset.endDate ? new Date(selectedOption.dataset.endDate).toLocaleDateString() : '';
                      const isCurrent = selectedOption.dataset.isCurrent === 'true';
                      infoDiv.innerHTML = `
                          <span class="text-sm">
                              ${start}${start && end ? ' - ' : ''}${end}
                              ${isCurrent ? '<span class="ml-2 px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Current</span>' : ''}
                          </span>
                      `;
                  } else if (infoDiv) {
                      infoDiv.innerHTML = '';
                  }
              });
          } catch (error) {
              console.error('Error loading assessment series:', error);
              selectElement.innerHTML = '<option value="">Error loading series</option>';
          }
      }

      // --- CORE MODAL LOGIC ---
      function setupModal(config) {
          const openBtn = document.getElementById(config.openBtnId);
          const modal = document.getElementById(config.modalId);
          const closeBtn = document.getElementById(config.closeBtnId);
          const cancelBtn = document.getElementById(config.cancelBtnId);
          const form = document.getElementById(config.formId);
          const regCategorySelect = document.getElementById(config.regCategorySelectId);
          const occupationSelect = document.getElementById(config.occupationSelectId);
          const levelField = document.getElementById(config.levelFieldId);
          const levelSelect = document.getElementById(config.levelSelectId);
          const modulesField = document.getElementById(config.modulesFieldId);
          const modulesSelect = document.getElementById(config.modulesSelectId);
          const yearSelect = document.getElementById(config.yearSelectId);
          const centerSelect = document.getElementById(config.centerSelectId);
          const msgDiv = document.getElementById(config.msgId);
          const linkDiv = document.getElementById(config.linkId);
          // For Generate modal: prepare a hidden input to ensure branch is posted
          let branchHiddenInput = null;
          if (config.modalId === 'marksheet-modal') {
            branchHiddenInput = document.createElement('input');
            branchHiddenInput.type = 'hidden';
            branchHiddenInput.name = 'assessment_center_branch';
            branchHiddenInput.id = 'branch-hidden-input';
            form.appendChild(branchHiddenInput);
          }

          // Attach event listeners
          openBtn.addEventListener('click', async () => {
              await fetchDataIfNeeded();
              populateYearDropdown(yearSelect);
              populateCentersDropdown(centerSelect);
              updateOccupationOptions();
              // For Generate modal: reset and preload branches if a center is already selected
              if (config.modalId === 'marksheet-modal') {
                const branchField = document.getElementById('branch-field');
                const branchSelect = document.getElementById('branch-select');
                if (branchField && branchSelect) {
                  branchField.classList.add('hidden');
                  branchSelect.innerHTML = '<option value="">-- All Branches --</option>';
                  if (centerSelect && centerSelect.value) {
                    try { await loadGenerateBranches(centerSelect.value); } catch (e) { console.warn('Branch preload failed', e); }
                  }
                  // Reset hidden on open
                  if (branchHiddenInput) branchHiddenInput.value = '';
                }
              }
              modal.classList.remove('hidden');
          });

          closeBtn.onclick = cancelBtn.onclick = () => modal.classList.add('hidden');
          window.addEventListener('click', (e) => {
              if (e.target === modal) modal.classList.add('hidden');
          });

          regCategorySelect.onchange = updateOccupationOptions;
          occupationSelect.onchange = updateLevelAndModuleOptions;
        // For Generate modal only: attach branch loader on center change
        if (config.modalId === 'marksheet-modal') {
          centerSelect.addEventListener('change', async function() {
            const centerId = this.value;
            await loadGenerateBranches(centerId);
            // Clear hidden when center changes; user must explicitly pick a branch
            if (branchHiddenInput) branchHiddenInput.value = '';
          });
        }

          function updateOccupationOptions() {
              const regcat = regCategorySelect.value;
              occupationSelect.innerHTML = '<option value="">-- Select --</option>';
              let filtered = allOccupations;

              if (regcat === 'formal') {
                  filtered = allOccupations.filter(o => o.category === 'formal');
              } else if (regcat === 'workers_pas') {
                  filtered = allOccupations.filter(o => o.category === 'informal');
              } else if (regcat === 'modular') {
                  filtered = allOccupations.filter(o => o.category === 'formal' && o.has_modular);
              }

              filtered.forEach(o => {
                  occupationSelect.innerHTML += `<option value="${o.id}">${o.name}</option>`;
              });
              updateLevelAndModuleOptions();
          }

          function updateLevelAndModuleOptions() {
              const regcat = regCategorySelect.value;
              const occId = parseInt(occupationSelect.value, 10);
              levelSelect.innerHTML = '<option value="">-- Select --</option>';
              modulesSelect.innerHTML = '';

              // Handle modules for 'Modular' category
              if (regcat === 'modular' && occId) {
                  modulesField.classList.remove('hidden');
                  levelField.classList.add('hidden');
                  fetch(`/eims/api/modules/?occupation_id=${occId}`)
                      .then(res => res.json())
                      .then(data => {
                          const modulesArray = Array.isArray(data) ? data : (data.modules || []);
                          setupModuleCheckboxes(modulesArray, config.modalId);
                      }).catch(err => console.error('Failed to fetch modules:', err));
              } else {
                  modulesField.classList.add('hidden');
              }

              // Handle levels for other categories
              if ((regcat === 'formal' || regcat === 'workers_pas') && occId) {
                  levelField.classList.remove('hidden');
                  const occLevels = allLevels.filter(lvl => lvl.occupation_id === occId);
                  occLevels.forEach(lvl => {
                      levelSelect.innerHTML += `<option value="${lvl.id}">${lvl.name}</option>`;
                  });
              } else if (regcat !== 'modular') {
                  levelField.classList.add('hidden');
              }
          }

          form.onsubmit = async function(e) {
              e.preventDefault();
              // Ensure branch value is present BEFORE creating FormData
              if (config.modalId === 'marksheet-modal') {
                  const branchSelectEl = document.getElementById('branch-select');
                  if (branchHiddenInput && branchSelectEl) {
                      branchHiddenInput.value = branchSelectEl.value || '';
                  }
              }
              const formData = new FormData(form);
              msgDiv.textContent = '';
              if(linkDiv) linkDiv.innerHTML = '';

              try {
                  const response = await fetch(form.action, {
                      method: 'POST',
                      body: formData,
                      headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
                  });
                  const data = await response.json();
                  if (data.success) {
                      if(linkDiv) linkDiv.innerHTML = `<a href="${data.download_url}" class="text-blue-600 font-bold hover:underline" target="_blank">${config.linkText}</a>`;
                  } else {
                      msgDiv.textContent = data.error || 'An unknown error occurred.';
                  }
              } catch (error) {
                  console.error('Error submitting form:', error);
                  msgDiv.textContent = 'A network error occurred. Please try again.';
              }
          };

          // (no-op) additional submit listener removed; handled inside onsubmit above
      }

      // --- ENHANCED MODULE SELECTION FUNCTIONS ---
      function setupModuleCheckboxes(modules, modalPrefix) {
          // Determine if this is a modular operation (single-select with radio buttons)
          const regCategorySelectId = modalPrefix === 'marksheet-modal' ? 'reg-category-select' : 
                                     modalPrefix === 'print-marksheet-modal' ? 'print-reg-category-select' : 
                                     'upload-reg-category-select';
          const regCategorySelect = document.getElementById(regCategorySelectId);
          const isModular = regCategorySelect && regCategorySelect.value === 'modular';
          
          const containerId = modalPrefix === 'marksheet-modal' ? 'modules-checkbox-container' : 
                             modalPrefix === 'print-marksheet-modal' ? 'print-modules-checkbox-container' : 
                             'upload-modules-checkbox-container';
          const searchId = modalPrefix === 'marksheet-modal' ? 'module-search' : 
                          modalPrefix === 'print-marksheet-modal' ? 'print-module-search' : 
                          'upload-module-search';
          const selectAllId = modalPrefix === 'marksheet-modal' ? 'select-all-modules' : 
                             modalPrefix === 'print-marksheet-modal' ? 'print-select-all-modules' : 
                             'upload-select-all-modules';
          const clearAllId = modalPrefix === 'marksheet-modal' ? 'clear-all-modules' : 
                            modalPrefix === 'print-marksheet-modal' ? 'print-clear-all-modules' : 
                            'upload-clear-all-modules';
          const countId = modalPrefix === 'marksheet-modal' ? 'selected-modules-count' : 
                         modalPrefix === 'print-marksheet-modal' ? 'print-selected-modules-count' : 
                         'upload-selected-modules-count';
          const hiddenSelectId = modalPrefix === 'marksheet-modal' ? 'modules-select' : 
                                 modalPrefix === 'print-marksheet-modal' ? 'print-modules-select' : 
                                 'upload-modules-select';

          const container = document.getElementById(containerId);
          const searchInput = document.getElementById(searchId);
          const selectAllBtn = document.getElementById(selectAllId);
          const clearAllBtn = document.getElementById(clearAllId);
          const countSpan = document.getElementById(countId);
          const hiddenSelect = document.getElementById(hiddenSelectId);

          if (!container) return;

          // Clear existing content
          container.innerHTML = '';
          hiddenSelect.innerHTML = '';

          // Create module inputs (radio buttons for modular, checkboxes for others)
          const inputType = isModular ? 'radio' : 'checkbox';
          const inputName = isModular ? `modules-${modalPrefix}` : '';
          const inputClass = isModular ? 'module-radio' : 'module-checkbox';
          
          modules.forEach(module => {
              const inputDiv = document.createElement('div');
              inputDiv.className = 'flex items-center space-x-3 py-2 px-3 hover:bg-gray-50 rounded module-item';
              inputDiv.innerHTML = `
                  <input type="${inputType}" 
                         id="module-${module.id}-${modalPrefix}" 
                         name="${inputName}"
                         value="${module.id}" 
                         class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 ${isModular ? 'rounded-full' : 'rounded'} ${inputClass}">
                  <label for="module-${module.id}-${modalPrefix}" 
                         class="flex-1 text-sm text-gray-700 cursor-pointer">
                      ${module.name}
                  </label>
              `;
              container.appendChild(inputDiv);

              // Add to hidden select for form submission
              const option = document.createElement('option');
              option.value = module.id;
              option.textContent = module.name;
              hiddenSelect.appendChild(option);
          });

          // Search functionality
          if (searchInput) {
              searchInput.addEventListener('input', function() {
                  const searchTerm = this.value.toLowerCase();
                  const moduleItems = container.querySelectorAll('.module-item');
                  moduleItems.forEach(item => {
                      const label = item.querySelector('label').textContent.toLowerCase();
                      item.style.display = label.includes(searchTerm) ? 'flex' : 'none';
                  });
              });
          }

          // Select all functionality (only for non-modular operations)
          if (selectAllBtn) {
              if (isModular) {
                  selectAllBtn.style.display = 'none'; // Hide for radio buttons
              } else {
                  selectAllBtn.style.display = 'inline-block';
                  selectAllBtn.addEventListener('click', function() {
                      const checkboxes = container.querySelectorAll('.module-checkbox');
                      const visibleCheckboxes = Array.from(checkboxes).filter(cb => 
                          cb.closest('.module-item').style.display !== 'none'
                      );
                      visibleCheckboxes.forEach(cb => cb.checked = true);
                      updateSelectedCount();
                      updateHiddenSelect();
                  });
              }
          }

          // Clear all functionality
          if (clearAllBtn) {
              clearAllBtn.addEventListener('click', function() {
                  const inputs = container.querySelectorAll(isModular ? '.module-radio' : '.module-checkbox');
                  inputs.forEach(input => input.checked = false);
                  updateSelectedCount();
                  updateHiddenSelect();
              });
          }

          // Update count and hidden select when inputs change
          function updateSelectedCount() {
              const checkedInputs = container.querySelectorAll(isModular ? '.module-radio:checked' : '.module-checkbox:checked');
              if (countSpan) {
                  if (isModular) {
                      countSpan.textContent = checkedInputs.length > 0 ? '1 selected' : '0 selected';
                  } else {
                      countSpan.textContent = `${checkedInputs.length} selected`;
                  }
              }
          }

          function updateHiddenSelect() {
              const checkedInputs = container.querySelectorAll(isModular ? '.module-radio:checked' : '.module-checkbox:checked');
              const hiddenOptions = hiddenSelect.querySelectorAll('option');
              hiddenOptions.forEach(option => option.selected = false);
              
              checkedInputs.forEach(input => {
                  const option = hiddenSelect.querySelector(`option[value="${input.value}"]`);
                  if (option) option.selected = true;
              });
          }

          // Add event listeners to all inputs
          container.addEventListener('change', function(e) {
              if (e.target.classList.contains('module-checkbox') || e.target.classList.contains('module-radio')) {
                  updateSelectedCount();
                  updateHiddenSelect();
              }
          });

          // Initialize count
          updateSelectedCount();
      }

      // --- INITIALIZE ALL MODALS ---
      setupModal({
          openBtnId: 'generate-marksheet-btn',
          modalId: 'marksheet-modal',
          closeBtnId: 'close-marksheet-modal',
          cancelBtnId: 'cancel-marksheet-modal',
          formId: 'marksheet-form',
          regCategorySelectId: 'reg-category-select',
          occupationSelectId: 'occupation-select',
          levelFieldId: 'level-field',
          levelSelectId: 'level-select',
          modulesFieldId: 'modules-field',
          modulesSelectId: 'modules-select',
          yearSelectId: 'assessment-year',
          centerSelectId: 'center-select',
          msgId: 'marksheet-msg',
          linkId: 'marksheet-download-link',
          linkText: 'Download Marksheet'
      });

      setupModal({
          openBtnId: 'print-marksheet-btn',
          modalId: 'print-marksheet-modal',
          closeBtnId: 'close-print-marksheet-modal',
          cancelBtnId: 'cancel-print-marksheet-modal',
          formId: 'print-marksheet-form',
          regCategorySelectId: 'print-reg-category-select',
          occupationSelectId: 'print-occupation-select',
          levelFieldId: 'print-level-field',
          levelSelectId: 'print-level-select',
          modulesFieldId: 'print-modules-field',
          modulesSelectId: 'print-modules-select',
          yearSelectId: 'print-assessment-year',
          centerSelectId: 'print-center-select',
          msgId: 'print-marksheet-msg',
          linkId: 'print-marksheet-download-link',
          linkText: 'Download Printable Marksheet'
      });
      
      // --- UPLOAD MARKS MODAL LOGIC ---
      const uploadBtn = document.getElementById('upload-marks-btn');
      const uploadModal = document.getElementById('upload-marks-modal');
      const closeUploadBtn = document.getElementById('close-upload-marks-modal');
      const cancelUploadBtn = document.getElementById('cancel-upload-marks-modal');
      const uploadForm = document.getElementById('upload-marks-form');
      const uploadRegCategorySelect = document.getElementById('upload-reg-category-select');
      const uploadOccupationSelect = document.getElementById('upload-occupation-select');

      if (uploadBtn) {
          uploadBtn.onclick = async (e) => {
              e.preventDefault();
              await fetchDataIfNeeded();
              await populateAssessmentSeriesDropdown(document.getElementById('upload-assessment-series'));
              populateCentersDropdown(document.getElementById('upload-center-select'));
              uploadUpdateOccupationOptions();
              uploadModal.classList.remove('hidden');
          };
      }

      if(closeUploadBtn) closeUploadBtn.onclick = () => uploadModal.classList.add('hidden');
      if(cancelUploadBtn) cancelUploadBtn.onclick = () => uploadModal.classList.add('hidden');
      window.addEventListener('click', (e) => {
          if (e.target === uploadModal) uploadModal.classList.add('hidden');
      });

      function uploadUpdateOccupationOptions() {
          const regcat = uploadRegCategorySelect.value;
          uploadOccupationSelect.innerHTML = '<option value="">-- Select --</option>';
          let filtered = allOccupations;
          if (regcat === 'formal') {
              filtered = allOccupations.filter(o => o.category === 'formal');
          } else if (regcat === 'workers_pas') {
              filtered = allOccupations.filter(o => o.category === 'informal');
          } else if (regcat === 'modular') {
              filtered = allOccupations.filter(o => o.category === 'formal' && o.has_modular);
          }
          filtered.forEach(o => {
              uploadOccupationSelect.innerHTML += `<option value="${o.id}">${o.name}</option>`;
          });
          uploadUpdateLevelAndModuleOptions();
      }

      function uploadUpdateLevelAndModuleOptions() {
          const regcat = uploadRegCategorySelect.value;
          const occId = parseInt(uploadOccupationSelect.value, 10);
          const levelField = document.getElementById('upload-level-field');
          const levelSelect = document.getElementById('upload-level-select');
          levelSelect.innerHTML = '<option value="">-- Select --</option>';
          const modulesField = document.getElementById('upload-modules-field');
          const modulesSelect = document.getElementById('upload-modules-select');
          modulesSelect.innerHTML = '';

          if (regcat === 'modular' && occId) {
              modulesField.classList.remove('hidden');
              levelField.classList.add('hidden');
              fetch(`/eims/api/modules/?occupation_id=${occId}`)
                  .then(res => res.json())
                  .then(data => {
                      const modulesArray = Array.isArray(data) ? data : (data.modules || []);
                      setupModuleCheckboxes(modulesArray, 'upload-marks-modal');
                  }).catch(err => console.error('Failed to fetch modules for upload:', err));
          } else {
              modulesField.classList.add('hidden');
          }

          if ((regcat === 'formal' || regcat === 'workers_pas') && occId) {
              levelField.classList.remove('hidden');
              const occupationLevels = allLevels.filter(lvl => lvl.occupation_id === occId);
              occupationLevels.forEach(lvl => {
                  levelSelect.innerHTML += `<option value="${lvl.id}">${lvl.name}</option>`;
              });
          } else if (regcat !== 'modular') {
              levelField.classList.add('hidden');
          }
      }

      if(uploadRegCategorySelect) uploadRegCategorySelect.onchange = uploadUpdateOccupationOptions;
      if(uploadOccupationSelect) uploadOccupationSelect.onchange = uploadUpdateLevelAndModuleOptions;

      if(uploadForm) {
          uploadForm.addEventListener('submit', async function(e) {
              e.preventDefault();
              const formData = new FormData(uploadForm);
              const msgDiv = document.getElementById('upload-marks-msg');
              const successDiv = document.getElementById('upload-marks-success');
              msgDiv.textContent = '';
              successDiv.textContent = '';

              try {
                  const response = await fetch(uploadForm.action, {
                      method: 'POST',
                      body: formData,
                      headers: {
                          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                      },
                  });

                  const data = await response.json();

                  if (data.success) {
                      successDiv.textContent = `Successfully uploaded marks for ${data.updated_count} records.`;
                      uploadForm.reset();
                  }

                  if (data.errors && data.errors.length > 0) {
                      msgDiv.innerHTML = '<strong>Upload failed with the following errors:</strong><br>' + data.errors.join('<br>');
                  } else if (!data.success) {
                      msgDiv.textContent = data.error || 'An unknown error occurred.';
                  }
              } catch (error) {
                  console.error('Error uploading marks:', error);
                  msgDiv.textContent = 'A network error occurred. Please try again.';
              }
          });
      }

  });
  </script>
  <script src="/static/js/results_marksheet_modules.js"></script>
  {% endblock %}
