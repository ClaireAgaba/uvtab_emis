{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto mt-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Candidates</h1>
    <a href="{% url 'candidate_create' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Create Candidate</a>
  </div>

  <!-- Bulk Action Bar (hidden by default) -->
  <div id="bulk-action-bar" class="hidden mb-4 bg-gray-50 border border-blue-200 rounded-lg px-4 py-2 flex items-center gap-4">
    <span class="font-semibold text-gray-700">Bulk Actions:</span>
    <select id="bulk-action-select" class="border px-2 py-1 rounded">
      <option value="">Select Action</option>
      <option value="enroll">Enroll</option>
      <option value="regenerate">Regenerate Reg. Number</option>
    </select>
    <!-- Module selector for Modular bulk enroll -->
    <div id="bulk-module-checkboxes" class="hidden" style="min-width:240px; min-height:120px; max-height:240px; overflow-y:auto; border:1px solid #ccc; border-radius:6px; padding:8px 12px; background:#fff"></div>
    <button id="bulk-action-apply" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">Apply</button>
    <span id="bulk-action-error" class="text-red-600 text-sm ml-4"></span>
  </div>

  <!-- Candidate Table -->
  <div class="mb-2 text-sm text-gray-600 flex justify-between items-center">
  <span>
    {{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ paginator.count }}
  </span>
  <span>
    {% if page_obj.has_previous %}
      <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ page_obj.previous_page_number }}" class="inline-block px-2">&#60;</a>
    {% endif %}
    {% if page_obj.has_next %}
      <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ page_obj.next_page_number }}" class="inline-block px-2">&#62;</a>
    {% endif %}
  </span>
</div>

<div class="overflow-x-auto bg-white shadow rounded">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-2 py-2 text-center">
            <input type="checkbox" id="select-all" class="form-checkbox h-4 w-4">
          </th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">Image</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">Reg No</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Full Name</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Occupation</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Reg. Category</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Center</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Actions</th>
        </tr>
        <tr>
          <form method="get">
            <th></th> <!-- No filter for image -->
            <th class="px-2 py-1">
              <input type="text" name="reg_number" value="{{ request.GET.reg_number }}" placeholder="Search Reg No" class="border px-2 py-1 w-full" />
            </th>
            <th class="px-2 py-1">
              <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search Name" class="border px-2 py-1 w-full" />
            </th>
            <th class="px-2 py-1">
              <select name="occupation" class="border px-2 py-1 w-full">
                <option value="">All Occupations</option>
                {% for occupation in occupations %}
                  <option value="{{ occupation.id }}" {% if request.GET.occupation == occupation.id|stringformat:"s" %}selected{% endif %}>{{ occupation.name }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="px-2 py-1">
              <select name="registration_category" class="border px-2 py-1 w-full">
                <option value="">All Categories</option>
                <option value="formal" {% if request.GET.registration_category == 'formal' %}selected{% endif %}>Formal</option>
                <option value="modular" {% if request.GET.registration_category == 'modular' %}selected{% endif %}>Modular</option>
                <option value="informal" {% if request.GET.registration_category == 'informal' %}selected{% endif %}>Informal</option>
              </select>
            </th>
            <th class="px-2 py-1">
              <select name="assessment_center" class="border px-2 py-1 w-full">
                <option value="">All Centers</option>
                {% for center in centers %}
                  <option value="{{ center.id }}" {% if request.GET.assessment_center == center.id|stringformat:"s" %}selected{% endif %}>{{ center.center_name }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="px-2 py-1">
              <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded">Filter</button>
            </th>
          </form>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for candidate in candidates %}
        <tr>
          <td class="px-2 py-2 text-center">
            <input type="checkbox" class="candidate-checkbox form-checkbox h-4 w-4" value="{{ candidate.id }}">
          </td>
          <td class="px-4 py-2 whitespace-nowrap">
            {% if candidate.passport_photo %}
              <img src="{{ candidate.passport_photo.url }}" alt="Candidate Photo" class="h-12 w-12 object-cover rounded" />
            {% else %}
              <div class="h-12 w-12 bg-gray-200 rounded flex items-center justify-center text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
              </div>
            {% endif %}
          </td>
          <td class="px-4 py-2 whitespace-nowrap">{{ candidate.reg_number }}</td>
          <td class="px-4 py-2">{{ candidate.full_name }}</td>
          <td class="px-4 py-2">{{ candidate.occupation.name }}</td>
          <td class="px-4 py-2">{{ candidate.get_registration_category_display }}</td>
          <td class="px-4 py-2 whitespace-nowrap">
            {{ candidate.assessment_center.center_name|default:"â€”" }}
          </td>
          <td class="px-4 py-2">
            <a href="{% url 'candidate_view' candidate.id %}" class="text-blue-600 hover:underline">View</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-4 text-center text-gray-500">No candidates found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
// Bulk select logic
const selectAll = document.getElementById('select-all');
const checkboxes = document.querySelectorAll('.candidate-checkbox');
const bulkBar = document.getElementById('bulk-action-bar');
const bulkApply = document.getElementById('bulk-action-apply');
const bulkSelect = document.getElementById('bulk-action-select');
const bulkError = document.getElementById('bulk-action-error');

function updateBulkBar() {
  const checked = document.querySelectorAll('.candidate-checkbox:checked');
  if (checked.length > 0) {
    bulkBar.classList.remove('hidden');
  } else {
    bulkBar.classList.add('hidden');
    bulkError.textContent = '';
    bulkSelect.value = '';
  }
}

if (selectAll) {
  selectAll.addEventListener('change', function() {
    checkboxes.forEach(cb => { cb.checked = selectAll.checked; });
    updateBulkBar();
  });
}
checkboxes.forEach(cb => {
  cb.addEventListener('change', function() {
    if (!cb.checked) selectAll.checked = false;
    updateBulkBar();
  });
});

// --- Bulk Modular Module Selection Logic (with checkboxes) ---
const bulkModuleBox = document.getElementById('bulk-module-checkboxes');

function fetchModulesForCandidates(candidateIds, callback) {
  fetch('/eims/candidates/bulk-modules/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({candidate_ids: candidateIds})
  })
  .then(res => res.json())
  .then(data => callback(data))
  .catch(() => callback({success: false, error: 'Could not fetch modules.'}));
}

function updateBulkModuleSelector() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (bulkSelect.value === 'enroll' && checked.length > 0) {
    fetchModulesForCandidates(checked.map(cb => cb.value), function(data) {
      if (data.success && data.modules && data.modules.length > 0) {
        bulkModuleBox.innerHTML = '<div class="font-semibold mb-2 text-gray-800">Select Modules (max 2):</div>';
        data.modules.forEach(m => {
          const id = 'bulkmod_' + m.id;
          const wrapper = document.createElement('div');
          wrapper.className = 'flex items-center mb-1';
          wrapper.innerHTML = `<input type="checkbox" id="${id}" value="${m.id}" class="bulk-module-checkbox mr-2"> <label for="${id}" class="text-gray-700">${m.name}</label>`;
          bulkModuleBox.appendChild(wrapper);
        });
        bulkModuleBox.classList.remove('hidden');
        // Add logic to limit to 2 checked
        bulkModuleBox.querySelectorAll('.bulk-module-checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const selected = bulkModuleBox.querySelectorAll('.bulk-module-checkbox:checked');
            if (selected.length > 2) {
              this.checked = false;
              bulkError.textContent = 'You can select up to 2 modules.';
            } else {
              bulkError.textContent = '';
            }
          });
        });
      } else {
        bulkModuleBox.innerHTML = '';
        bulkModuleBox.classList.add('hidden');
      }
    });
  } else {
    bulkModuleBox.innerHTML = '';
    bulkModuleBox.classList.add('hidden');
  }
}

bulkSelect.addEventListener('change', updateBulkModuleSelector);
document.querySelectorAll('.candidate-checkbox').forEach(cb => {
  cb.addEventListener('change', updateBulkModuleSelector);
});

bulkApply && bulkApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (!bulkSelect.value) {
    bulkError.textContent = 'Please select an action.';
    return;
  }
  if (checked.length === 0) {
    bulkError.textContent = 'Please select at least one candidate.';
    return;
  }
  // For Modular enroll, require module selection via checkboxes
  let moduleIds = [];
  if (!bulkModuleBox.classList.contains('hidden') && bulkSelect.value === 'enroll') {
    moduleIds = Array.from(bulkModuleBox.querySelectorAll('.bulk-module-checkbox:checked')).map(cb => cb.value);
    if (moduleIds.length < 1 || moduleIds.length > 2) {
      bulkError.textContent = 'Select 1 or 2 modules.';
      return;
    }
  }
  // AJAX POST to backend
  bulkError.textContent = '';
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: bulkSelect.value,
      candidate_ids: checked.map(cb => cb.value),
      module_ids: moduleIds
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      bulkError.textContent = '';
      // Custom message: "Successfully enrolled X candidates in Y module(s)"
      let modCount = moduleIds.length;
      let candCount = checked.length;
      alert(`Successfully enrolled ${candCount} candidate${candCount > 1 ? 's' : ''} in ${modCount} module${modCount > 1 ? 's' : ''}.`);
      window.location.reload();
    } else {
      bulkError.textContent = data.error || 'An error occurred.';
    }
  })
  .catch(() => {
    bulkError.textContent = 'Server error.';
  });
});

// Helper to get CSRF token from cookie if not present in DOM
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}
