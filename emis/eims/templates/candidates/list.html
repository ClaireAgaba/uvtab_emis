{% extends 'base.html' %}

{% block content %}
<div class="w-full px-2 md:px-8 mt-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Candidates</h1>
    <div class="flex gap-2">
  <a href="{% url 'candidate_create' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Create Candidate</a>
  <a href="{% url 'candidate_import_dual' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 ml-2">Import Candidates & Photos</a>
</div>
  </div>

  <!-- Bulk Action Bar (hidden by default) -->
  <div id="bulk-action-bar" class="hidden mb-4 bg-gray-50 border border-blue-200 rounded-lg px-4 py-2 flex items-center gap-4">
    <span class="font-semibold text-gray-700">Bulk Actions:</span>
    <select id="bulk-action-select" class="border px-2 py-1 rounded">
      <option value="">Select Action</option>
      <option value="enroll">Enroll</option>
      <option value="regenerate">Regenerate Reg. Number</option>
      <option value="add_regno_photo">Add Regno on Photo</option>
      <option value="change_reg_cat">Change Reg Category</option>
      <option value="mark_disabled">Mark as Disabled</option>
    </select>
    <!-- Level selector for Formal/Informal bulk enroll -->
    <div id="bulk-level-select-wrapper" class="hidden" style="min-width:180px; margin-right:12px;">
      <label for="bulk-level-select" class="block text-xs font-semibold text-gray-700 mb-1">Select Level:</label>
      <select id="bulk-level-select" class="border px-2 py-1 rounded w-full"></select>
    </div>
    <!-- Module/Paper selector for Informal bulk enroll -->
    <div id="bulk-informal-modules-papers" class="hidden" style="min-width:240px; max-width:480px; max-height:320px; overflow-y:auto; border:1px solid #ccc; border-radius:6px; padding:8px 12px; background:#fff"></div>
    <!-- Module selector for Modular bulk enroll -->
    <div id="bulk-module-checkboxes" class="hidden" style="min-width:240px; min-height:120px; max-height:240px; overflow-y:auto; border:1px solid #ccc; border-radius:6px; padding:8px 12px; background:#fff"></div>
    <button id="bulk-action-apply" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">Apply</button>
    <span id="bulk-action-error" class="text-red-600 text-sm ml-4"></span>
  </div>

  <!-- Bulk Change Reg Category Modal -->
  <div id="bulk-change-regcat-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
      <h2 class="text-lg font-bold mb-4">Change Registration Category</h2>
      <label for="bulk-regcat-select" class="block mb-2 font-medium">Select New Registration Category</label>
      <select id="bulk-regcat-select" class="w-full border rounded px-3 py-2 mb-4" required>
        <option value="">-- Select Category --</option>
        <option value="Formal">Formal</option>
        <option value="Modular">Modular</option>
        <option value="Informal">Informal</option>
      </select>
      <div id="bulk-regcat-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-regcat-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-regcat-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Apply</button>
      </div>
      <button id="bulk-regcat-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>

  <!-- Bulk Mark as Disabled Modal -->
  <div id="bulk-mark-disabled-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
      <h2 class="text-lg font-bold mb-4">Mark as Disabled</h2>
      <div class="mb-4">
        <p class="mb-2 font-medium">Select Nature(s) of Disability <span class="text-red-600">*</span></p>
        <div id="bulk-nature-checkboxes" class="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto border rounded px-3 py-2">
          {% for nature in nature_of_disabilities %}
            <label class="flex items-center gap-2">
              <input type="checkbox" class="bulk-nature-checkbox" value="{{ nature.id }}">
              <span>{{ nature.name }}</span>
            </label>
          {% empty %}
            <span class="text-gray-500">No nature of disability options available.</span>
          {% endfor %}
        </div>
      </div>
      <div id="bulk-mark-disabled-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-mark-disabled-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-mark-disabled-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Apply</button>
      </div>
      <button id="bulk-mark-disabled-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>

  <!-- Candidate Table -->
  <div class="mb-2 text-sm text-gray-600 flex justify-between items-center">
  <span>
    {{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ paginator.count }}
  </span>
  <span>
    {% if page_obj.has_previous %}
      <a href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.previous_page_number }}" class="inline-block px-2">&#60;</a>
    {% endif %}
    {% if page_obj.has_next %}
      <a href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.next_page_number }}" class="inline-block px-2">&#62;</a>
    {% endif %}
  </span>
</div>

<div class="bg-white shadow rounded">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-2 py-2 text-center">
            <input type="checkbox" id="select-all" class="form-checkbox h-4 w-4">
          </th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">Image</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">Reg No</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Full Name</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Occupation</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Reg. Category</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Center</th>
          <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Actions</th>
        </tr>
        <tr>
          <form method="get">
            <th></th> <!-- Checkbox column, no filter -->
            <th></th> <!-- Image column, no filter -->
            <th class="px-4 py-1 whitespace-nowrap">
              <input type="text" name="reg_number" value="{{ filters.reg_number }}" placeholder="Search Reg No" class="border px-2 py-1 w-full" />
            </th>
            <th class="px-4 py-1 whitespace-nowrap">
              <input type="text" name="search" value="{{ filters.search }}" placeholder="Search Name" class="border px-2 py-1 w-full" />
            </th>
            <th class="px-4 py-1 whitespace-nowrap">
              <select name="occupation" class="border px-2 py-1 w-full">
                <option value="">All Occupations</option>
                {% for occupation in occupations %}
                  <option value="{{ occupation.id }}" {% if filters.occupation == occupation.id|stringformat:"s" %}selected{% endif %}>{{ occupation.name }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="px-4 py-1 whitespace-nowrap">
              <select name="registration_category" class="border px-2 py-1 w-full">
                <option value="">All Categories</option>
                <option value="Formal" {% if filters.registration_category == 'Formal' %}selected{% endif %}>Formal</option>
                <option value="Modular" {% if filters.registration_category == 'Modular' %}selected{% endif %}>Modular</option>
                <option value="Informal" {% if filters.registration_category == 'Informal' %}selected{% endif %}>Informal</option>
              </select>
            </th>
            <th class="px-4 py-1 whitespace-nowrap text-center">
              <select name="assessment_center" class="border px-2 py-1 w-full">
                <option value="">All Centers</option>
                {% for center in centers %}
                  <option value="{{ center.id }}" {% if filters.assessment_center == center.id|stringformat:"s" %}selected{% endif %}>{{center.center_number}} - {{ center.center_name }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="px-4 py-1 whitespace-nowrap text-center">
                <div class="flex gap-2">
                    <button type="submit" name="apply_filters" value="1" class="bg-blue-600 text-white px-4 py-1 rounded">Apply Filters</button>
                    <a href="?reset_filters=1" class="bg-gray-400 text-white px-4 py-1 rounded">Reset</a>
                </div>
            </th>
          </form>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for candidate in candidates %}
        <tr class="cursor-pointer hover:bg-blue-50 transition" onclick="window.location='{% url 'candidate_view' candidate.id %}'">
          <td class="px-2 py-2 text-center">
            <input type="checkbox" class="candidate-checkbox form-checkbox h-4 w-4" value="{{ candidate.id }}" onclick="event.stopPropagation();">
          </td>
          <td class="px-4 py-2 whitespace-nowrap">
            <div class="flex flex-col items-center w-32 mx-auto">
              {# Show regno-stamped photo if available, else fallback to original, else show No photo #}
              {% if candidate.passport_photo_with_regno %}
                <img src="{{ candidate.passport_photo_with_regno.url }}" alt="Candidate Photo with Regno" class="h-32 w-32 object-cover rounded" onclick="event.stopPropagation();" />
              {% elif candidate.passport_photo %}
                <img src="{{ candidate.passport_photo.url }}" alt="Candidate Photo" class="h-32 w-32 object-cover rounded" onclick="event.stopPropagation();" />
              {% else %}
                <div class="h-32 w-32 flex items-center justify-center bg-gray-100 text-gray-400 rounded border">No photo</div>
              {% endif %}
            </div>
          </td>
          <td class="px-4 py-2 whitespace-nowrap">{{ candidate.reg_number }}</td>
          <td class="px-4 py-2">{{ candidate.full_name }}</td>
          <td class="px-4 py-2">{{ candidate.occupation.name }}</td>
          <td class="px-4 py-2">{{ candidate.get_registration_category_display }}</td>
          <td class="px-4 py-2 whitespace-nowrap">
            {{ candidate.assessment_center.center_name|default:"â€”" }}
          </td>
          <td class="px-4 py-2">
            <a href="{% url 'candidate_view' candidate.id %}" class="text-blue-600 hover:underline" onclick="event.stopPropagation();">View</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-4 text-center text-gray-500">No candidates found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
// Bulk select logic
const selectAll = document.getElementById('select-all');
const checkboxes = document.querySelectorAll('.candidate-checkbox');
const bulkBar = document.getElementById('bulk-action-bar');
const bulkApply = document.getElementById('bulk-action-apply');
const bulkSelect = document.getElementById('bulk-action-select');
const bulkError = document.getElementById('bulk-action-error');

// Bulk Mark as Disabled modal logic
const bulkMarkDisabledModal = document.getElementById('bulk-mark-disabled-modal');
const bulkMarkDisabledApply = document.getElementById('bulk-mark-disabled-apply');
const bulkMarkDisabledCancel = document.getElementById('bulk-mark-disabled-cancel');
const bulkMarkDisabledClose = document.getElementById('bulk-mark-disabled-close');
const bulkMarkDisabledError = document.getElementById('bulk-mark-disabled-error');
const bulkNatureCheckboxes = document.getElementById('bulk-nature-checkboxes');

function showBulkMarkDisabledModal() {
  bulkMarkDisabledModal.classList.remove('hidden');
  bulkMarkDisabledError.classList.add('hidden');
  bulkMarkDisabledError.textContent = '';
  // Uncheck all natures
  bulkMarkDisabledModal.querySelectorAll('.bulk-nature-checkbox').forEach(cb => cb.checked = false);
}
function hideBulkMarkDisabledModal() {
  bulkMarkDisabledModal.classList.add('hidden');
}
// Open modal on select
bulkSelect.addEventListener('change', function() {
  if (bulkSelect.value === 'mark_disabled') {
    showBulkMarkDisabledModal();
    bulkSelect.value = '';
  }
});
bulkMarkDisabledCancel.addEventListener('click', hideBulkMarkDisabledModal);
bulkMarkDisabledClose.addEventListener('click', hideBulkMarkDisabledModal);

bulkMarkDisabledApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  const natureIds = Array.from(bulkNatureCheckboxes.querySelectorAll('.bulk-nature-checkbox:checked')).map(cb => cb.value);
  if (natureIds.length === 0) {
    bulkMarkDisabledError.textContent = 'Please select at least one nature of disability.';
    bulkMarkDisabledError.classList.remove('hidden');
    return;
  }
  if (checked.length === 0) {
    bulkMarkDisabledError.textContent = 'Please select at least one candidate.';
    bulkMarkDisabledError.classList.remove('hidden');
    return;
  }
  bulkMarkDisabledError.textContent = '';
  bulkMarkDisabledError.classList.add('hidden');
  // AJAX POST to backend
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'mark_disabled',
      candidate_ids: checked.map(cb => cb.value),
      nature_of_disability_ids: natureIds
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message || 'Candidates marked as disabled successfully.');
      window.location.reload();
    } else {
      bulkMarkDisabledError.textContent = data.error || 'An error occurred.';
      bulkMarkDisabledError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkMarkDisabledError.textContent = 'Server error.';
    bulkMarkDisabledError.classList.remove('hidden');
  });
});

function updateBulkBar() {
  const checked = document.querySelectorAll('.candidate-checkbox:checked');
  if (checked.length > 0) {
    bulkBar.classList.remove('hidden');
  } else {
    bulkBar.classList.add('hidden');
    bulkError.textContent = '';
    bulkSelect.value = '';
  }
}

if (selectAll) {
  selectAll.addEventListener('change', function() {
    checkboxes.forEach(cb => { cb.checked = selectAll.checked; });
    updateBulkBar();
  });
}
checkboxes.forEach(cb => {
  cb.addEventListener('change', function() {
    if (!cb.checked) selectAll.checked = false;
    updateBulkBar();
  });
});

// --- Bulk Modular Module Selection Logic (with checkboxes) ---
const bulkModuleBox = document.getElementById('bulk-module-checkboxes');
const bulkLevelWrapper = document.getElementById('bulk-level-select-wrapper');
const bulkLevelSelect = document.getElementById('bulk-level-select');
const bulkInformalBox = document.getElementById('bulk-informal-modules-papers');

// Helper: get regcat and occupation of selected candidates (assumes all same)
function getBulkRegcatAndOcc() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (!checked.length) return {};
  let row = checked[0].closest('tr');
  if (!row) return {};
  // Find columns by index: Reg. Category and Occupation
  const tds = row.querySelectorAll('td');
  let regcat = tds[5]?.textContent.trim();
  let occ = tds[4]?.textContent.trim();
  return {regcat, occ};
}

function fetchLevelsForOccupation(occupationName, cb) {
  // Find occupation id from filter dropdown
  const occSel = document.querySelector('select[name="occupation"]');
  let occId = occSel ? occSel.value : null;
  if (!occId) return cb([]);
  fetch(`/eims/api/levels-for-occupation/?occupation_id=${occId}`)
    .then(res => res.json())
    .then(data => cb(data.levels || []))
    .catch(() => cb([]));
}

function fetchModulesPapersForInformal(occupationId, levelId, cb) {
  // You will need to implement this endpoint on the backend
  fetch(`/eims/api/informal-modules-papers/?occupation_id=${occupationId}&level_id=${levelId}`)
    .then(res => res.json())
    .then(data => cb(data))
    .catch(() => cb({modules: []}));
}

function updateBulkSelectors() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (bulkSelect.value !== 'enroll' || checked.length === 0) {
    bulkLevelWrapper.classList.add('hidden');
    bulkLevelSelect.innerHTML = '';
    bulkInformalBox.classList.add('hidden');
    bulkInformalBox.innerHTML = '';
    return;
  }
  // Determine regcat and occupation
  const {regcat, occ} = getBulkRegcatAndOcc();
  const occSel = document.querySelector('select[name="occupation"]');
  let occId = occSel ? occSel.value : null;
  if (!regcat || !occId) {
    bulkLevelWrapper.classList.add('hidden');
    bulkLevelSelect.innerHTML = '';
    bulkInformalBox.classList.add('hidden');
    bulkInformalBox.innerHTML = '';
    return;
  }
  if (regcat === 'Formal' || regcat === 'Informal' || regcat === "Worker's PAS") {
    // Show level dropdown
    bulkLevelWrapper.classList.remove('hidden');
    fetchLevelsForOccupation(occ, function(levels) {
      bulkLevelSelect.innerHTML = '<option value="">Select Level</option>';
      levels.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.name;
        bulkLevelSelect.appendChild(opt);
      });
      // For informal: after level is chosen, fetch modules/papers
      if (regcat === 'Informal' || regcat === "Worker's PAS") {
        bulkLevelSelect.onchange = function() {
          const levelId = bulkLevelSelect.value;
          if (!levelId) {
            bulkInformalBox.classList.add('hidden');
            bulkInformalBox.innerHTML = '';
            return;
          }
          fetchModulesPapersForInformal(occId, levelId, function(data) {
            // Render module/paper selectors (one radio group per module)
            let html = '';
            (data.modules || []).forEach(mod => {
              html += `<div class='mb-2'><div class='font-semibold mb-1'>${mod.name}</div>`;
              (mod.papers || []).forEach(paper => {
                html += `<label class='mr-4'><input type='radio' name='bulk-paper-module-${mod.id}' value='${paper.id}'> ${paper.name}</label>`;
              });
              html += '</div>';
            });
            bulkInformalBox.innerHTML = html;
            bulkInformalBox.classList.remove('hidden');
          });
        };
      } else {
        bulkLevelSelect.onchange = null;
        bulkInformalBox.classList.add('hidden');
        bulkInformalBox.innerHTML = '';
      }
    });
  } else {
    bulkLevelWrapper.classList.add('hidden');
    bulkLevelSelect.innerHTML = '';
    bulkInformalBox.classList.add('hidden');
    bulkInformalBox.innerHTML = '';
  }
}

bulkSelect.addEventListener('change', updateBulkSelectors);
document.querySelectorAll('.candidate-checkbox').forEach(cb => cb.addEventListener('change', updateBulkSelectors));
// Also update on page load if any are checked
updateBulkSelectors();

function fetchModulesForCandidates(candidateIds, callback) {
  fetch('/eims/candidates/bulk-modules/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({candidate_ids: candidateIds})
  })
  .then(res => res.json())
  .then(data => callback(data))
  .catch(() => callback({success: false, error: 'Could not fetch modules.'}));
}

function updateBulkModuleSelector() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (bulkSelect.value === 'enroll' && checked.length > 0) {
    fetchModulesForCandidates(checked.map(cb => cb.value), function(data) {
      // --- Debug: log backend response ---
      console.log('[BULK ENROLL][MODULES RESPONSE]', data);
      // Store the returned level_id for use in bulk enroll POST
      window.bulkModularLevelId = data.level_id || null;
      if (data.success && data.modules && data.modules.length > 0) {
        bulkModuleBox.innerHTML = '<div class="font-semibold mb-2 text-gray-800">Select Modules (max 2):</div>';
        data.modules.forEach(m => {
          const id = 'bulkmod_' + m.id;
          const wrapper = document.createElement('div');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'bulk-module-checkbox';
          cb.id = id;
          cb.value = m.id;
          wrapper.appendChild(cb);
          const label = document.createElement('label');
          label.setAttribute('for', id);
          label.textContent = (m.code ? m.code + ' - ' : '') + m.name;
          wrapper.appendChild(label);
          bulkModuleBox.appendChild(wrapper);
          cb.addEventListener('change', function() {
            const selected = bulkModuleBox.querySelectorAll('.bulk-module-checkbox:checked');
            if (selected.length > 2) {
              this.checked = false;
              bulkError.textContent = 'You can select up to 2 modules.';
            } else {
              bulkError.textContent = '';
            }
          });
        });
        // --- Ensure module box is visible ---
        bulkModuleBox.classList.remove('hidden');
      } else {
        bulkModuleBox.innerHTML = '';
        bulkModuleBox.classList.add('hidden');
      }
    });
  } else {
    bulkModuleBox.innerHTML = '';
    bulkModuleBox.classList.add('hidden');
  }
}
// --- Call updateBulkModuleSelector on page load if any candidates are checked ---
document.addEventListener('DOMContentLoaded', function() {
  if (Array.from(document.querySelectorAll('.candidate-checkbox:checked')).length > 0) {
    updateBulkModuleSelector();
  }
});
// --- Also call on candidate selection and bulk action change ---
document.querySelectorAll('.candidate-checkbox').forEach(cb => cb.addEventListener('change', updateBulkModuleSelector));
bulkSelect.addEventListener('change', updateBulkModuleSelector);

// Bulk Change Reg Category logic
const bulkRegcatModal = document.getElementById('bulk-change-regcat-modal');
const bulkRegcatSelect = document.getElementById('bulk-regcat-select');
const bulkRegcatApply = document.getElementById('bulk-regcat-apply');
const bulkRegcatCancel = document.getElementById('bulk-regcat-cancel');
const bulkRegcatClose = document.getElementById('bulk-regcat-close');
const bulkRegcatError = document.getElementById('bulk-regcat-error');

function showBulkRegcatModal() {
  bulkRegcatSelect.value = '';
  bulkRegcatError.textContent = '';
  bulkRegcatError.classList.add('hidden');
  bulkRegcatModal.classList.remove('hidden');
}
function hideBulkRegcatModal() {
  bulkRegcatModal.classList.add('hidden');
}

if (bulkRegcatCancel) bulkRegcatCancel.onclick = hideBulkRegcatModal;
if (bulkRegcatClose) bulkRegcatClose.onclick = hideBulkRegcatModal;

bulkSelect.addEventListener('change', function() {
  if (bulkSelect.value === 'change_reg_cat') {
    showBulkRegcatModal();
  }
});

bulkRegcatApply && bulkRegcatApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  const newCat = bulkRegcatSelect.value;
  if (!newCat) {
    bulkRegcatError.textContent = 'Please select a registration category.';
    bulkRegcatError.classList.remove('hidden');
    return;
  }
  if (checked.length === 0) {
    bulkRegcatError.textContent = 'Please select at least one candidate.';
    bulkRegcatError.classList.remove('hidden');
    return;
  }
  bulkRegcatError.textContent = '';
  bulkRegcatError.classList.add('hidden');
  // AJAX POST to backend
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'change_reg_cat',
      candidate_ids: checked.map(cb => cb.value),
      registration_category: newCat
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Successfully changed registration category for ${checked.length} candidate${checked.length>1?'s':''}.`);
      window.location.reload();
    } else {
      bulkRegcatError.textContent = data.error || 'An error occurred.';
      bulkRegcatError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkRegcatError.textContent = 'Server error.';
    bulkRegcatError.classList.remove('hidden');
  });
});

document.querySelectorAll('.candidate-checkbox').forEach(cb => {
  cb.addEventListener('change', updateBulkModuleSelector);
});

bulkApply && bulkApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (!bulkSelect.value) {
    bulkError.textContent = 'Please select an action.';
    return;
  }
  if (checked.length === 0) {
    bulkError.textContent = 'Please select at least one candidate.';
    return;
  }
  // For Modular enroll, require module selection via checkboxes
  let moduleIds = [];
  let levelId = null;
  let paperIds = [];
  // Check if level selector is visible
  if (!bulkLevelWrapper.classList.contains('hidden')) {
    levelId = bulkLevelSelect.value;
    if (!levelId) {
      bulkError.textContent = 'Please select a level.';
      return;
    }
  }
  // For informal, require at least one paper per module
  if (!bulkInformalBox.classList.contains('hidden')) {
    // Collect all selected paper ids
    const radios = bulkInformalBox.querySelectorAll('input[type=radio]:checked');
    paperIds = Array.from(radios).map(r => r.value);
    if (paperIds.length === 0) {
      bulkError.textContent = 'Select at least one paper to enroll.';
      return;
    }
  }
  if (!bulkModuleBox.classList.contains('hidden') && bulkSelect.value === 'enroll') {
    moduleIds = Array.from(bulkModuleBox.querySelectorAll('.bulk-module-checkbox:checked')).map(cb => cb.value);
    if (moduleIds.length < 1 || moduleIds.length > 2) {
      bulkError.textContent = 'Select 1 or 2 modules.';
      return;
    }
  }
  // AJAX POST to backend
  bulkError.textContent = '';
  if (bulkSelect.value === 'add_regno_photo') {
    fetch("/eims/candidates/bulk-action/", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'add_regno_photo',
        candidate_ids: checked.map(cb => cb.value)
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        let msg = '';
        if (data.results) {
          let ok = data.results.filter(r => r.success).length;
          let fail = data.results.filter(r => !r.success).length;
          msg = `Regno-stamped photo added for ${ok} candidate${ok!==1?'s':''}.`;
          if (fail) msg += `\n${fail} failed.`;
        } else {
          msg = 'Regno-stamped photo added successfully.';
        }
        alert(msg);
        window.location.reload();
      } else {
        bulkError.textContent = data.error || 'An error occurred.';
      }
    })
    .catch(() => {
      bulkError.textContent = 'Server error.';
    });
    return;
  }
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: bulkSelect.value,
      candidate_ids: checked.map(cb => cb.value),
      module_ids: moduleIds,
      level_id: (bulkSelect.value === 'enroll' && document.getElementById('bulk-module-checkboxes') && window.bulkModularLevelId) ? window.bulkModularLevelId : levelId,
      paper_ids: paperIds
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      bulkError.textContent = '';
      // Prefer backend message if present
      if (data.message) {
        alert(data.message);
      } else {
        // Fallbacks for legacy/edge cases
        let candCount = checked.length;
        if (paperIds.length > 0) {
          alert(`Successfully enrolled ${candCount} candidate${candCount > 1 ? 's' : ''} in selected papers.`);
        } else if (moduleIds.length > 0) {
          let modCount = moduleIds.length;
          alert(`Successfully enrolled ${candCount} candidate${candCount > 1 ? 's' : ''} in ${modCount} module${modCount > 1 ? 's' : ''}.`);
        } else if (levelId) {
          alert(`Successfully enrolled ${candCount} candidate${candCount > 1 ? 's' : ''} in selected level.`);
        } else {
          alert('Bulk enrollment successful.');
        }
      }
      window.location.reload();
    } else {
      bulkError.textContent = data.error || 'An error occurred.';
    }
  })
  .catch(() => {
    bulkError.textContent = 'Server error.';
  });
});

// Helper to get CSRF token from cookie if not present in DOM
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}
