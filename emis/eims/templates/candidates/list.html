{% extends 'base.html' %}

{% block content %}
<div class="w-full px-2 md:px-8 mt-4 md:mt-8">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6 gap-4">
    <h1 class="text-xl md:text-2xl font-normal" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Candidates</h1>
    <div class="flex flex-col sm:flex-row gap-2 mb-4">
      <a href="{% url 'candidate_create' %}" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-center text-sm touch-target">Create Candidate</a>
      <a href="{% url 'candidate_import_dual' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-center text-sm touch-target">Import Candidates & Photos</a>
      {% if request.user.is_superuser or user_department in 'Admin,IT,Data' %}
      <a href="{% url 'enrollment_list' %}" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-center text-sm touch-target">Enrollments</a>
      {% endif %}
    </div>

  <!-- Bulk Change Assessment Center Modal -->
  <div id="bulk-change-center-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
      <h2 class="text-lg font-bold mb-4">Change Assessment Center</h2>
      <label for="bulk-center-select" class="block mb-2 font-medium">Select New Center</label>
      <select id="bulk-center-select" class="w-full border rounded px-3 py-2 mb-4" required>
        <option value="">-- Select Center --</option>
        {% for center in centers %}
          <option value="{{ center.id }}" data-has-branches="{{ center.has_branches|yesno:'true,false' }}">{{ center.center_name }}</option>
        {% endfor %}
      </select>
      
      <!-- Branch Selection (hidden by default) -->
      <div id="bulk-branch-wrapper" class="hidden mb-4">
        <label for="bulk-branch-select" class="block mb-2 font-medium">Select Branch</label>
        <select id="bulk-branch-select" class="w-full border rounded px-3 py-2" required>
          <option value="">-- Select Branch --</option>
        </select>
      </div>
      
      <div id="bulk-center-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-center-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-center-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Apply</button>
      </div>
      <button id="bulk-center-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>
  </div>

  {% if candidate_drafts %}
  <!-- Draft Candidates Section (collapsible) -->
  <div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg">
    <div class="flex items-center justify-between px-4 py-3">
      <div class="flex items-center gap-2">
        <h2 class="text-sm font-semibold text-yellow-800">Draft Candidates</h2>
        <span class="text-xs inline-flex items-center px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 font-medium">{{ candidate_drafts|length }}</span>
        <span class="text-xs text-yellow-700 hidden sm:inline">These entries are not submitted yet. Click Continue to finish.</span>
      </div>
      <div class="flex items-center gap-3">
        <label class="flex items-center gap-2 text-xs text-yellow-800">
          <input id="remember-drafts-visibility" type="checkbox" class="h-3 w-3">
          Remember choice
        </label>
        <button id="toggle-drafts" class="text-xs font-semibold text-yellow-900 hover:underline">Show</button>
      </div>
    </div>
    <div id="drafts-content" class="hidden border-t border-yellow-200 px-4 py-3">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-yellow-900">
              <th class="px-3 py-2 text-left">Full Name</th>
              <th class="px-3 py-2 text-left">Reg No</th>
              <th class="px-3 py-2 text-left">Reg. Category</th>
              <th class="px-3 py-2 text-left">Center</th>
              <th class="px-3 py-2 text-left">Updated</th>
              <th class="px-3 py-2 text-left">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for d in candidate_drafts %}
            {% with dd=d.data %}
            <tr class="border-t border-yellow-200">
              <td class="px-3 py-2">{{ dd.full_name|default:'(No name yet)' }}</td>
              <td class="px-3 py-2 text-gray-500">—</td>
              <td class="px-3 py-2">{{ dd.registration_category|default:'—' }}</td>
              <td class="px-3 py-2">{{ d.assessment_center.center_name|default:'—' }}</td>
              <td class="px-3 py-2 text-gray-600">{{ d.updated_at|date:"d/m/Y H:i" }}</td>
              <td class="px-3 py-2">
                <a class="text-blue-700 hover:underline font-medium" href="{% url 'candidate_create' %}?draft={{ d.id }}">Continue</a>
              </td>
            </tr>
            {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    // Collapsible drafts with persistence
    (function() {
      var btn = document.getElementById('toggle-drafts');
      var content = document.getElementById('drafts-content');
      var remember = document.getElementById('remember-drafts-visibility');
      var storageKey = 'candidates_showDrafts';

      // Initialize from localStorage
      try {
        var saved = localStorage.getItem(storageKey);
        if (saved === 'true') {
          content.classList.remove('hidden');
          btn.textContent = 'Hide';
          remember.checked = true;
        } else {
          content.classList.add('hidden');
          btn.textContent = 'Show';
        }
      } catch(e) {}

      btn.addEventListener('click', function() {
        var isHidden = content.classList.contains('hidden');
        if (isHidden) {
          content.classList.remove('hidden');
          btn.textContent = 'Hide';
          if (remember.checked) {
            try { localStorage.setItem(storageKey, 'true'); } catch(e) {}
          }
        } else {
          content.classList.add('hidden');
          btn.textContent = 'Show';
          if (remember.checked) {
            try { localStorage.setItem(storageKey, 'false'); } catch(e) {}
          }
        }
      });
    })();
  </script>
  {% endif %}

  <!-- Bulk Action Bar (hidden by default) -->
  <div id="bulk-action-bar" class="hidden mb-4 bg-gray-50 border border-blue-200 rounded-lg px-4 py-3">
    <div class="flex flex-col lg:flex-row items-start lg:items-center gap-4">
      <span class="font-semibold text-gray-700 text-sm">Bulk Actions:</span>
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full lg:w-auto">
        <select id="bulk-action-select" class="border px-3 py-2 rounded text-sm touch-target min-w-0">
          <option value="">Select Action</option>
          <option value="export">Export Selected to Excel</option>
          <option value="export_all">Export All (Filtered) to Excel</option>
          <option value="enroll">Enroll</option>
          {% if user.is_staff or user.groups.all|length > 0 and 'CenterRep' not in user.groups.all.0.name %}
          <!-- Admin/Staff only actions -->
          <option value="regenerate">Regenerate Reg. Number</option>
          <option value="add_regno_photo">Add Regno on Photo</option>
          <option value="change_reg_cat">Change Reg Category</option>
          <option value="change_occupation">Change Occupation</option>
          <option value="change_center">Change Assessment Center</option>
          <option value="mark_disabled">Mark as Disabled</option>
          <option value="mark_refugee">Mark as Refugee</option>
          <option value="verify">Verify</option>
          <option value="decline">Decline</option>
          {% if user.is_superuser or user.is_staff or user_department == "Admin" or user_department == "IT" %}
          <option value="clear_enrollment">Clear Enrollment (De-Enrol)</option>
          {% endif %}
          {% endif %}
        </select>
        <!-- Assessment Series selector for bulk enroll -->
        <div id="bulk-assessment-series-wrapper" class="hidden w-full sm:w-auto" style="min-width:200px;">
          <label for="bulk-assessment-series-select" class="block text-xs font-semibold text-gray-700 mb-1">Assessment Series: <span class="text-red-500">*</span></label>
          <select id="bulk-assessment-series-select" class="border px-3 py-2 rounded w-full text-sm touch-target">
            <option value="">Select Assessment Series...</option>
          </select>
        </div>
        <!-- Level selector for Formal/Informal bulk enroll -->
        <div id="bulk-level-select-wrapper" class="hidden w-full sm:w-auto" style="min-width:180px;">
          <label for="bulk-level-select" class="block text-xs font-semibold text-gray-700 mb-1">Select Level:</label>
          <select id="bulk-level-select" class="border px-3 py-2 rounded w-full text-sm touch-target"></select>
        </div>
        <!-- Module/Paper selector for Informal bulk enroll -->
        <div id="bulk-informal-modules-papers" class="hidden w-full sm:w-auto" style="min-width:240px; max-width:100%; max-height:320px; overflow-y:auto; border:1px solid #ccc; border-radius:6px; padding:8px 12px; background:#fff"></div>
        <!-- Module selector for Modular bulk enroll -->
        <div id="bulk-module-checkboxes" class="hidden w-full sm:w-auto" style="min-width:240px; min-height:120px; max-height:240px; overflow-y:auto; border:1px solid #ccc; border-radius:6px; padding:8px 12px; background:#fff"></div>
        <!-- Simple module count for Modular (center billing flow) -->
        <div id="bulk-module-count" class="hidden w-full sm:w-auto" style="min-width:180px;">
          <label for="bulk-module-count-select" class="block text-xs font-semibold text-gray-700 mb-1">Number of Modules:</label>
          <select id="bulk-module-count-select" class="border px-3 py-2 rounded w-full text-sm touch-target">
            <option value="">Select</option>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        <button id="bulk-action-apply" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm touch-target">Apply</button>
      </div>
    </div>
    <span id="bulk-action-error" class="text-red-600 text-sm mt-2 block"></span>
  </div>

  <!-- Bulk Change Reg Category Modal -->
  <div id="bulk-change-regcat-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
      <h2 class="text-lg font-bold mb-4">Change Registration Category</h2>
      <label for="bulk-regcat-select" class="block mb-2 font-medium">Select New Registration Category</label>
      <select id="bulk-regcat-select" class="w-full border rounded px-3 py-2 mb-4" required>
        <option value="">-- Select Category --</option>
        <option value="Formal">Formal</option>
        <option value="Modular">Modular</option>
        <option value="Informal">Informal</option>
      </select>
      <div id="bulk-regcat-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-regcat-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-regcat-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Apply</button>
      </div>
      <button id="bulk-regcat-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>

  <!-- Bulk Change Occupation Modal -->
  <div id="bulk-change-occupation-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
      <h2 class="text-lg font-bold mb-4">Change Occupation</h2>
      <label for="bulk-occupation-select" class="block mb-2 font-medium">Select New Occupation</label>
      <select id="bulk-occupation-select" class="w-full border rounded px-3 py-2 mb-4" required>
        <option value="">-- Select Occupation --</option>
        {% for occupation in occupations %}
          <option value="{{ occupation.id }}">{{ occupation.name }} ({{ occupation.code }})</option>
        {% endfor %}
      </select>
      <div id="bulk-occupation-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-occupation-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-occupation-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Apply</button>
      </div>
      <button id="bulk-occupation-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>

  <!-- Bulk Decline Modal -->
  <div id="bulk-decline-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
      <h2 class="text-lg font-bold mb-4">Decline Candidates</h2>
      <p class="text-sm text-gray-600 mb-4">Please provide a reason for declining the selected candidates:</p>
      <label for="bulk-decline-reason" class="block mb-2 font-medium">Decline Reason <span class="text-red-500">*</span></label>
      <textarea id="bulk-decline-reason" class="w-full border rounded px-3 py-2 mb-4 h-24" required placeholder="Enter reason for declining these candidates..."></textarea>
      <div id="bulk-decline-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-decline-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-decline-apply" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Decline Candidates</button>
      </div>
      <button id="bulk-decline-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>

  <!-- Bulk Mark as Disabled Modal -->
  <div id="bulk-mark-disabled-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
      <h2 class="text-lg font-bold mb-4">Mark as Disabled</h2>
      <div class="mb-4">
        <p class="mb-2 font-medium">Select Nature(s) of Disability <span class="text-red-600">*</span></p>
        <div id="bulk-nature-checkboxes" class="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto border rounded px-3 py-2">
          {% for nature in nature_of_disabilities %}
            <label class="flex items-center gap-2">
              <input type="checkbox" class="bulk-nature-checkbox" value="{{ nature.id }}">
              <span>{{ nature.name }}</span>
            </label>
          {% empty %}
            <span class="text-gray-500">No nature of disability options available.</span>
          {% endfor %}
        </div>
      </div>
      <div id="bulk-mark-disabled-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-mark-disabled-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-mark-disabled-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Apply</button>
      </div>
      <button id="bulk-mark-disabled-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>

  <!-- Bulk Mark as Refugee Modal -->
  <div id="bulk-mark-refugee-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
      <h2 class="text-lg font-bold mb-4">Mark as Refugee</h2>
      <p class="text-sm text-gray-600 mb-4">This will mark the selected candidates as refugees. You can optionally provide refugee numbers for each candidate.</p>
      
      <div class="mb-4">
        <label class="flex items-center gap-2 mb-3">
          <input type="checkbox" id="bulk-refugee-add-numbers" class="form-checkbox">
          <span class="font-medium">Add refugee numbers (optional)</span>
        </label>
        
        <div id="bulk-refugee-numbers-section" class="hidden">
          <p class="text-xs text-gray-500 mb-2">Leave blank for candidates that don't have refugee numbers yet.</p>
          <div id="bulk-refugee-numbers-list" class="max-h-48 overflow-y-auto border rounded px-3 py-2 space-y-2">
            <!-- Candidate refugee number inputs will be populated here by JavaScript -->
          </div>
        </div>
      </div>
      
      <div id="bulk-mark-refugee-error" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-4">
        <button id="bulk-mark-refugee-cancel" class="text-gray-600 hover:underline">Cancel</button>
        <button id="bulk-mark-refugee-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Mark as Refugee</button>
      </div>
      <button id="bulk-mark-refugee-close" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
  </div>

  <!-- Candidate Table -->
  <div class="mb-2 text-sm text-gray-600 flex justify-between items-center">
  <span>
    {{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ paginator.count }}
  </span>
  <span>
    {% if page_obj.has_previous %}
      <a href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.previous_page_number }}" class="inline-block px-2">&#60;</a>
    {% endif %}
    {% if page_obj.has_next %}
      <a href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.next_page_number }}" class="inline-block px-2">&#62;</a>
    {% endif %}
  </span>
</div>

<div class="bg-white shadow-sm border border-gray-200 rounded-lg">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-2 py-2 text-center">
            <input type="checkbox" id="select-all" class="form-checkbox h-4 w-4">
          </th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Image</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Reg No</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Full Name</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Occupation</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Sector</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Reg. Category</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Assessment Date</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Disability</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Refugee Status</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Center</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Status</th>
          <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Actions</th>
        </tr>
        <tr>
          <form method="get">
            <!-- Hidden fields to preserve assessment series context -->
            {% if filters.assessment_year %}
              <input type="hidden" name="assessment_year" value="{{ filters.assessment_year }}" />
            {% endif %}
            {% if filters.assessment_month %}
              <input type="hidden" name="assessment_month" value="{{ filters.assessment_month }}" />
            {% endif %}
            <th></th> <!-- Checkbox column, no filter -->
            <th></th> <!-- Image column, no filter -->
            <th class="px-3 py-2">
              <input type="text" name="reg_number" value="{{ filters.reg_number }}" placeholder="Search Reg No" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
            </th>
            <th class="px-3 py-2">
              <input type="text" name="search" value="{{ filters.search }}" placeholder="Search Name" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
            </th>
            <th class="px-3 py-2">
              <select name="occupation" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Occupations</option>
                {% for occupation in occupations %}
                  <option value="{{ occupation.id }}" {% if filters.occupation == occupation.id|stringformat:"s" %}selected{% endif %}>{{ occupation.name }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="px-3 py-2">
              <select name="sector" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Sectors</option>
                {% for sector in sectors %}
                  <option value="{{ sector.id }}" {% if filters.sector == sector.id|stringformat:"s" %}selected{% endif %}>{{ sector.name }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="px-3 py-2">
              <select name="registration_category" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Categ...</option>
                <option value="Formal" {% if filters.registration_category == 'Formal' %}selected{% endif %}>Formal</option>
                <option value="Modular" {% if filters.registration_category == 'Modular' %}selected{% endif %}>Modular</option>
                <option value="Informal" {% if filters.registration_category == 'Informal' %}selected{% endif %}>Informal</option>
              </select>
            </th>
            <th class="px-3 py-2">
              <div class="flex gap-1">
                <select name="assessment_month" class="border border-gray-300 rounded px-1 py-1 text-xs w-1/2 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">Month</option>
                  <option value="1" {% if filters.assessment_month == '1' %}selected{% endif %}>Jan</option>
                  <option value="2" {% if filters.assessment_month == '2' %}selected{% endif %}>Feb</option>
                  <option value="3" {% if filters.assessment_month == '3' %}selected{% endif %}>Mar</option>
                  <option value="4" {% if filters.assessment_month == '4' %}selected{% endif %}>Apr</option>
                  <option value="5" {% if filters.assessment_month == '5' %}selected{% endif %}>May</option>
                  <option value="6" {% if filters.assessment_month == '6' %}selected{% endif %}>Jun</option>
                  <option value="7" {% if filters.assessment_month == '7' %}selected{% endif %}>Jul</option>
                  <option value="8" {% if filters.assessment_month == '8' %}selected{% endif %}>Aug</option>
                  <option value="9" {% if filters.assessment_month == '9' %}selected{% endif %}>Sep</option>
                  <option value="10" {% if filters.assessment_month == '10' %}selected{% endif %}>Oct</option>
                  <option value="11" {% if filters.assessment_month == '11' %}selected{% endif %}>Nov</option>
                  <option value="12" {% if filters.assessment_month == '12' %}selected{% endif %}>Dec</option>
                </select>
                <select name="assessment_year" class="border border-gray-300 rounded px-1 py-1 text-xs w-1/2 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">Year</option>
                  {% for year in assessment_years %}
                    <option value="{{ year }}" {% if filters.assessment_year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                  {% endfor %}
                </select>
              </div>
            </th>
            <th class="px-3 py-2">
              <select name="disability" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All</option>
                <option value="true" {% if filters.disability == 'true' %}selected{% endif %}>Yes</option>
                <option value="false" {% if filters.disability == 'false' %}selected{% endif %}>No</option>
              </select>
            </th>
            <th class="px-3 py-2">
              <select name="is_refugee" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All</option>
                <option value="true" {% if filters.is_refugee == 'true' %}selected{% endif %}>Yes</option>
                <option value="false" {% if filters.is_refugee == 'false' %}selected{% endif %}>No</option>
              </select>
            </th>
            <th class="px-3 py-2">
              <select name="assessment_center" class="border border-gray-300 rounded px-2 py-1 text-sm w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Centers</option>
                {% for center in centers %}
                  <option value="{{ center.id }}" {% if filters.assessment_center == center.id|stringformat:"s" %}selected{% endif %}>{{center.center_number}} - {{ center.center_name }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="px-3 py-2">
                <div class="flex gap-1">
                    <button type="submit" name="apply_filters" value="1" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">Apply Filters</button>
                    <a href="?reset_filters=1" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">Reset</a>
                </div>
            </th>
          </form>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for candidate in candidates %}
        <tr class="cursor-pointer hover:bg-gray-50 transition-colors" data-href="{% url 'candidate_view' candidate.id %}">
          <td class="px-2 py-3 text-center">
            <input type="checkbox" class="candidate-checkbox form-checkbox h-4 w-4" value="{{ candidate.id }}">
          </td>
          <td class="px-3 py-3">
            <div class="flex flex-col items-center w-32 mx-auto">
              {# Show regno-stamped photo if available, else fallback to original, else show No photo #}
              {% if candidate.passport_photo_with_regno %}
                <img src="{{ candidate.passport_photo_with_regno.url }}" alt="Candidate Photo with Regno" class="h-32 w-32 object-cover rounded" />
              {% elif candidate.passport_photo %}
                <img src="{{ candidate.passport_photo.url }}" alt="Candidate Photo" class="h-32 w-32 object-cover rounded" />
              {% else %}
                <div class="h-32 w-32 flex items-center justify-center bg-gray-100 text-gray-400 rounded border">No photo</div>
              {% endif %}
            </div>
          </td>
          <td class="px-3 py-3 text-sm text-gray-900">{{ candidate.reg_number }}</td>
          <td class="px-3 py-3 text-sm text-gray-900">{{ candidate.full_name }}</td>
          <td class="px-3 py-3 text-sm text-gray-900">{{ candidate.occupation.name }}</td>
          <td class="px-3 py-3 text-sm text-gray-900">
            {% if candidate.occupation.sector %}
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">{{ candidate.occupation.sector.name }}</span>
            {% else %}
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600">Unknown</span>
            {% endif %}
          </td>
          <td class="px-3 py-3 text-sm text-gray-900">{{ candidate.get_registration_category_display }}</td>
          <td class="px-3 py-3 text-sm text-gray-900">
            {{ candidate.assessment_date|date:"d/m/Y"|default:"—" }}
          </td>
          <td class="px-3 py-3 text-sm text-gray-900">
            {% if candidate.disability %}
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">Yes</span>
            {% else %}
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600">No</span>
            {% endif %}
          </td>
          <td class="px-3 py-3 text-sm text-gray-900">
            {% if candidate.is_refugee %}
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Yes</span>
            {% else %}
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600">No</span>
            {% endif %}
          </td>
          <td class="px-3 py-3 text-sm text-gray-900">
            <div>
              {{ candidate.assessment_center.center_name|default:"—" }}
              {% if candidate.assessment_center_branch %}
                <div class="text-xs text-gray-500 mt-1">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                    Branch: {{ candidate.assessment_center_branch.branch_code }}
                  </span>
                </div>
              {% elif candidate.assessment_center.has_branches %}
                <div class="text-xs text-gray-500 mt-1">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">
                    Main Center
                  </span>
                </div>
              {% endif %}
            </div>
          </td>
          <td class="px-3 py-3">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">{{ candidate.status }}</span>
          </td>
          <td class="px-3 py-3 text-sm">
            <a href="{% url 'candidate_view' candidate.id %}" class="text-blue-600 hover:text-blue-900 font-medium">View</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="11" class="px-4 py-4 text-center text-gray-500">No candidates found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Page flags for JS (avoid inline template logic inside JS to satisfy linters) -->
<span id="page-flags" data-uvtstaff="{% if request.user.is_superuser or request.user.is_staff or user_department == 'Admin' or user_department == 'IT' or user_department == 'Data' %}true{% else %}false{% endif %}" class="hidden"></span>

<script>
// Bulk select logic
const selectAll = document.getElementById('select-all');
const checkboxes = document.querySelectorAll('.candidate-checkbox');
const bulkBar = document.getElementById('bulk-action-bar');
const bulkApply = document.getElementById('bulk-action-apply');
const bulkSelect = document.getElementById('bulk-action-select');
const bulkError = document.getElementById('bulk-action-error');
// Flag: treat Admin/IT/Data/Superusers/Staff as UVTAB staff for detailed modular flow
const isUvtStaff = (document.getElementById('page-flags')?.dataset?.uvtstaff === 'true');

// Delegated row click navigation (ignore clicks on interactive elements)
document.addEventListener('click', function(e) {
  const target = e.target;
  // Ignore if clicking interactive elements or inside them
  const interactiveSelectors = 'a, button, input, select, textarea, label, [role="button"]';
  if (target.closest(interactiveSelectors)) {
    return; // let default behavior happen
  }
  const row = target.closest('tr.cursor-pointer');
  if (row && row.dataset && row.dataset.href) {
    window.location = row.dataset.href;
  }
});

// Bulk Mark as Disabled modal logic
const bulkMarkDisabledModal = document.getElementById('bulk-mark-disabled-modal');
const bulkMarkDisabledApply = document.getElementById('bulk-mark-disabled-apply');
const bulkMarkDisabledCancel = document.getElementById('bulk-mark-disabled-cancel');
const bulkMarkDisabledClose = document.getElementById('bulk-mark-disabled-close');
const bulkMarkDisabledError = document.getElementById('bulk-mark-disabled-error');
const bulkNatureCheckboxes = document.getElementById('bulk-nature-checkboxes');

// Bulk Mark as Refugee modal logic
const bulkMarkRefugeeModal = document.getElementById('bulk-mark-refugee-modal');
const bulkMarkRefugeeApply = document.getElementById('bulk-mark-refugee-apply');
const bulkMarkRefugeeCancel = document.getElementById('bulk-mark-refugee-cancel');
const bulkMarkRefugeeClose = document.getElementById('bulk-mark-refugee-close');
const bulkMarkRefugeeError = document.getElementById('bulk-mark-refugee-error');
const bulkRefugeeAddNumbers = document.getElementById('bulk-refugee-add-numbers');
const bulkRefugeeNumbersSection = document.getElementById('bulk-refugee-numbers-section');
const bulkRefugeeNumbersList = document.getElementById('bulk-refugee-numbers-list');

function showBulkMarkDisabledModal() {
  bulkMarkDisabledModal.classList.remove('hidden');
  bulkMarkDisabledError.classList.add('hidden');
  bulkMarkDisabledError.textContent = '';
  // Uncheck all natures
  bulkMarkDisabledModal.querySelectorAll('.bulk-nature-checkbox').forEach(cb => cb.checked = false);
}
function hideBulkMarkDisabledModal() {
  bulkMarkDisabledModal.classList.add('hidden');
}

function showBulkMarkRefugeeModal() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (checked.length === 0) {
    alert('Please select at least one candidate.');
    return;
  }
  
  bulkMarkRefugeeModal.classList.remove('hidden');
  bulkMarkRefugeeError.classList.add('hidden');
  bulkMarkRefugeeError.textContent = '';
  bulkRefugeeAddNumbers.checked = false;
  bulkRefugeeNumbersSection.classList.add('hidden');
  
  // Populate candidate list for refugee numbers
  populateRefugeeNumbersList(checked);
}

function hideBulkMarkRefugeeModal() {
  bulkMarkRefugeeModal.classList.add('hidden');
}

function populateRefugeeNumbersList(checkedCandidates) {
  bulkRefugeeNumbersList.innerHTML = '';
  checkedCandidates.forEach(checkbox => {
    const row = checkbox.closest('tr');
    const regNumber = row.querySelector('td:nth-child(3)').textContent.trim();
    const fullName = row.querySelector('td:nth-child(4)').textContent.trim();
    
    const div = document.createElement('div');
    div.className = 'flex items-center gap-2 p-2 bg-gray-50 rounded';
    div.innerHTML = `
      <span class="text-sm font-medium min-w-0 flex-1">${regNumber} - ${fullName}</span>
      <input type="text" class="refugee-number-input border rounded px-2 py-1 text-sm w-32" 
             data-candidate-id="${checkbox.value}" 
             placeholder="Refugee #">
    `;
    bulkRefugeeNumbersList.appendChild(div);
  });
}

// Bulk Decline Modal Functions
const bulkDeclineModal = document.getElementById('bulk-decline-modal');
const bulkDeclineReason = document.getElementById('bulk-decline-reason');
const bulkDeclineError = document.getElementById('bulk-decline-error');
const bulkDeclineCancel = document.getElementById('bulk-decline-cancel');
const bulkDeclineClose = document.getElementById('bulk-decline-close');
const bulkDeclineApply = document.getElementById('bulk-decline-apply');

function showBulkDeclineModal() {
  bulkDeclineModal.classList.remove('hidden');
  bulkDeclineError.classList.add('hidden');
  bulkDeclineError.textContent = '';
  bulkDeclineReason.value = '';
  bulkDeclineReason.focus();
}

function hideBulkDeclineModal() {
  bulkDeclineModal.classList.add('hidden');
}
// Open modal on select
bulkSelect.addEventListener('change', function() {
  if (bulkSelect.value === 'mark_disabled') {
    showBulkMarkDisabledModal();
    bulkSelect.value = '';
  } else if (bulkSelect.value === 'mark_refugee') {
    showBulkMarkRefugeeModal();
    bulkSelect.value = '';
  } else if (bulkSelect.value === 'decline') {
    showBulkDeclineModal();
    bulkSelect.value = '';
  } else if (bulkSelect.value === 'enroll') {
    // Show Assessment Series selector immediately when Enroll is selected
    const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
    if (checked.length > 0) {
      // Use local references to avoid any timing/hoisting issues
      const bulkAssessmentSeriesWrapperEl = document.getElementById('bulk-assessment-series-wrapper');
      const bulkAssessmentSeriesSelectEl = document.getElementById('bulk-assessment-series-select');
      console.log('[BulkEnroll] Enroll selected. Candidates checked:', checked.length);
      if (bulkAssessmentSeriesWrapperEl) {
        bulkAssessmentSeriesWrapperEl.classList.remove('hidden');
        // As a fallback, ensure it's visible
        bulkAssessmentSeriesWrapperEl.style.display = '';
      }
      // Load Assessment Series data
      fetch('/eims/api/assessment-series/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then(res => res.json())
      .then(data => {
        try {
          if (!bulkAssessmentSeriesSelectEl) return;
          bulkAssessmentSeriesSelectEl.innerHTML = '<option value="">Select Assessment Series...</option>';
          const list = (data && Array.isArray(data.assessment_series)) ? data.assessment_series : [];
          if (list.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No assessment series found';
            bulkAssessmentSeriesSelectEl.appendChild(opt);
            return;
          }
          let selectedSet = false;
          list.forEach(series => {
            const opt = document.createElement('option');
            opt.value = series.id;
            opt.textContent = series.name + (series.is_current ? ' (Current)' : '');
            if (!selectedSet && series.is_current) {
              opt.selected = true;
              selectedSet = true;
            }
            bulkAssessmentSeriesSelectEl.appendChild(opt);
          });
          if (!selectedSet && list.length === 1) {
            // If only one series, select it by default
            bulkAssessmentSeriesSelectEl.options[1].selected = true;
          }
          console.log('[BulkEnroll] Loaded assessment series:', list.length);
        } catch (e) {
          console.error('Error processing assessment series response:', e, data);
          if (bulkAssessmentSeriesSelectEl) {
            bulkAssessmentSeriesSelectEl.innerHTML = '<option value="">Error processing series...</option>';
          }
        }
      })
      .catch(err => {
        console.error('Error loading assessment series:', err);
        if (bulkAssessmentSeriesSelectEl) {
          bulkAssessmentSeriesSelectEl.innerHTML = '<option value="">Error loading series...</option>';
        }
      });
    }
  } else {
    // Hide Assessment Series selector for other actions
    bulkAssessmentSeriesWrapper.classList.add('hidden');
    bulkAssessmentSeriesSelect.innerHTML = '';
  }
});
bulkMarkDisabledCancel.addEventListener('click', hideBulkMarkDisabledModal);
bulkMarkDisabledClose.addEventListener('click', hideBulkMarkDisabledModal);

// Bulk Mark as Refugee Modal Event Listeners
bulkMarkRefugeeCancel.addEventListener('click', hideBulkMarkRefugeeModal);
bulkMarkRefugeeClose.addEventListener('click', hideBulkMarkRefugeeModal);

// Toggle refugee numbers section
bulkRefugeeAddNumbers.addEventListener('change', function() {
  if (this.checked) {
    bulkRefugeeNumbersSection.classList.remove('hidden');
  } else {
    bulkRefugeeNumbersSection.classList.add('hidden');
  }
});

// Bulk Decline Modal Event Listeners
bulkDeclineCancel.addEventListener('click', hideBulkDeclineModal);
bulkDeclineClose.addEventListener('click', hideBulkDeclineModal);

bulkMarkDisabledApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  const natureIds = Array.from(bulkNatureCheckboxes.querySelectorAll('.bulk-nature-checkbox:checked')).map(cb => cb.value);
  if (natureIds.length === 0) {
    bulkMarkDisabledError.textContent = 'Please select at least one nature of disability.';
    bulkMarkDisabledError.classList.remove('hidden');
    return;
  }
  if (checked.length === 0) {
    bulkMarkDisabledError.textContent = 'Please select at least one candidate.';
    bulkMarkDisabledError.classList.remove('hidden');
    return;
  }
  bulkMarkDisabledError.textContent = '';
  bulkMarkDisabledError.classList.add('hidden');
  // AJAX POST to backend
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'mark_disabled',
      candidate_ids: checked.map(cb => cb.value),
      nature_of_disability_ids: natureIds
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message || 'Candidates marked as disabled successfully.');
      window.location.reload();
    } else {
      bulkMarkDisabledError.textContent = data.error || 'An error occurred.';
      bulkMarkDisabledError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkMarkDisabledError.textContent = 'Server error.';
    bulkMarkDisabledError.classList.remove('hidden');
  });
});

// Bulk Mark as Refugee Apply Handler
bulkMarkRefugeeApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  
  if (checked.length === 0) {
    bulkMarkRefugeeError.textContent = 'Please select at least one candidate.';
    bulkMarkRefugeeError.classList.remove('hidden');
    return;
  }
  
  // Collect refugee numbers if the checkbox is checked
  const refugeeNumbers = {};
  if (bulkRefugeeAddNumbers.checked) {
    const refugeeInputs = bulkRefugeeNumbersList.querySelectorAll('.refugee-number-input');
    refugeeInputs.forEach(input => {
      const candidateId = input.getAttribute('data-candidate-id');
      const refugeeNumber = input.value.trim();
      if (refugeeNumber) {
        refugeeNumbers[candidateId] = refugeeNumber;
      }
    });
  }
  
  bulkMarkRefugeeError.textContent = '';
  bulkMarkRefugeeError.classList.add('hidden');
  
  // AJAX POST to backend
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'mark_refugee',
      candidate_ids: checked.map(cb => cb.value),
      refugee_numbers: refugeeNumbers
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message || 'Candidates marked as refugees successfully.');
      window.location.reload();
    } else {
      bulkMarkRefugeeError.textContent = data.error || 'An error occurred.';
      bulkMarkRefugeeError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkMarkRefugeeError.textContent = 'Server error.';
    bulkMarkRefugeeError.classList.remove('hidden');
  });
});

// Bulk Decline Apply Handler
bulkDeclineApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  const reason = bulkDeclineReason.value.trim();
  
  if (!reason) {
    bulkDeclineError.textContent = 'Please provide a reason for declining.';
    bulkDeclineError.classList.remove('hidden');
    return;
  }
  
  if (checked.length === 0) {
    bulkDeclineError.textContent = 'Please select at least one candidate.';
    bulkDeclineError.classList.remove('hidden');
    return;
  }
  
  bulkDeclineError.textContent = '';
  bulkDeclineError.classList.add('hidden');
  
  // AJAX POST to backend
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'decline',
      candidate_ids: checked.map(cb => cb.value),
      decline_reason: reason
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message || 'Candidates declined successfully.');
      hideBulkDeclineModal();
      window.location.reload();
    } else {
      bulkDeclineError.textContent = data.error || 'An error occurred.';
      bulkDeclineError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkDeclineError.textContent = 'Server error.';
    bulkDeclineError.classList.remove('hidden');
  });
});

function updateBulkBar() {
  const checked = document.querySelectorAll('.candidate-checkbox:checked');
  if (checked.length > 0) {
    bulkBar.classList.remove('hidden');
  } else {
    bulkBar.classList.add('hidden');
    bulkError.textContent = '';
    bulkSelect.value = '';
  }
}

if (selectAll) {
  selectAll.addEventListener('change', function() {
    checkboxes.forEach(cb => { cb.checked = selectAll.checked; });
    updateBulkBar();
  });
}
checkboxes.forEach(cb => {
  cb.addEventListener('change', function() {
    if (!cb.checked) selectAll.checked = false;
    updateBulkBar();
  });
});

// --- Bulk Modular Module Selection Logic (with checkboxes) ---
const bulkModuleBox = document.getElementById('bulk-module-checkboxes');
const bulkModuleCount = document.getElementById('bulk-module-count');
const bulkModuleCountSelect = document.getElementById('bulk-module-count-select');
const bulkLevelWrapper = document.getElementById('bulk-level-select-wrapper');
const bulkLevelSelect = document.getElementById('bulk-level-select');
const bulkInformalBox = document.getElementById('bulk-informal-modules-papers');
const bulkAssessmentSeriesWrapper = document.getElementById('bulk-assessment-series-wrapper');
const bulkAssessmentSeriesSelect = document.getElementById('bulk-assessment-series-select');

// Helper: get regcat and occupation of selected candidates (assumes all same)
function getBulkRegcatAndOcc() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (!checked.length) return {};
  const row = checked[0].closest('tr');
  if (!row) return {};
  // Table columns order:
  // [0]=checkbox, [1]=image, [2]=regno, [3]=full name, [4]=occupation, [5]=sector, [6]=registration category
  const tds = row.querySelectorAll('td');
  const occ = tds[4] ? tds[4].textContent.trim() : undefined;
  const regcat = tds[6] ? tds[6].textContent.trim() : undefined;
  return { regcat, occ };
}

function fetchLevelsForOccupation(occupationName, cb) {
  // Find occupation id from filter dropdown
  const occSel = document.querySelector('select[name="occupation"]');
  let occId = occSel ? occSel.value : null;
  if (!occId) return cb([]);
  fetch(`/eims/api/levels-for-occupation/?occupation_id=${occId}`)
    .then(res => res.json())
    .then(data => cb(data.levels || []))
    .catch(() => cb([]));
}

function fetchModulesPapersForInformal(occupationId, levelId, cb) {
  // You will need to implement this endpoint on the backend
  fetch(`/eims/api/informal-modules-papers/?occupation_id=${occupationId}&level_id=${levelId}`)
    .then(res => res.json())
    .then(data => cb(data))
    .catch(() => cb({modules: []}));
}

// New function to fetch all levels, modules, and papers for cross-level selection
function fetchAllLevelsModulesPapersForInformal(occupationId, cb) {
  fetch(`/eims/api/all-levels-modules-papers/?occupation_id=${occupationId}`)
    .then(res => res.json())
    .then(data => cb(data))
    .catch(() => cb({success: false, level_module_data: []}));
}

// Function to display cross-level paper selection interface
function displayCrossLevelPaperSelection(levelModuleData) {
  let html = `
    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
      <h4 class="font-semibold text-blue-800 mb-2">📋 Paper Selection Instructions</h4>
      <ul class="text-blue-700 text-xs space-y-1">
        <li>• Select <strong>2-4 papers</strong> from any level/module</li>
        <li>• Only <strong>one paper per module</strong></li>
        <li>• Papers selected: <span id="bulkSelectedCount" class="font-bold">0</span>/4</li>
      </ul>
    </div>
    <div class="space-y-4 max-h-64 overflow-y-auto">
  `;
  
  levelModuleData.forEach(levelData => {
    html += `
      <div class="border border-gray-300 rounded p-3 bg-gray-50">
        <h4 class="text-sm font-bold mb-2 text-gray-800">🎓 ${levelData.level.name}</h4>
        <div class="grid grid-cols-1 gap-3">
    `;
    
    levelData.modules.forEach(moduleData => {
      html += `
        <div class="border border-gray-200 rounded p-2 bg-white">
          <h5 class="text-xs font-semibold mb-2 text-gray-700">📚 ${moduleData.module.name} (${moduleData.module.code})</h5>
          <div class="space-y-1">
      `;
      
      moduleData.papers.forEach(paperInfo => {
        html += `
          <div class="flex items-center space-x-2">
            <input 
              type="checkbox" 
              name="bulk-paper-${levelData.level.id}-${moduleData.module.id}-${paperInfo.paper.id}" 
              id="bulk-paper-${levelData.level.id}-${moduleData.module.id}-${paperInfo.paper.id}"
              class="bulk-paper-checkbox text-blue-600" 
              data-level="${levelData.level.id}"
              data-module="${moduleData.module.id}"
              data-paper="${paperInfo.paper.id}"
              data-module-name="${moduleData.module.name} (${moduleData.module.code})"
              value="${paperInfo.paper.id}"
            >
            <label for="bulk-paper-${levelData.level.id}-${moduleData.module.id}-${paperInfo.paper.id}" class="text-xs text-gray-700 cursor-pointer">
              📄 ${paperInfo.paper.name} (${paperInfo.paper.code})
            </label>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  bulkInformalBox.innerHTML = html;
  bulkInformalBox.classList.remove('hidden');
  
  // Add event listeners for paper selection validation
  setupBulkPaperValidation();
}

// Function to setup validation for bulk paper selection
function setupBulkPaperValidation() {
  const paperCheckboxes = document.querySelectorAll('.bulk-paper-checkbox');
  const selectedCountSpan = document.getElementById('bulkSelectedCount');
  
  function updateBulkPaperCount() {
    const selectedPapers = document.querySelectorAll('.bulk-paper-checkbox:checked');
    const count = selectedPapers.length;
    
    if (selectedCountSpan) {
      selectedCountSpan.textContent = count;
      selectedCountSpan.className = count >= 2 && count <= 4 ? 'font-bold text-green-600' : 'font-bold text-red-600';
    }
  }
  
  function validateBulkModuleSelection(checkbox) {
    if (!checkbox.checked) return true;
    
    const moduleId = checkbox.getAttribute('data-module');
    const moduleName = checkbox.getAttribute('data-module-name');
    const moduleCheckboxes = document.querySelectorAll('.bulk-paper-checkbox[data-module="' + moduleId + '"]:checked');
    
    if (moduleCheckboxes.length > 1) {
      alert('You can only select one paper per module. You have selected multiple papers for ' + moduleName + '. Please unselect one.');
      checkbox.checked = false;
      return false;
    }
    return true;
  }
  
  // Add event listeners to paper checkboxes
  paperCheckboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        if (!validateBulkModuleSelection(this)) {
          return;
        }
      }
      updateBulkPaperCount();
    });
  });
  
  // Initial count update
  updateBulkPaperCount();
}

function updateBulkSelectors() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (bulkSelect.value !== 'enroll' || checked.length === 0) {
    bulkAssessmentSeriesWrapper.classList.add('hidden');
    bulkAssessmentSeriesSelect.innerHTML = '';
    bulkLevelWrapper.classList.add('hidden');
    bulkLevelSelect.innerHTML = '';
    bulkInformalBox.classList.add('hidden');
    bulkInformalBox.innerHTML = '';
    bulkModuleCount.classList.add('hidden');
    return;
  }
  // Determine regcat and occupation
  const {regcat, occ} = getBulkRegcatAndOcc();
  // Do not depend on occupation filter selection for showing assessment series
  if (!regcat) {
    bulkAssessmentSeriesWrapper.classList.add('hidden');
    bulkAssessmentSeriesSelect.innerHTML = '';
    bulkLevelWrapper.classList.add('hidden');
    bulkLevelSelect.innerHTML = '';
    bulkInformalBox.classList.add('hidden');
    bulkInformalBox.innerHTML = '';
    bulkModuleCount.classList.add('hidden');
    return;
  }
  if (regcat === 'Formal' || regcat === 'Informal' || regcat === "Worker's PAS" || regcat === 'Modular') {
    // Show assessment series dropdown
    bulkAssessmentSeriesWrapper.classList.remove('hidden');
    fetch('/eims/api/assessment-series/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(res => res.json())
    .then(data => {
      try {
        bulkAssessmentSeriesSelect.innerHTML = '<option value="">Select Assessment Series...</option>';
        const list = (data && Array.isArray(data.assessment_series)) ? data.assessment_series : [];
        if (list.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No assessment series found';
          bulkAssessmentSeriesSelect.appendChild(opt);
        } else {
          let selectedSet2 = false;
          list.forEach(series => {
            const opt = document.createElement('option');
            opt.value = series.id;
            opt.textContent = series.name + (series.is_current ? ' (Current)' : '');
            if (!selectedSet2 && series.is_current) {
              opt.selected = true;
              selectedSet2 = true;
            }
            bulkAssessmentSeriesSelect.appendChild(opt);
          });
          if (!selectedSet2 && list.length === 1 && bulkAssessmentSeriesSelect.options.length > 1) {
            bulkAssessmentSeriesSelect.options[1].selected = true;
          }
        }
      } catch (e) {
        console.error('Error processing assessment series response:', e, data);
        bulkAssessmentSeriesSelect.innerHTML = '<option value="">Error processing series...</option>';
      }
      // For informal: show cross-level paper selection interface
      if (regcat === 'Informal' || regcat === "Worker's PAS") {
        bulkAssessmentSeriesSelect.onchange = function() {
          const assessmentSeriesId = bulkAssessmentSeriesSelect.value;
          if (!assessmentSeriesId) {
            bulkLevelWrapper.classList.add('hidden');
            bulkLevelSelect.innerHTML = '';
            bulkInformalBox.classList.add('hidden');
            bulkInformalBox.innerHTML = '';
            return;
          }
          // Hide level selector for cross-level selection
          bulkLevelWrapper.classList.add('hidden');
          bulkLevelSelect.innerHTML = '';
          
          // Fetch all levels, modules, and papers for cross-level selection
          // Obtain occupation_id from the occupation filter dropdown
          const occSelLocal = document.querySelector('select[name="occupation"]');
          const occIdLocal = occSelLocal ? occSelLocal.value : null;
          if (!occIdLocal) {
            bulkInformalBox.innerHTML = '<div class="text-red-600">Please select an Occupation in the filters to load papers.</div>';
            bulkInformalBox.classList.remove('hidden');
            return;
          }
          fetchAllLevelsModulesPapersForInformal(occIdLocal, function(data) {
            if (data.success && data.level_module_data && data.level_module_data.length > 0) {
              displayCrossLevelPaperSelection(data.level_module_data);
            } else {
              bulkInformalBox.innerHTML = '<div class="text-red-600">No papers available for this occupation.</div>';
              bulkInformalBox.classList.remove('hidden');
            }
          });
        };
        // If an assessment series is already selected (e.g., auto-selected), trigger load immediately
        if (bulkAssessmentSeriesSelect.value) {
          bulkAssessmentSeriesSelect.dispatchEvent(new Event('change'));
        }
      } else if (regcat === 'Formal') {
        // For formal: just show level selector after Assessment Series selection
        bulkAssessmentSeriesSelect.onchange = function() {
          const assessmentSeriesId = bulkAssessmentSeriesSelect.value;
          if (!assessmentSeriesId) {
            bulkLevelWrapper.classList.add('hidden');
            bulkLevelSelect.innerHTML = '';
            return;
          }
          fetchLevelsForOccupation(occ, function(levels) {
            bulkLevelSelect.innerHTML = '<option value="">Select Level</option>';
            levels.forEach(l => {
              const opt = document.createElement('option');
              opt.value = l.id;
              opt.textContent = l.name;
              bulkLevelSelect.appendChild(opt);
            });
            bulkLevelWrapper.classList.remove('hidden');
          });
        };
      } else if (regcat === 'Modular') {
        // Keep Assessment Series visible for Modular per requirement
        bulkAssessmentSeriesWrapper.classList.remove('hidden');
        // For staff, allow detailed module selection after choosing series
        bulkAssessmentSeriesSelect.onchange = function() {
          const assessmentSeriesId = bulkAssessmentSeriesSelect.value;
          if (!assessmentSeriesId) {
            bulkModuleBox.classList.add('hidden');
            bulkModuleBox.innerHTML = '';
            return;
          }
          if (isUvtStaff) {
            updateBulkModuleSelector();
            bulkModuleCount.classList.remove('hidden');
          }
        };
        // For centers (non-staff), show simple module count selector
        if (!isUvtStaff) {
          bulkModuleCount.classList.remove('hidden');
        }
        // Always hide cross-level box in Modular
        bulkInformalBox.classList.add('hidden');
        bulkInformalBox.innerHTML = '';
      }
    });
  } else {
    bulkAssessmentSeriesWrapper.classList.add('hidden');
    bulkAssessmentSeriesSelect.innerHTML = '';
    bulkLevelWrapper.classList.add('hidden');
    bulkLevelSelect.innerHTML = '';
    bulkInformalBox.classList.add('hidden');
    bulkInformalBox.innerHTML = '';
    // Show simple module count selector for Modular
    const {regcat: r2} = getBulkRegcatAndOcc();
    if (r2 === 'Modular' && !isUvtStaff) {
      bulkModuleCount.classList.remove('hidden');
    } else {
      bulkModuleCount.classList.add('hidden');
    }
  }
}

bulkSelect.addEventListener('change', updateBulkSelectors);
document.querySelectorAll('.candidate-checkbox').forEach(cb => cb.addEventListener('change', updateBulkSelectors));
// Also update on page load if any are checked
updateBulkSelectors();

function fetchModulesForCandidates(candidateIds, callback) {
  fetch('/eims/candidates/bulk-modules/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({candidate_ids: candidateIds})
  })
  .then(res => res.json())
  .then(data => callback(data))
  .catch(() => callback({success: false, error: 'Could not fetch modules.'}));
}

function updateBulkModuleSelector() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (bulkSelect.value === 'enroll' && checked.length > 0) {
    // Skip fetching modules for Modular center flow
    const {regcat} = getBulkRegcatAndOcc();
    if (regcat === 'Modular' && !isUvtStaff) {
      bulkModuleBox.innerHTML = '';
      bulkModuleBox.classList.add('hidden');
      return;
    }
    fetchModulesForCandidates(checked.map(cb => cb.value), function(data) {
      // --- Debug: log backend response ---
      console.log('[BULK ENROLL][MODULES RESPONSE]', data);
      // Store the returned level_id for use in bulk enroll POST
      window.bulkModularLevelId = data.level_id || null;
      if (data.success && data.modules && data.modules.length > 0) {
        // Prefill module_count if backend suggested
        if (data.suggested_count && bulkModuleCountSelect) {
          bulkModuleCountSelect.value = String(data.suggested_count);
        }
        bulkModuleBox.innerHTML = '<div class="font-semibold mb-2 text-gray-800">Select Modules (max 2):</div>';
        data.modules.forEach(m => {
          const id = 'bulkmod_' + m.id;
          const wrapper = document.createElement('div');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'bulk-module-checkbox';
          cb.id = id;
          cb.value = m.id;
          wrapper.appendChild(cb);
          const label = document.createElement('label');
          label.setAttribute('for', id);
          label.textContent = (m.code ? m.code + ' - ' : '') + m.name;
          wrapper.appendChild(label);
          bulkModuleBox.appendChild(wrapper);
          cb.addEventListener('change', function() {
            const selected = bulkModuleBox.querySelectorAll('.bulk-module-checkbox:checked');
            if (selected.length > 2) {
              this.checked = false;
              bulkError.textContent = 'You can select up to 2 modules.';
            } else {
              bulkError.textContent = '';
            }
          });
        });
        // --- Ensure module box is visible ---
        // Show for:
        // - Non-Modular categories (Formal when showing papers)
        // - Modular staff detailed path (isUvtStaff true)
        // Hide only for Modular center simple flow
        const {regcat} = getBulkRegcatAndOcc();
        if ((regcat && regcat !== 'Modular') || (regcat === 'Modular' && isUvtStaff)) {
          bulkModuleBox.classList.remove('hidden');
        } else {
          bulkModuleBox.classList.add('hidden');
        }
      } else {
        const {regcat} = getBulkRegcatAndOcc();
        if (regcat === 'Modular' && isUvtStaff) {
          // Show helpful message to staff users if backend didn't return modules
          const errMsg = (data && data.error) ? data.error : 'No modules available for the selected occupation/level.';
          bulkModuleBox.innerHTML = `<div class="text-sm text-gray-600">${errMsg}</div>`;
          bulkModuleBox.classList.remove('hidden');
          // Also surface in the error area
          bulkError.textContent = errMsg;
        } else {
          bulkModuleBox.innerHTML = '';
          bulkModuleBox.classList.add('hidden');
        }
      }
    });
  } else {
    bulkModuleBox.innerHTML = '';
    bulkModuleBox.classList.add('hidden');
  }
}
// --- Call updateBulkModuleSelector on page load if any candidates are checked ---
document.addEventListener('DOMContentLoaded', function() {
  if (Array.from(document.querySelectorAll('.candidate-checkbox:checked')).length > 0) {
    updateBulkModuleSelector();
  }
});
// --- Also call on candidate selection and bulk action change ---
document.querySelectorAll('.candidate-checkbox').forEach(cb => cb.addEventListener('change', updateBulkModuleSelector));
bulkSelect.addEventListener('change', updateBulkModuleSelector);

// Bulk Change Reg Category logic
const bulkRegcatModal = document.getElementById('bulk-change-regcat-modal');
const bulkRegcatSelect = document.getElementById('bulk-regcat-select');
const bulkRegcatApply = document.getElementById('bulk-regcat-apply');
const bulkRegcatCancel = document.getElementById('bulk-regcat-cancel');
const bulkRegcatClose = document.getElementById('bulk-regcat-close');
const bulkRegcatError = document.getElementById('bulk-regcat-error');

function showBulkRegcatModal() {
  bulkRegcatSelect.value = '';
  bulkRegcatError.textContent = '';
  bulkRegcatError.classList.add('hidden');
  bulkRegcatModal.classList.remove('hidden');
}
function hideBulkRegcatModal() {
  bulkRegcatModal.classList.add('hidden');
}

if (bulkRegcatCancel) bulkRegcatCancel.onclick = hideBulkRegcatModal;
if (bulkRegcatClose) bulkRegcatClose.onclick = hideBulkRegcatModal;

// Bulk Change Occupation logic
const bulkOccupationModal = document.getElementById('bulk-change-occupation-modal');
const bulkOccupationSelect = document.getElementById('bulk-occupation-select');
const bulkOccupationApply = document.getElementById('bulk-occupation-apply');
const bulkOccupationCancel = document.getElementById('bulk-occupation-cancel');
const bulkOccupationClose = document.getElementById('bulk-occupation-close');
const bulkOccupationError = document.getElementById('bulk-occupation-error');

function showBulkOccupationModal() {
  bulkOccupationSelect.value = '';
  bulkOccupationError.textContent = '';
  bulkOccupationError.classList.add('hidden');
  bulkOccupationModal.classList.remove('hidden');
}

function hideBulkOccupationModal() {
  bulkOccupationModal.classList.add('hidden');
}

if (bulkOccupationCancel) bulkOccupationCancel.onclick = hideBulkOccupationModal;
if (bulkOccupationClose) bulkOccupationClose.onclick = hideBulkOccupationModal;

// Bulk Change Center logic
const bulkCenterModal = document.getElementById('bulk-change-center-modal');
const bulkCenterSelect = document.getElementById('bulk-center-select');
const bulkBranchWrapper = document.getElementById('bulk-branch-wrapper');
const bulkBranchSelect = document.getElementById('bulk-branch-select');
const bulkCenterApply = document.getElementById('bulk-center-apply');
const bulkCenterCancel = document.getElementById('bulk-center-cancel');
const bulkCenterClose = document.getElementById('bulk-center-close');
const bulkCenterError = document.getElementById('bulk-center-error');

function showBulkCenterModal() {
  bulkCenterSelect.value = '';
  bulkBranchWrapper.classList.add('hidden');
  bulkBranchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
  bulkCenterError.textContent = '';
  bulkCenterError.classList.add('hidden');
  bulkCenterModal.classList.remove('hidden');
}
function hideBulkCenterModal() { bulkCenterModal.classList.add('hidden'); }
if (bulkCenterCancel) bulkCenterCancel.onclick = hideBulkCenterModal;
if (bulkCenterClose) bulkCenterClose.onclick = hideBulkCenterModal;

// Handle center selection for bulk modal
bulkCenterSelect && bulkCenterSelect.addEventListener('change', function() {
  const selectedOption = this.options[this.selectedIndex];
  const hasBranches = selectedOption.getAttribute('data-has-branches') === 'true';
  
  if (hasBranches && this.value) {
    // Load branches for selected center
    fetch(`/eims/api/center-branches/?center_id=${this.value}`)
      .then(response => response.json())
      .then(data => {
        bulkBranchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
        
        // Add "Main Branch" option for centers with branches
        const mainOption = document.createElement('option');
        mainOption.value = 'main';
        mainOption.textContent = 'Main Branch (No specific branch)';
        bulkBranchSelect.appendChild(mainOption);
        
        if (data.branches && data.branches.length > 0) {
          data.branches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = branch.branch_code;
            bulkBranchSelect.appendChild(option);
          });
        }
        bulkBranchWrapper.classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error loading branches:', error);
        bulkBranchWrapper.classList.add('hidden');
      });
  } else {
    bulkBranchWrapper.classList.add('hidden');
  }
});

bulkSelect.addEventListener('change', function() {
  if (bulkSelect.value === 'change_reg_cat') {
    showBulkRegcatModal();
  } else if (bulkSelect.value === 'change_occupation') {
    showBulkOccupationModal();
  } else if (bulkSelect.value === 'change_center') {
    showBulkCenterModal();
  }
});

bulkRegcatApply && bulkRegcatApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  const newCat = bulkRegcatSelect.value;
  if (!newCat) {
    bulkRegcatError.textContent = 'Please select a registration category.';
    bulkRegcatError.classList.remove('hidden');
    return;
  }
  if (checked.length === 0) {
    bulkRegcatError.textContent = 'Please select at least one candidate.';
    bulkRegcatError.classList.remove('hidden');
    return;
  }
  bulkRegcatError.textContent = '';
  bulkRegcatError.classList.add('hidden');
  // AJAX POST to backend
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'change_reg_cat',
      candidate_ids: checked.map(cb => cb.value),
      registration_category: newCat
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Successfully changed registration category for ${checked.length} candidate${checked.length>1?'s':''}.`);
      window.location.reload();
    } else {
      bulkRegcatError.textContent = data.error || 'An error occurred.';
      bulkRegcatError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkRegcatError.textContent = 'Server error.';
    bulkRegcatError.classList.remove('hidden');
  });
});

bulkOccupationApply && bulkOccupationApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  const newOccupationId = bulkOccupationSelect.value;
  if (!newOccupationId) {
    bulkOccupationError.textContent = 'Please select an occupation.';
    bulkOccupationError.classList.remove('hidden');
    return;
  }
  if (checked.length === 0) {
    bulkOccupationError.textContent = 'Please select at least one candidate.';
    bulkOccupationError.classList.remove('hidden');
    return;
  }
  bulkOccupationError.textContent = '';
  bulkOccupationError.classList.add('hidden');
  // AJAX POST to backend
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'change_occupation',
      candidate_ids: checked.map(cb => cb.value),
      occupation_id: newOccupationId
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Successfully changed occupation for ${checked.length} candidate${checked.length>1?'s':''}. Registration numbers have been updated.`);
      window.location.reload();
    } else {
      bulkOccupationError.textContent = data.error || 'An error occurred.';
      bulkOccupationError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkOccupationError.textContent = 'Server error.';
    bulkOccupationError.classList.remove('hidden');
  });
});

// Apply bulk change center
bulkCenterApply && bulkCenterApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  const newCenterId = bulkCenterSelect.value;
  const newBranchId = bulkBranchSelect.value;
  const selectedOption = bulkCenterSelect.options[bulkCenterSelect.selectedIndex];
  const hasBranches = selectedOption.getAttribute('data-has-branches') === 'true';
  
  if (!newCenterId) {
    bulkCenterError.textContent = 'Please select a center.';
    bulkCenterError.classList.remove('hidden');
    return;
  }
  if (hasBranches && !newBranchId) {
    bulkCenterError.textContent = 'Please select a branch for this center.';
    bulkCenterError.classList.remove('hidden');
    return;
  }
  if (checked.length === 0) {
    bulkCenterError.textContent = 'Please select at least one candidate.';
    bulkCenterError.classList.remove('hidden');
    return;
  }
  bulkCenterError.textContent = '';
  bulkCenterError.classList.add('hidden');
  
  const requestData = {
    action: 'change_center',
    candidate_ids: checked.map(cb => cb.value),
    assessment_center_id: newCenterId
  };
  
  if (newBranchId) {
    requestData.assessment_center_branch_id = newBranchId;
  }
  
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify(requestData)
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Successfully changed assessment center for ${checked.length} candidate${checked.length>1?'s':''}. Registration numbers have been updated.`);
      window.location.reload();
    } else {
      bulkCenterError.textContent = data.error || 'An error occurred.';
      bulkCenterError.classList.remove('hidden');
    }
  })
  .catch(() => {
    bulkCenterError.textContent = 'Server error.';
    bulkCenterError.classList.remove('hidden');
  });
});

document.querySelectorAll('.candidate-checkbox').forEach(cb => {
  cb.addEventListener('change', updateBulkModuleSelector);
});

bulkApply && bulkApply.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.candidate-checkbox:checked'));
  if (!bulkSelect.value) {
    bulkError.textContent = 'Please select an action.';
    return;
  }
  if (checked.length === 0 && bulkSelect.value !== 'export_all') {
    bulkError.textContent = 'Please select at least one candidate.';
    return;
  }
  // For Modular enroll, require module selection via checkboxes
  let moduleIds = [];
  let levelId = null;
  let paperIds = [];
  let assessmentSeriesId = null;
  // Check if level selector is visible
  if (!bulkLevelWrapper.classList.contains('hidden')) {
    levelId = bulkLevelSelect.value;
    if (!levelId) {
      bulkError.textContent = 'Please select a level.';
      return;
    }
  }
  // For informal, require 2-4 papers from cross-level selection
  if (!bulkInformalBox.classList.contains('hidden')) {
    // Collect all selected paper ids from checkboxes (cross-level selection)
    const paperCheckboxes = bulkInformalBox.querySelectorAll('.bulk-paper-checkbox:checked');
    paperIds = Array.from(paperCheckboxes).map(cb => cb.value);
    
    if (paperIds.length < 2) {
      bulkError.textContent = 'Worker\'s PAS/Informal candidates must select a minimum of 2 papers.';
      return;
    }
    if (paperIds.length > 4) {
      bulkError.textContent = 'Worker\'s PAS/Informal candidates can select a maximum of 4 papers.';
      return;
    }
    
    // Validate one paper per module rule
    const moduleIds = Array.from(paperCheckboxes).map(cb => cb.getAttribute('data-module'));
    const uniqueModules = new Set(moduleIds);
    if (moduleIds.length !== uniqueModules.size) {
      bulkError.textContent = 'You can only select one paper per module.';
      return;
    }
  }
  if (bulkSelect.value === 'enroll') {
    // Determine regcat early
    const {regcat} = getBulkRegcatAndOcc();
    // Gather module IDs if module box visible (staff detailed path)
    if (!bulkModuleBox.classList.contains('hidden')) {
      moduleIds = Array.from(bulkModuleBox.querySelectorAll('.bulk-module-checkbox:checked')).map(cb => cb.value);
    }
    // Assessment series: required whenever the selector is visible (all categories including Modular)
    if (!bulkAssessmentSeriesWrapper.classList.contains('hidden')) {
      assessmentSeriesId = bulkAssessmentSeriesSelect.value;
      if (!assessmentSeriesId) {
        bulkError.textContent = 'Please select an assessment series.';
        return;
      }
    }
    // Modular flow: allow module_count without specific modules (for centers and staff)
    if (regcat === 'Modular') {
      const mc = parseInt(bulkModuleCountSelect.value || '0', 10);
      if (moduleIds.length === 0) {
        if (![1,2].includes(mc)) {
          bulkError.textContent = 'Please select number of modules (1 or 2).';
          return;
        }
      } else {
        // If modules provided, enforce they match selected count
        if (![1,2].includes(mc)) {
          bulkError.textContent = 'Please select number of modules (1 or 2).';
          return;
        }
        if (moduleIds.length !== mc) {
          bulkError.textContent = `You selected ${moduleIds.length} module(s). Please set "Number of Modules" to ${moduleIds.length}.`;
          return;
        }
      }
    }
  }
  // Handle export actions
  if (bulkSelect.value === 'export' || bulkSelect.value === 'export_all') {
    // Create a form and submit to export endpoint
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/eims/candidates/export/';
    form.style.display = 'none';
    
    // Add CSRF token
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken');
    form.appendChild(csrfToken);
    
    if (bulkSelect.value === 'export_all') {
      // Add export_all flag
      const exportAllInput = document.createElement('input');
      exportAllInput.type = 'hidden';
      exportAllInput.name = 'export_all';
      exportAllInput.value = 'true';
      form.appendChild(exportAllInput);
    } else {
      // Add candidate IDs for selected export
      checked.forEach(cb => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'candidate_ids';
        input.value = cb.value;
        form.appendChild(input);
      });
    }
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    // Clear selection and hide bulk action bar
    document.querySelectorAll('.candidate-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('bulk-action-bar').classList.add('hidden');
    bulkSelect.value = '';
    return;
  }
  
  // AJAX POST to backend
  bulkError.textContent = '';
  if (bulkSelect.value === 'add_regno_photo') {
    fetch("/eims/candidates/bulk-action/", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'add_regno_photo',
        candidate_ids: checked.map(cb => cb.value)
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        let msg = '';
        if (data.results) {
          let ok = data.results.filter(r => r.success).length;
          let fail = data.results.filter(r => !r.success).length;
          msg = `Regno-stamped photo added for ${ok} candidate${ok!==1?'s':''}.`;
          if (fail) msg += `\n${fail} failed.`;
        } else {
          msg = 'Regno-stamped photo added successfully.';
        }
        alert(msg);
        window.location.reload();
      } else {
        bulkError.textContent = data.error || 'An error occurred.';
      }
    })
    .catch(() => {
      bulkError.textContent = 'Server error.';
    });
    return;
  }
  
  // Handle verify action with confirmation
  if (bulkSelect.value === 'verify') {
    const confirmMsg = `Are you sure you want to verify ${checked.length} candidate${checked.length !== 1 ? 's' : ''}?\n\nThis will mark them as verified and prevent centers from editing them.`;
    if (!confirm(confirmMsg)) {
      return;
    }
  } else if (bulkSelect.value === 'clear_enrollment') {
    const confirmMsg = `De-enrol ${checked.length} candidate${checked.length !== 1 ? 's' : ''}?\n\nOnly candidates WITHOUT any marks/results will be cleared. Others will be skipped.`;
    if (!confirm(confirmMsg)) {
      return;
    }
  }
  
  fetch("/eims/candidates/bulk-action/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: bulkSelect.value,
      candidate_ids: checked.map(cb => cb.value),
      module_ids: moduleIds,
      level_id: (bulkSelect.value === 'enroll' && document.getElementById('bulk-module-checkboxes') && window.bulkModularLevelId) ? window.bulkModularLevelId : levelId,
      module_count: (function(){ const {regcat}=getBulkRegcatAndOcc(); return regcat==='Modular' && (!moduleIds || moduleIds.length===0) ? parseInt(bulkModuleCountSelect.value||'0',10) : null; })(),
      paper_ids: paperIds,
      assessment_series_id: assessmentSeriesId
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      bulkError.textContent = '';
      // Prefer backend message if present
      if (data.message) {
        alert(data.message);
      } else {
        // Fallbacks for legacy/edge cases
        let candCount = checked.length;
        if (paperIds.length > 0) {
          alert(`Successfully enrolled ${candCount} candidate${candCount > 1 ? 's' : ''} in selected papers.`);
        } else if (moduleIds.length > 0) {
          let modCount = moduleIds.length;
          alert(`Successfully enrolled ${candCount} candidate${candCount > 1 ? 's' : ''} in ${modCount} module${modCount > 1 ? 's' : ''}.`);
        } else if (levelId) {
          alert(`Successfully enrolled ${candCount} candidate${candCount > 1 ? 's' : ''} in selected level.`);
        } else {
          alert('Bulk enrollment successful.');
        }
      }
      window.location.reload();
    } else {
      bulkError.textContent = data.error || 'An error occurred.';
    }
  })
  .catch(() => {
    bulkError.textContent = 'Server error.';
  });
});

// Helper to get CSRF token from cookie if not present in DOM
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}
