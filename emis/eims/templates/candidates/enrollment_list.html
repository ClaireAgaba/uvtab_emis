{% extends 'base.html' %}

{% block content %}
<div class="w-full px-2 md:px-8 mt-4 md:mt-8">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6 gap-4">
    <h1 class="text-xl md:text-2xl font-normal" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Enrollments</h1>
    <div class="flex flex-col sm:flex-row gap-2 mb-4">
      <a href="{% url 'candidate_list' %}" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-center text-sm touch-target">Back to Candidates</a>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white p-4 rounded shadow mb-4">
    <h3 class="text-lg font-semibold mb-3">Filters</h3>
    <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label for="reg_number" class="block text-sm font-medium text-gray-700 mb-1">Reg Number</label>
        <input type="text" id="reg_number" name="reg_number" value="{{ filters.reg_number }}" 
               class="w-full border rounded px-3 py-2 text-sm" placeholder="Search reg number">
      </div>
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input type="text" id="name" name="name" value="{{ filters.name }}" 
               class="w-full border rounded px-3 py-2 text-sm" placeholder="Search name">
      </div>
      <div>
        <label for="center" class="block text-sm font-medium text-gray-700 mb-1">Center</label>
        <input type="text" id="center" name="center" value="{{ filters.center }}" 
               class="w-full border rounded px-3 py-2 text-sm" placeholder="Search center">
      </div>
      <div>
        <label for="occupation" class="block text-sm font-medium text-gray-700 mb-1">Occupation</label>
        <input type="text" id="occupation" name="occupation" value="{{ filters.occupation }}" 
               class="w-full border rounded px-3 py-2 text-sm" placeholder="Search occupation">
      </div>
      <div>
        <label for="assessment_series" class="block text-sm font-medium text-gray-700 mb-1">Assessment Series</label>
        <select id="assessment_series" name="assessment_series" class="w-full border rounded px-3 py-2 text-sm">
          <option value="">All Series</option>
          {% for series in assessment_series_list %}
            <option value="{{ series.id }}" {% if filters.assessment_series == series.id|stringformat:"s" %}selected{% endif %}>
              {{ series.name }} ({{ series.start_date|date:"M Y" }})
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="registration_category" class="block text-sm font-medium text-gray-700 mb-1">Registration Category</label>
        <select id="registration_category" name="registration_category" class="w-full border rounded px-3 py-2 text-sm">
          <option value="">All Categories</option>
          <option value="formal" {% if filters.registration_category == "formal" %}selected{% endif %}>Formal</option>
          <option value="informal" {% if filters.registration_category == "informal" %}selected{% endif %}>Informal</option>
          <option value="worker's pas" {% if filters.registration_category == "worker's pas" %}selected{% endif %}>Worker's PAS</option>
          <option value="modular" {% if filters.registration_category == "modular" %}selected{% endif %}>Modular</option>
        </select>
      </div>
      <div class="md:col-span-6 flex gap-2">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">Apply Filters</button>
        <a href="{% url 'enrollment_list' %}" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 text-sm">Clear</a>
      </div>
    </form>
  </div>

  <!-- Bulk Actions -->
  <div class="bg-white p-4 rounded shadow mb-4">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div class="flex items-center gap-4">
        <label class="flex items-center">
          <input type="checkbox" id="select-all" class="mr-2">
          <span class="text-sm font-medium">Select All</span>
        </label>
        <span id="selected-count" class="text-sm text-gray-600">0 selected</span>
      </div>
      <div class="flex gap-2">
        <select id="bulk-action-select" class="border rounded px-3 py-2 text-sm" disabled>
          <option value="">Select Action</option>
          <option value="change_center">Change Assessment Center</option>
          <option value="clear_enrollment">Clear Enrollment</option>
          <option value="export">Export Selected</option>
        </select>
        <button id="apply-bulk-action" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm" disabled>Apply</button>
      </div>
    </div>
  </div>

  <!-- Enrollments Table -->
  <div class="bg-white rounded shadow overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <input type="checkbox" id="header-select-all" class="mr-2">
              Select
            </th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reg No</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assessment Center</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reg Category</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Occupation</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level(s)</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modules</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assessment Series</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for candidate in candidates %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm">
              <input type="checkbox" class="candidate-checkbox" value="{{ candidate.id }}">
            </td>
            <td class="px-4 py-3 text-sm">
              <span class="font-medium">{{ candidate.reg_number|default:"Not Set" }}</span>
            </td>
            <td class="px-4 py-3 text-sm">
              <div class="font-medium">{{ candidate.full_name }}</div>
              <div class="text-gray-500 text-xs">{{ candidate.gender }}</div>
            </td>
            <td class="px-4 py-3 text-sm">
              <div>{{ candidate.assessment_center.center_name }}</div>
              {% if candidate.assessment_center_branch %}
                <div class="text-gray-500 text-xs">{{ candidate.assessment_center_branch.branch_code }}</div>
              {% endif %}
            </td>
            <td class="px-4 py-3 text-sm">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                {% if candidate.registration_category == 'Formal' %}bg-blue-100 text-blue-800
                {% elif candidate.registration_category == 'Informal' %}bg-green-100 text-green-800
                {% elif 'Worker' in candidate.registration_category %}bg-yellow-100 text-yellow-800
                {% elif candidate.registration_category == 'Modular' %}bg-purple-100 text-purple-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ candidate.registration_category }}
              </span>
            </td>
            <td class="px-4 py-3 text-sm">
              <div class="font-medium">{{ candidate.occupation.name }}</div>
              <div class="text-gray-500 text-xs">{{ candidate.occupation.code }}</div>
            </td>
            <td class="px-4 py-3 text-sm">
              {% for level_enrollment in candidate.candidatelevel_set.all %}
                <div class="mb-1">
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded bg-indigo-100 text-indigo-800">
                    {{ level_enrollment.level.name }}
                  </span>
                </div>
              {% empty %}
                <span class="text-gray-400 text-xs">No levels</span>
              {% endfor %}
            </td>
            <td class="px-4 py-3 text-sm">
              {% for module_enrollment in candidate.candidatemodule_set.all %}
                <div class="mb-1">
                  <span class="inline-flex px-2 py-1 text-xs rounded bg-gray-100 text-gray-700">
                    {{ module_enrollment.module.name }}
                  </span>
                </div>
              {% empty %}
                <span class="text-gray-400 text-xs">No modules</span>
              {% endfor %}
            </td>
            <td class="px-4 py-3 text-sm">
              {% if candidate.assessment_series %}
                <div class="font-medium">{{ candidate.assessment_series.name }}</div>
                <div class="text-gray-500 text-xs">{{ candidate.assessment_series.start_date|date:"M Y" }}</div>
              {% else %}
                <span class="text-gray-400 text-xs">Not set</span>
              {% endif %}
            </td>
            <td class="px-4 py-3 text-sm">
              <a href="{% url 'candidate_view' candidate.id %}?return_to=enrollment_list{% if request.GET.page %}&page={{ request.GET.page }}{% endif %}{% if request.GET.reg_number %}&reg_number={{ request.GET.reg_number }}{% endif %}{% if request.GET.name %}&name={{ request.GET.name }}{% endif %}{% if request.GET.center %}&center={{ request.GET.center }}{% endif %}{% if request.GET.occupation %}&occupation={{ request.GET.occupation }}{% endif %}" 
                 class="text-blue-600 hover:text-blue-800 text-sm font-medium">View</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
              No enrolled candidates found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  {% if candidates.has_other_pages %}
  <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-4">
    <div class="text-sm text-gray-600">
      Showing {{ candidates.start_index }} to {{ candidates.end_index }} of {{ candidates.paginator.count }} enrolled candidates
    </div>
    <nav class="flex items-center space-x-1">
      {% if candidates.has_previous %}
        <a href="?page=1{% if request.GET.reg_number %}&reg_number={{ request.GET.reg_number }}{% endif %}{% if request.GET.name %}&name={{ request.GET.name }}{% endif %}{% if request.GET.center %}&center={{ request.GET.center }}{% endif %}{% if request.GET.occupation %}&occupation={{ request.GET.occupation }}{% endif %}{% if request.GET.assessment_series %}&assessment_series={{ request.GET.assessment_series }}{% endif %}{% if request.GET.registration_category %}&registration_category={{ request.GET.registration_category }}{% endif %}" 
           class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 rounded-l">First</a>
        <a href="?page={{ candidates.previous_page_number }}{% if request.GET.reg_number %}&reg_number={{ request.GET.reg_number }}{% endif %}{% if request.GET.name %}&name={{ request.GET.name }}{% endif %}{% if request.GET.center %}&center={{ request.GET.center }}{% endif %}{% if request.GET.occupation %}&occupation={{ request.GET.occupation }}{% endif %}{% if request.GET.assessment_series %}&assessment_series={{ request.GET.assessment_series }}{% endif %}{% if request.GET.registration_category %}&registration_category={{ request.GET.registration_category }}{% endif %}" 
           class="px-3 py-2 text-sm bg-white border-t border-b border-gray-300 text-gray-500 hover:bg-gray-50">‹ Prev</a>
      {% endif %}
      
      <!-- Page numbers -->
      {% for page_num in candidates.paginator.page_range %}
        {% if page_num == candidates.number %}
          <span class="px-3 py-2 text-sm bg-blue-600 border border-blue-600 text-white">{{ page_num }}</span>
        {% elif page_num == candidates.paginator.ELLIPSIS %}
          <span class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500">…</span>
        {% else %}
          <a href="?page={{ page_num }}{% if request.GET.reg_number %}&reg_number={{ request.GET.reg_number }}{% endif %}{% if request.GET.name %}&name={{ request.GET.name }}{% endif %}{% if request.GET.center %}&center={{ request.GET.center }}{% endif %}{% if request.GET.occupation %}&occupation={{ request.GET.occupation }}{% endif %}{% if request.GET.assessment_series %}&assessment_series={{ request.GET.assessment_series }}{% endif %}{% if request.GET.registration_category %}&registration_category={{ request.GET.registration_category }}{% endif %}" 
             class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 hover:bg-gray-50">{{ page_num }}</a>
        {% endif %}
      {% endfor %}
      
      {% if candidates.has_next %}
        <a href="?page={{ candidates.next_page_number }}{% if request.GET.reg_number %}&reg_number={{ request.GET.reg_number }}{% endif %}{% if request.GET.name %}&name={{ request.GET.name }}{% endif %}{% if request.GET.center %}&center={{ request.GET.center }}{% endif %}{% if request.GET.occupation %}&occupation={{ request.GET.occupation }}{% endif %}{% if request.GET.assessment_series %}&assessment_series={{ request.GET.assessment_series }}{% endif %}{% if request.GET.registration_category %}&registration_category={{ request.GET.registration_category }}{% endif %}" 
           class="px-3 py-2 text-sm bg-white border-t border-b border-gray-300 text-gray-500 hover:bg-gray-50">Next ›</a>
        <a href="?page={{ candidates.paginator.num_pages }}{% if request.GET.reg_number %}&reg_number={{ request.GET.reg_number }}{% endif %}{% if request.GET.name %}&name={{ request.GET.name }}{% endif %}{% if request.GET.center %}&center={{ request.GET.center }}{% endif %}{% if request.GET.occupation %}&occupation={{ request.GET.occupation }}{% endif %}{% if request.GET.assessment_series %}&assessment_series={{ request.GET.assessment_series }}{% endif %}{% if request.GET.registration_category %}&registration_category={{ request.GET.registration_category }}{% endif %}" 
           class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r">Last</a>
      {% endif %}
    </nav>
  </div>
  {% else %}
  <div class="mt-4 text-sm text-gray-600 text-center">
    Showing {{ candidates.paginator.count }} enrolled candidate{{ candidates.paginator.count|pluralize }}
  </div>
  {% endif %}

</div>

<!-- Bulk Change Assessment Center Modal -->
<div id="bulk-change-center-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
    <h2 class="text-lg font-bold mb-4">Change Assessment Center</h2>
    <label for="bulk-center-select" class="block mb-2 font-medium">Select New Center</label>
    <select id="bulk-center-select" class="w-full border rounded px-3 py-2 mb-4" required>
      <option value="">-- Select Center --</option>
      {% for center in centers %}
        <option value="{{ center.id }}" data-has-branches="{{ center.has_branches|yesno:'true,false' }}">{{ center.center_name }}</option>
      {% endfor %}
    </select>
    
    <!-- Branch Selection (hidden by default) -->
    <div id="bulk-branch-wrapper" class="hidden mb-4">
      <label for="bulk-branch-select" class="block mb-2 font-medium">Select Branch</label>
      <select id="bulk-branch-select" class="w-full border rounded px-3 py-2">
        <option value="">Loading branches...</option>
      </select>
    </div>
    
    <div class="flex justify-end gap-2">
      <button id="cancel-bulk-change-center" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
      <button id="apply-bulk-change-center" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Apply</button>
    </div>
  </div>
</div>

<!-- Clear Enrollment Confirmation Modal -->
<div id="clear-enrollment-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <h2 class="text-lg font-bold mb-4 text-red-600">Clear Enrollment</h2>
    <p class="mb-4 text-gray-700">Are you sure you want to clear enrollment for <span id="clear-count">0</span> selected candidate(s)? This action cannot be undone.</p>
    <div class="flex justify-end gap-2">
      <button id="cancel-clear-enrollment" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
      <button id="confirm-clear-enrollment" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Clear Enrollment</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const headerSelectAllCheckbox = document.getElementById('header-select-all');
    const candidateCheckboxes = document.querySelectorAll('.candidate-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');
    const bulkActionSelect = document.getElementById('bulk-action-select');
    const applyBulkActionBtn = document.getElementById('apply-bulk-action');

    // Update selected count and enable/disable bulk actions
    function updateBulkActions() {
        const selectedCheckboxes = document.querySelectorAll('.candidate-checkbox:checked');
        const count = selectedCheckboxes.length;
        
        selectedCountSpan.textContent = count + ' selected';
        
        if (count > 0) {
            bulkActionSelect.disabled = false;
            if (bulkActionSelect.value) {
                applyBulkActionBtn.disabled = false;
            }
        } else {
            bulkActionSelect.disabled = true;
            applyBulkActionBtn.disabled = true;
            bulkActionSelect.value = '';
        }
    }

    // Select all functionality
    function handleSelectAll(checked) {
        candidateCheckboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        updateBulkActions();
    }

    selectAllCheckbox.addEventListener('change', function() {
        handleSelectAll(this.checked);
        headerSelectAllCheckbox.checked = this.checked;
    });

    headerSelectAllCheckbox.addEventListener('change', function() {
        handleSelectAll(this.checked);
        selectAllCheckbox.checked = this.checked;
    });

    // Individual checkbox changes
    candidateCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActions();
            
            // Update select all checkboxes
            const allChecked = Array.from(candidateCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(candidateCheckboxes).some(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
            headerSelectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
            headerSelectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
    });

    // Enable apply button when action is selected
    bulkActionSelect.addEventListener('change', function() {
        const selectedCount = document.querySelectorAll('.candidate-checkbox:checked').length;
        applyBulkActionBtn.disabled = !(this.value && selectedCount > 0);
    });

    // Apply bulk action
    applyBulkActionBtn.addEventListener('click', function() {
        const selectedCandidates = Array.from(document.querySelectorAll('.candidate-checkbox:checked')).map(cb => cb.value);
        const action = bulkActionSelect.value;
        
        if (!action || selectedCandidates.length === 0) {
            alert('Please select an action and at least one candidate.');
            return;
        }

        switch (action) {
            case 'change_center':
                showBulkChangeCenterModal(selectedCandidates);
                break;
            case 'clear_enrollment':
                showClearEnrollmentModal(selectedCandidates);
                break;
            case 'export':
                exportSelectedCandidates(selectedCandidates);
                break;
        }
    });

    // Bulk change center modal
    function showBulkChangeCenterModal(candidateIds) {
        document.getElementById('bulk-change-center-modal').classList.remove('hidden');
    }

    // Clear enrollment modal
    function showClearEnrollmentModal(candidateIds) {
        document.getElementById('clear-count').textContent = candidateIds.length;
        document.getElementById('clear-enrollment-modal').classList.remove('hidden');
    }

    // Export selected candidates
    function exportSelectedCandidates(candidateIds) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "export_candidates" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Add selected candidate IDs
        candidateIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_candidates';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }

    // Modal close handlers
    document.getElementById('cancel-bulk-change-center').addEventListener('click', function() {
        document.getElementById('bulk-change-center-modal').classList.add('hidden');
    });

    document.getElementById('cancel-clear-enrollment').addEventListener('click', function() {
        document.getElementById('clear-enrollment-modal').classList.add('hidden');
    });

    // Bulk change center functionality
    const bulkCenterSelect = document.getElementById('bulk-center-select');
    const bulkBranchWrapper = document.getElementById('bulk-branch-wrapper');
    const bulkBranchSelect = document.getElementById('bulk-branch-select');

    bulkCenterSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const hasBranches = selectedOption.getAttribute('data-has-branches') === 'true';
        
        if (hasBranches && this.value) {
            bulkBranchWrapper.classList.remove('hidden');
            bulkBranchSelect.innerHTML = '<option value="">Loading branches...</option>';
            
            // Fetch branches for the selected center
            fetch(`/eims/api/center-branches/?center_id=${this.value}`)
                .then(response => response.json())
                .then(data => {
                    bulkBranchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
                    bulkBranchSelect.innerHTML += '<option value="main">Main Branch (No specific branch)</option>';
                    
                    data.branches.forEach(branch => {
                        bulkBranchSelect.innerHTML += `<option value="${branch.id}">${branch.branch_code}</option>`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching branches:', error);
                    bulkBranchSelect.innerHTML = '<option value="">Error loading branches</option>';
                });
        } else {
            bulkBranchWrapper.classList.add('hidden');
        }
    });

    // Apply bulk change center
    document.getElementById('apply-bulk-change-center').addEventListener('click', function() {
        const centerId = bulkCenterSelect.value;
        const branchId = bulkBranchSelect.value;
        const selectedCandidates = Array.from(document.querySelectorAll('.candidate-checkbox:checked')).map(cb => cb.value);
        
        if (!centerId) {
            alert('Please select a center.');
            return;
        }
        
        // Check if branch is required
        const selectedOption = bulkCenterSelect.options[bulkCenterSelect.selectedIndex];
        const hasBranches = selectedOption.getAttribute('data-has-branches') === 'true';
        
        if (hasBranches && !branchId) {
            alert('Please select a branch for this center.');
            return;
        }
        
        // Prepare data for bulk action
        const data = {
            action: 'change_center',
            candidate_ids: selectedCandidates,
            center_id: centerId
        };
        
        if (hasBranches && branchId) {
            if (branchId === 'main') {
                data.branch_id = null;
            } else {
                data.branch_id = branchId;
            }
        }
        
        // Send bulk action request
        fetch('{% url "bulk_candidate_action" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Assessment center changed successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error occurred while changing assessment center.');
        });
    });

    // Confirm clear enrollment
    document.getElementById('confirm-clear-enrollment').addEventListener('click', function() {
        const selectedCandidates = Array.from(document.querySelectorAll('.candidate-checkbox:checked')).map(cb => cb.value);
        
        const data = {
            action: 'clear_enrollment',
            candidate_ids: selectedCandidates
        };
        
        fetch('{% url "bulk_candidate_action" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Enrollment cleared successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error occurred while clearing enrollment.');
        });
    });
});
</script>
{% endblock %}
