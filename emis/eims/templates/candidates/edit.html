{% extends 'base.html' %}
{% block content %}
<h2 class="text-2xl font-normal mb-4" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Edit Candidate</h2>

<form method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-2 gap-6">
  {% csrf_token %}
  <!-- Personal Details -->
  <div>
    <label class="block font-semibold mb-1">Full Name</label>
    {{ form.full_name }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Passport Photo</label>
    {{ form.passport_photo }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Date of Birth</label>
    {{ form.date_of_birth }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Gender</label>
    {{ form.gender }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Nationality</label>
    {{ form.nationality }}
    <small class="text-gray-500">Please select the candidate's country of nationality.</small>
  </div>
  
  <!-- Refugee Status Fields (conditional based on nationality) -->
  <div id="refugee-status-field" style="display: none;">
    <label class="block font-semibold mb-1">{{ form.is_refugee.label }}</label>
    {{ form.is_refugee }}
    {% if form.is_refugee.help_text %}
      <small class="text-gray-500">{{ form.is_refugee.help_text }}</small>
    {% endif %}
  </div>
  
  <div id="refugee-number-field" style="display: none;">
    <label class="block font-semibold mb-1">{{ form.refugee_number.label }}</label>
    {{ form.refugee_number }}
    {% if form.refugee_number.help_text %}
      <small class="text-gray-500">{{ form.refugee_number.help_text }}</small>
    {% endif %}
  </div>
  
  <!-- Contact & Location -->
  <div>
    <label class="block font-semibold mb-1">Contact</label>
    {{ form.contact }}
  </div>
  <div>
    <label class="block font-semibold mb-1">District</label>
    {{ form.district }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Village</label>
    {{ form.village }}
  </div>
  <!-- Assessment Info -->
  <div>
    <label class="block font-semibold mb-1">Assessment Center</label>
    {{ form.assessment_center }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Entry Year</label>
    {{ form.entry_year }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Intake</label>
    {{ form.intake }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Registration Category</label>
    {{ form.registration_category }}
  </div>
  <div id="occupation-field-wrapper">
    <label class="block font-semibold mb-1">Occupation</label>
    {{ form.occupation }}
    <span id="occupation-loading" class="text-xs text-gray-500 hidden">Loading...</span>
  </div>
  <!-- Disability Section -->
  <div class="md:col-span-2 border-t pt-4 mt-4">
    <label for="id_disability" class="font-semibold mb-1">{{ form.disability.label_tag }}</label>
    {{ form.disability }}
    {% if form.disability.help_text %}<p class="text-gray-600 text-xs">{{ form.disability.help_text }}</p>{% endif %}
  </div>
  <div class="md:col-span-2 mb-4" id="nature-of-disability-group" style="display: none;">
    <label for="id_nature_of_disability" class="font-semibold mb-1" id="nature-label">{{ form.nature_of_disability.label_tag }}<span id="nature-required" style="color:red; display:none;">*</span></label>
    <div id="nature-checkboxes">
      {{ form.nature_of_disability }}
    </div>
    {% if form.nature_of_disability.help_text %}<p class="text-gray-600 text-xs">{{ form.nature_of_disability.help_text }}</p>{% endif %}
    {% for error in form.nature_of_disability.errors %}<p class="text-red-600 text-xs">{{ error }}</p>{% endfor %}
  </div>
  
  <div class="md:col-span-2 mb-4" id="disability-specification-group" style="display: none;">
    <label for="id_disability_specification" class="font-semibold mb-1">{{ form.disability_specification.label_tag }}</label>
    {{ form.disability_specification }}
    {% if form.disability_specification.help_text %}<p class="text-gray-600 text-xs">{{ form.disability_specification.help_text }}</p>{% endif %}
    {% for error in form.disability_specification.errors %}<p class="text-red-600 text-xs">{{ error }}</p>{% endfor %}
  </div>
  <!-- Assessment Dates -->
  <div>
    <label class="block font-semibold mb-1">Start Date</label>
    {{ form.start_date }}
  </div>
  <div>
    <label class="block font-semibold mb-1">Finish Date</label>
    {{ form.finish_date }}
  </div>
  <div class="md:col-span-2">
    <label class="block font-semibold mb-1">Assessment Date</label>
    {{ form.assessment_date }}
  </div>
  {{ form.non_field_errors }}
  
  <!-- Relevant Documents Section -->
  <div class="md:col-span-2 bg-gray-50 p-4 rounded-lg mt-4">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Relevant Documents <span class="text-sm text-gray-500 font-normal">(Optional)</span></h3>
    <p class="text-sm text-gray-600 mb-4">Attach or update supporting documents. Accepted formats: PNG, JPG, PDF</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="{{ form.identification_document.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.identification_document.label }}
        </label>
        <p class="text-xs text-gray-500 mb-2">National ID, Birth Certificate, or other identification</p>
        {% if candidate.identification_document %}
          <div class="mb-2 p-2 bg-blue-50 rounded border">
            <p class="text-sm text-blue-800">
              <strong>Current:</strong> 
              <a href="{{ candidate.identification_document.url }}" target="_blank" class="text-blue-600 hover:underline">
                {{ candidate.identification_document.name|slice:"50:" }}
              </a>
            </p>
          </div>
        {% endif %}
        {{ form.identification_document }}
        {% if form.identification_document.errors %}
          <div class="text-red-600 text-sm mt-1">
            {{ form.identification_document.errors }}
          </div>
        {% endif %}
      </div>
      
      <div>
        <label for="{{ form.qualification_document.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.qualification_document.label }}
        </label>
        <p class="text-xs text-gray-500 mb-2">Relevant qualifications (for Full Occupation candidates)</p>
        {% if candidate.qualification_document %}
          <div class="mb-2 p-2 bg-blue-50 rounded border">
            <p class="text-sm text-blue-800">
              <strong>Current:</strong> 
              <a href="{{ candidate.qualification_document.url }}" target="_blank" class="text-blue-600 hover:underline">
                {{ candidate.qualification_document.name|slice:"50:" }}
              </a>
            </p>
          </div>
        {% endif %}
        {{ form.qualification_document }}
        {% if form.qualification_document.errors %}
          <div class="text-red-600 text-sm mt-1">
            {{ form.qualification_document.errors }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Action Buttons -->
  <div class="md:col-span-2 flex justify-between items-center mt-4">
    <a href="{% url 'candidate_view' candidate.id %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded inline-flex items-center">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Candidate
    </a>
    <div class="space-x-3">
      <a href="{% url 'candidate_view' candidate.id %}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded">
        Cancel
      </a>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
        Save Changes
      </button>
    </div>
  </div>
</form>

<script>
// --- Dynamic Village Filtering ---
document.addEventListener('DOMContentLoaded', function() {
    const districtSelect = document.getElementById('id_district');
    const villageSelect = document.getElementById('id_village');
    const villageLoadingText = "Loading villages...";
    const villageSelectText = "Select a village";
    const villageNoneText = "No villages available";
    const villagePleaseSelectDistrictText = "Select a district first";

    function updateVillageOptions(villages) {
        villageSelect.innerHTML = ''; // Clear existing options

        if (villages === null || villages.length === 0) {
            const option = new Option(villageNoneText, '');
            villageSelect.add(option);
            villageSelect.disabled = true;
            return;
        }

        villageSelect.disabled = false;
        let firstOption = new Option(`--- ${villageSelectText} ---`, '');
        villageSelect.add(firstOption);

        villages.forEach(function(village) {
            const option = new Option(village.name, village.id);
            villageSelect.add(option);
        });
    }

    if (districtSelect && villageSelect) {
        // Set initial state for village dropdown
        // For edit form, the initial district (and thus village) might be pre-selected by Django.
        // The form's __init__ method already populates villages if a district instance exists.
        // This JS will handle dynamic changes if the user alters the district.
        if (!districtSelect.value) {
            villageSelect.innerHTML = '';
            const option = new Option(`--- ${villagePleaseSelectDistrictText} ---`, '');
            villageSelect.add(option);
            villageSelect.disabled = true;
        } else {
            // If a district is pre-selected, ensure villages are loaded or correctly shown.
            // The backend form already populates this, but we can re-trigger if needed or rely on backend.
            // For simplicity, we'll let the backend handle initial population on edit, 
            // and this script handles user-driven changes.
            // If the village select is empty despite a district being selected, it implies an issue or it's a new selection.
            if (villageSelect.options.length <= 1 && districtSelect.value) { // <=1 because of potential placeholder
                 districtSelect.dispatchEvent(new Event('change')); // Trigger if empty to load
            }
        }

        districtSelect.addEventListener('change', function() {
            const districtId = this.value;
            villageSelect.innerHTML = ''; // Clear existing options

            if (districtId) {
                villageSelect.disabled = true;
                const loadingOption = new Option(villageLoadingText, '');
                villageSelect.add(loadingOption);

                const urlTemplate = "{% url 'api_district_villages' district_id=0 %}";
                const fetchUrl = urlTemplate.replace('/0/', `/${districtId}/`);
                fetch(fetchUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        updateVillageOptions(data);
                    })
                    .catch(error => {
                        console.error('Error fetching villages:', error);
                        villageSelect.innerHTML = '';
                        const errorOption = new Option('Error loading villages', '');
                        villageSelect.add(errorOption);
                        villageSelect.disabled = true;
                    });
            } else {
                const option = new Option(`--- ${villagePleaseSelectDistrictText} ---`, '');
                villageSelect.add(option);
                villageSelect.disabled = true;
            }
        });
        // Initial check for edit form: if district is selected and villages are not populated by backend (e.g. if JS runs before backend list is fully rendered or if it's empty for some reason)
        // The CandidateForm __init__ should handle populating villages if self.instance.district exists.
        // This JS primarily handles changes after initial load.
        // However, to be robust, if a district is selected and village field is empty/placeholder, trigger a load.
        if (districtSelect.value && villageSelect.options.length <=1 && villageSelect.value === '') {
             districtSelect.dispatchEvent(new Event('change'));
        }

    }
});
// --- End Dynamic Village Filtering ---
// --- Disability/Nature of Disability Dynamic Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const disabilityCheckbox = document.getElementById('id_disability');
    const natureGroup = document.getElementById('nature-of-disability-group');
    const specificationGroup = document.getElementById('disability-specification-group');
    function updateNatureVisibility() {
        if (disabilityCheckbox && disabilityCheckbox.checked) {
            natureGroup.style.display = 'block';
            specificationGroup.style.display = 'block';
        } else {
            natureGroup.style.display = 'none';
            specificationGroup.style.display = 'none';
        }
    }
    if (disabilityCheckbox && natureGroup) {
        updateNatureVisibility();
        disabilityCheckbox.addEventListener('change', updateNatureVisibility);
    }
});
// --- End Disability/Nature of Disability Dynamic Logic ---
// --- End Disability/Nature of Disability Dynamic Logic ---
// --- Begin Nature of Disability Required Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const disabilityCheckbox = document.getElementById('id_disability');
    const natureGroup = document.getElementById('nature-of-disability-group');
    const natureRequired = document.getElementById('nature-required');
    const natureCheckboxes = document.querySelectorAll('#nature-checkboxes input[type="checkbox"]');
    const form = document.querySelector('form');
    function updateNatureRequired() {
        if (disabilityCheckbox && disabilityCheckbox.checked) {
            if (natureRequired) natureRequired.style.display = 'inline';
        } else {
            if (natureRequired) natureRequired.style.display = 'none';
        }
    }
    if (disabilityCheckbox && natureRequired) {
        updateNatureRequired();
        disabilityCheckbox.addEventListener('change', updateNatureRequired);
    }
    if (form) {
        form.addEventListener('submit', function(e) {
            if (disabilityCheckbox && disabilityCheckbox.checked) {
                let anyChecked = false;
                natureCheckboxes.forEach(cb => { if (cb.checked) anyChecked = true; });
                if (!anyChecked) {
                    e.preventDefault();
                    alert('Please select at least one Nature of Disability.');
                    // Optionally, scroll to field
                    document.getElementById('nature-of-disability-group').scrollIntoView({behavior:'smooth'});
                }
            }
        });
    }
});
// --- End Nature of Disability Required Logic ---

// --- Name Formatting Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const fullNameField = document.getElementById('id_full_name');
    
    function formatName(name) {
        if (!name) return name;
        
        // Split the name into parts
        const nameParts = name.trim().split(/\s+/);
        if (nameParts.length === 0) return name;
        
        // Format: First part (surname) in UPPERCASE, rest in sentence case
        const formattedParts = nameParts.map((part, index) => {
            if (index === 0) {
                // First part (surname) - all uppercase
                return part.toUpperCase();
            } else {
                // Other parts - sentence case (first letter upper, rest lower)
                return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
            }
        });
        
        return formattedParts.join(' ');
    }
    
    if (fullNameField) {
        // Format on blur (when user finishes typing)
        fullNameField.addEventListener('blur', function() {
            const formatted = formatName(this.value);
            if (formatted !== this.value) {
                this.value = formatted;
            }
        });
        
        // Also format on form submission to ensure consistency
        const form = fullNameField.closest('form');
        if (form) {
            form.addEventListener('submit', function() {
                const formatted = formatName(fullNameField.value);
                if (formatted !== fullNameField.value) {
                    fullNameField.value = formatted;
                }
            });
        }
        
        // Show formatting hint
        const nameLabel = document.querySelector('label[for="id_full_name"]');
        if (nameLabel && !nameLabel.querySelector('.name-format-hint')) {
            const hint = document.createElement('span');
            hint.className = 'name-format-hint text-xs text-gray-500 ml-2';
            hint.textContent = '(Format: SURNAME Other Names)';
            nameLabel.appendChild(hint);
        }
    }
});
// --- End Name Formatting Logic ---

// --- Refugee Fields Dynamic Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const nationalitySelect = document.getElementById('id_nationality');
    const refugeeStatusField = document.getElementById('refugee-status-field');
    const refugeeNumberField = document.getElementById('refugee-number-field');
    const isRefugeeSelect = document.getElementById('id_is_refugee');
    
    function updateRefugeeFields() {
        const nationality = nationalitySelect.value;
        
        console.log('Nationality selected:', nationality); // Debug log
        
        // Show refugee status field only if nationality is not Uganda
        // Check for both country code 'UG' and country name 'Uganda'
        if (nationality && nationality !== 'UG' && nationality !== 'Uganda' && nationality !== '') {
            console.log('Showing refugee field for:', nationality); // Debug log
            refugeeStatusField.style.display = 'block';
            
            // Check if refugee status is selected
            const isRefugee = isRefugeeSelect.value;
            if (isRefugee === 'True') {
                refugeeNumberField.style.display = 'block';
            } else {
                refugeeNumberField.style.display = 'none';
                // Clear refugee number if not a refugee
                const refugeeNumberInput = document.getElementById('id_refugee_number');
                if (refugeeNumberInput) {
                    refugeeNumberInput.value = '';
                }
            }
        } else {
            console.log('Hiding refugee field for Uganda or empty selection'); // Debug log
            // Hide both refugee fields if nationality is Uganda (UG) or not selected
            refugeeStatusField.style.display = 'none';
            refugeeNumberField.style.display = 'none';
            
            // Clear refugee fields
            if (isRefugeeSelect) {
                isRefugeeSelect.value = '';
            }
            const refugeeNumberInput = document.getElementById('id_refugee_number');
            if (refugeeNumberInput) {
                refugeeNumberInput.value = '';
            }
        }
    }
    
    function updateRefugeeNumberField() {
        const isRefugeeValue = isRefugeeSelect.value;
        // Show refugee_number field only if is_refugee is True
        if (isRefugeeValue === 'True' || isRefugeeValue === true || isRefugeeValue === 'true') {
            refugeeNumberField.style.display = 'block';
        } else {
            refugeeNumberField.style.display = 'none';
            // Clear refugee number if not a refugee
            const refugeeNumberInput = document.getElementById('id_refugee_number');
            if (refugeeNumberInput) {
                refugeeNumberInput.value = '';
            }
        }
    }
    
    if (nationalitySelect && refugeeStatusField && refugeeNumberField && isRefugeeSelect) {
        // Initial state check
        updateRefugeeFields();
        
        // Add event listeners
        nationalitySelect.addEventListener('change', updateRefugeeFields);
        isRefugeeSelect.addEventListener('change', updateRefugeeNumberField);
    }
});
// --- End Refugee Fields Dynamic Logic ---
</script>
{% endblock %}
