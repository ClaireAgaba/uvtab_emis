{% extends 'base.html' %}
{% load static %}
{% load country_extras %}

{% block content %}

<!-- Breadcrumb -->
<div class="text-sm text-gray-500 mb-4 px-4 sm:px-0">
    <a href="{% url 'candidate_list' %}" class="text-blue-600 hover:underline">Candidates</a> /
    <span class="text-gray-700">New Candidate</span>
</div>

<div class="max-w-4xl mx-auto mt-6 sm:mt-10 bg-white p-4 sm:p-6 shadow rounded-lg">
  <h1 class="text-xl sm:text-2xl font-normal mb-4 sm:mb-6" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Register New Candidate</h1>
  
  {% if form.errors %}
    <div class="mb-4">
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
        <strong class="font-bold">Please correct the errors below:</strong>
        <ul class="mt-2 text-sm space-y-1">
          {% for field in form %}
            {% for error in field.errors %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}
    
    <!-- Personal Information Section -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Personal Information</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Form fields with responsive styling -->
        <div class="space-y-4 md:col-span-2">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="{{ form.full_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.full_name.label }}</label>
              {{ form.full_name|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
            </div>
            <div>
              <label for="{{ form.passport_photo.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.passport_photo.label }}</label>
              {{ form.passport_photo|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
            </div>
          </div>
        </div>
        
        <div>
          <label for="{{ form.date_of_birth.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.date_of_birth.label }}</label>
          {{ form.date_of_birth|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.gender.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.gender.label }}</label>
          {{ form.gender|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.nationality.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.nationality.label }}</label>
          {{ form.nationality|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
      </div>
    </div>

    <!-- Contact & Location Section -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Contact & Location</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="{{ form.contact.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.contact.label }}</label>
          {{ form.contact|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.district.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.district.label }}</label>
          {{ form.district|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.village.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.village.label }}</label>
          {{ form.village|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
      </div>
    </div>

    <!-- Assessment Info Section -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Assessment Info</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="{{ form.assessment_center.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.assessment_center.label }}</label>
          {{ form.assessment_center|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.entry_year.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.entry_year.label }}</label>
          {{ form.entry_year|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.intake.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.intake.label }}</label>
          {{ form.intake|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.registration_category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.registration_category.label }}</label>
          {{ form.registration_category|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
      </div>
    </div>

    <!-- Disability Section -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Disability</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="{{ form.disability.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.disability.label }}</label>
          {{ form.disability|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div id="nature-of-disability-group" style="display: none;">
          <label for="{{ form.nature_of_disability.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.nature_of_disability.label }}</label>
          {{ form.nature_of_disability|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
      </div>
    </div>

    <!-- Assessment Dates Section -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Assessment Dates</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.start_date.label }}</label>
          {{ form.start_date|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.finish_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.finish_date.label }}</label>
          {{ form.finish_date|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.assessment_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.assessment_date.label }}</label>
          {{ form.assessment_date|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200">
      <a href="{% url 'candidate_list' %}" class="w-full sm:w-auto px-6 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center touch-target">
        Cancel
      </a>
      <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
        Register Candidate
      </button>
    </div>
  </form>
</div>

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var dateFields = [
      'date_of_birth',
      'start_date',
      'finish_date',
      'assessment_date'
    ];
    dateFields.forEach(function(fieldName) {
      var input = document.querySelector('input[name="' + fieldName + '"]');
      if (input) {
        flatpickr(input, {
          dateFormat: "d/m/Y",
          allowInput: true,
          altInput: true,
          altFormat: "d/m/Y"
        });
      }
    });
  });
// --- Dynamic Occupation Filtering ---
document.addEventListener('DOMContentLoaded', function() {
  const regCatField = document.getElementById('id_registration_category');
  const occWrapper = document.getElementById('occupation-field-wrapper');
  const occLoading = document.getElementById('occupation-loading');
  if (!regCatField || !occWrapper) return;
  function setOccupationDisabled(disabled=true) {
    const occField = document.getElementById('id_occupation');
    if (occField) occField.disabled = disabled;
  }
  // Initial state
  if (!regCatField.value) setOccupationDisabled(true);
  regCatField.addEventListener('change', function() {
    const cat = regCatField.value;
    setOccupationDisabled(true);
    occLoading.classList.remove('hidden');
    // Fetch filtered occupations from backend
    const url = new URL(window.location.href);
    url.searchParams.set('registration_category', cat);
    fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(resp => resp.json())
      .then(data => {
        if (data.occupation_field_html) {
          occWrapper.innerHTML = data.occupation_field_html;
        }
      })
      .finally(() => {
        occLoading.classList.add('hidden');
        setOccupationDisabled(false);
      });
  });
});
// --- End Dynamic Occupation Filtering ---

// --- Dynamic Village Filtering ---
document.addEventListener('DOMContentLoaded', function() {
    const districtSelect = document.getElementById('id_district');
    const villageSelect = document.getElementById('id_village');
    const villageLoadingText = "Loading villages...";
    const villageSelectText = "Select a village";
    const villageNoneText = "No villages available";
    const villagePleaseSelectDistrictText = "Select a district first";

    function updateVillageOptions(villages) {
        villageSelect.innerHTML = ''; // Clear existing options

        if (villages === null || villages.length === 0) {
            const option = new Option(villageNoneText, '');
            villageSelect.add(option);
            villageSelect.disabled = true;
            return;
        }

        villageSelect.disabled = false;
        let firstOption = new Option(`--- ${villageSelectText} ---`, '');
        villageSelect.add(firstOption);

        villages.forEach(function(village) {
            const option = new Option(village.name, village.id);
            villageSelect.add(option);
        });
    }

    if (districtSelect && villageSelect) {
        // Set initial state for village dropdown
        if (!districtSelect.value) {
            villageSelect.innerHTML = '';
            const option = new Option(`--- ${villagePleaseSelectDistrictText} ---`, '');
            villageSelect.add(option);
            villageSelect.disabled = true;
        }

        districtSelect.addEventListener('change', function() {
            const districtId = this.value;
            villageSelect.innerHTML = ''; // Clear existing options

            if (districtId) {
                villageSelect.disabled = true;
                const loadingOption = new Option(villageLoadingText, '');
                villageSelect.add(loadingOption);

                // The URL name is 'api_district_villages'
                // In JS, we construct it manually or pass it via a data attribute.
                // Assuming the base URL structure is consistent.
                const urlTemplate = "{% url 'api_district_villages' district_id=0 %}";
                const fetchUrl = urlTemplate.replace('/0/', `/${districtId}/`);
                fetch(fetchUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        updateVillageOptions(data);
                    })
                    .catch(error => {
                        console.error('Error fetching villages:', error);
                        villageSelect.innerHTML = '';
                        const errorOption = new Option('Error loading villages', '');
                        villageSelect.add(errorOption);
                        villageSelect.disabled = true;
                    });
            } else {
                const option = new Option(`--- ${villagePleaseSelectDistrictText} ---`, '');
                villageSelect.add(option);
                villageSelect.disabled = true;
            }
        });

        // Trigger change on load if a district is already selected (e.g. form validation error re-render)
        if (districtSelect.value) {
            districtSelect.dispatchEvent(new Event('change'));
        }
    }
});
// --- End Dynamic Village Filtering ---

// --- Disability/Nature of Disability Dynamic Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const disabilityCheckbox = document.getElementById('id_disability');
    const natureGroup = document.getElementById('nature-of-disability-group');
    function updateNatureVisibility() {
        if (disabilityCheckbox && disabilityCheckbox.checked) {
            natureGroup.style.display = 'block';
        } else {
            natureGroup.style.display = 'none';
        }
    }
    if (disabilityCheckbox && natureGroup) {
        updateNatureVisibility();
        disabilityCheckbox.addEventListener('change', updateNatureVisibility);
    }
});
// --- End Disability/Nature of Disability Dynamic Logic ---

// --- Begin Nature of Disability Required Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const disabilityCheckbox = document.getElementById('id_disability');
    const natureGroup = document.getElementById('nature-of-disability-group');
    const natureRequired = document.getElementById('nature-required');
    const natureCheckboxes = document.querySelectorAll('#nature-checkboxes input[type="checkbox"]');
    const form = document.querySelector('form');
    function updateNatureRequired() {
        if (disabilityCheckbox && disabilityCheckbox.checked) {
            if (natureRequired) natureRequired.style.display = 'inline';
        } else {
            if (natureRequired) natureRequired.style.display = 'none';
        }
    }
    if (disabilityCheckbox && natureRequired) {
        updateNatureRequired();
        disabilityCheckbox.addEventListener('change', updateNatureRequired);
    }
    if (form) {
        form.addEventListener('submit', function(e) {
            if (disabilityCheckbox && disabilityCheckbox.checked) {
                let anyChecked = false;
                natureCheckboxes.forEach(cb => { if (cb.checked) anyChecked = true; });
                if (!anyChecked) {
                    e.preventDefault();
                    alert('Please select at least one Nature of Disability.');
                    // Optionally, scroll to field
                    document.getElementById('nature-of-disability-group').scrollIntoView({behavior:'smooth'});
                }
            }
        });
    }
});
// --- End Nature of Disability Required Logic ---
</script>
{% endblock %}
