{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load country_extras %}

{% block content %}

<!-- Breadcrumb -->
<div class="text-sm text-gray-500 mb-4 px-4 sm:px-0">
    <a href="{% url 'candidate_list' %}" class="text-blue-600 hover:underline">Candidates</a> /
    <span class="text-gray-700">New Candidate</span>
</div>

<div class="max-w-4xl mx-auto mt-6 sm:mt-10 bg-white p-4 sm:p-6 shadow rounded-lg">
  <h1 class="text-xl sm:text-2xl font-normal mb-4 sm:mb-2" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Register New Candidate</h1>

  <!-- Header panel: quick badges + image preview -->
  <div class="mb-4 sm:mb-6 border border-gray-200 rounded-lg p-3 sm:p-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <!-- Left: badges/info -->
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-xs text-gray-500">Registration Number:</span>
        <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-700">/</span>
        <span class="px-2 py-1 text-xs rounded bg-emerald-50 text-emerald-700 border border-emerald-200">0.00 UGX Fees Balance</span>
        {% if current_series %}
          <span class="px-2 py-1 text-xs rounded bg-indigo-50 text-indigo-700 border border-indigo-200">Series: {{ current_series.name }}</span>
        {% endif %}
        <span class="px-2 py-1 text-xs rounded bg-gray-50 text-gray-600 border border-gray-200">Status: New</span>
      </div>
  <style>
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
  </style>
      <!-- Right: image preview and trigger -->
      <div class="flex items-center gap-3">
        <div class="w-28 h-28 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden">
          <img id="candidate-photo-preview" alt="photo preview" class="object-cover w-full h-full hidden" />
          <svg id="candidate-photo-placeholder" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 3a2 2 0 110 4 2 2 0 010-4zm-3 9l2.5-3 1.5 2 2.5-3 3.5 4H4z"/></svg>
        </div>
        <button type="button" id="trigger-photo" class="px-3 py-2 text-sm bg-gray-700 text-white rounded hover:bg-gray-800">Upload Photo</button>
      </div>
    </div>
  </div>

  <!-- Tabs navigation -->
  <div class="border-b border-gray-200 mb-4 overflow-x-auto">
    <nav class="flex gap-2" id="candidate-tabs">
      <a href="#pane-bio" class="tab-link active px-3 py-2 text-sm rounded-t bg-white border border-b-0">Bio Data & General Info</a>
      <a href="#pane-assessment" class="tab-link px-3 py-2 text-sm rounded-t bg-white border border-b-0">Assessment Information</a>
      <a href="#pane-attachments" class="tab-link px-3 py-2 text-sm rounded-t bg-white border border-b-0">Attachments</a>
    </nav>
  </div>
  
  <!-- Keep the actual file input in the DOM but hidden so header Upload Photo works -->
  <div class="hidden">
    {{ form.passport_photo }}
  </div>
  <!-- Hidden paths for draft files persisted on server -->
  <input type="hidden" id="passport_photo_draft_path" name="passport_photo_draft_path" value="{{ draft_data.passport_photo_draft_path|default:'' }}" />
  <input type="hidden" id="identification_document_draft_path" name="identification_document_draft_path" value="{% if draft_data.identification_document_draft_path %}{{ draft_data.identification_document_draft_path }}{% endif %}" />
  <input type="hidden" id="qualification_document_draft_path" name="qualification_document_draft_path" value="{% if draft_data.qualification_document_draft_path %}{{ draft_data.qualification_document_draft_path }}{% endif %}" />

  {% if form.errors %}
    <div class="mb-4">
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
        <strong class="font-bold">Please correct the errors below:</strong>
        <ul class="mt-2 text-sm space-y-1">
          {% for field in form %}
            {% for error in field.errors %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="space-y-6" id="candidate-form">
    {% csrf_token %}
    {% if draft_id %}
      <input type="hidden" id="draft_id" name="draft_id" value="{{ draft_id }}" />
    {% else %}
      <input type="hidden" id="draft_id" name="draft_id" value="" />
    {% endif %}
    
    <!-- Pane: Bio & General -->
    <div id="pane-bio" class="tab-pane active">
    <!-- Personal Information Section -->
    <div id="section-personal" class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Personal Information</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="{{ form.full_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.full_name.label }}{% if form.full_name.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.full_name|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.date_of_birth.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.date_of_birth.label }}{% if form.date_of_birth.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.date_of_birth|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.gender.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.gender.label }}{% if form.gender.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.gender|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.nationality.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.nationality.label }}{% if form.nationality.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.nationality|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <!-- Refugee Status Fields (conditional based on nationality) -->
        <div id="refugee-status-field" style="display: none;">
          <label for="{{ form.is_refugee.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.is_refugee.label }}</label>
          {{ form.is_refugee|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
          {% if form.is_refugee.help_text %}
            <p class="mt-1 text-xs text-gray-500">{{ form.is_refugee.help_text }}</p>
          {% endif %}
        </div>
        
        <div id="refugee-number-field" style="display: none;">
          <label for="{{ form.refugee_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.refugee_number.label }}{% if form.refugee_number.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.refugee_number|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
          {% if form.refugee_number.help_text %}
            <p class="mt-1 text-xs text-gray-500">{{ form.refugee_number.help_text }}</p>
          {% endif %}
        </div>
        
        <!-- Removed visible passport field; handled via header upload -->
      </div>
    </div>

    <!-- Contact & Location Section -->
    <div id="section-contact" class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Contact & Location</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="{{ form.contact.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.contact.label }}{% if form.contact.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.contact|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.district.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Home District{% if form.district.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.district|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.village.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.village.label }}{% if form.village.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.village|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
      </div>
    </div>

    <!-- Disability Section -->
    <div id="section-disability" class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Disability Information</h3>
      <div class="space-y-4">
        <!-- Disability Checkbox - Compact Design -->
        <div class="flex items-center space-x-3">
          <div class="flex items-center">
            <input type="checkbox" id="{{ form.disability.id_for_label }}" name="{{ form.disability.name }}" 
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                   {% if form.disability.value %}checked{% endif %}>
            <label for="{{ form.disability.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700">
              {{ form.disability.label }}
            </label>
          </div>
        </div>
        
        <!-- Nature of Disability - Compact Grid Layout -->
        <div id="nature-of-disability-group" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.nature_of_disability.label }} <span class="text-red-500">*</span></label>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-2">
            {% for choice in form.nature_of_disability %}
              <div class="flex items-center">
                {{ choice.tag }}
                <label for="{{ choice.id_for_label }}" class="ml-2 text-sm text-gray-600">
                  {{ choice.choice_label }}
                </label>
              </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- Disability Specification - Full Width -->
        <div id="disability-specification-group" class="hidden">
          <label for="{{ form.disability_specification.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
            {{ form.disability_specification.label }}
          </label>
          {{ form.disability_specification|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" }}
          <p class="text-xs text-gray-500 mt-1">{{ form.disability_specification.help_text }}</p>
        </div>
      </div>
    </div>

    </div><!-- end pane-bio -->

    <!-- Pane: Assessment -->
    <div id="pane-assessment" class="tab-pane">
    <!-- Assessment Info Section -->
    <div id="section-assessment" class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Assessment Info</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="{{ form.assessment_center.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.assessment_center.label }}{% if form.assessment_center.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {% if is_branch_rep %}
            <!-- Read-only chip showing locked center for branch reps -->
            <div class="px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-700">
              {{ rep_center.center_name }}
            </div>
            <!-- Render field but keep hidden so POST contains correct value -->
            <div class="hidden">{{ form.assessment_center }}</div>
          {% else %}
            {{ form.assessment_center|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
          {% endif %}
        </div>
        
        <div id="branch-field-wrapper" class="{% if is_branch_rep %}block{% else %}hidden{% endif %}">
          <label for="{{ form.assessment_center_branch.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.assessment_center_branch.label }}{% if is_branch_rep and rep_center.has_branches %} <span class="text-red-500">*</span>{% endif %}</label>
          {% if is_branch_rep %}
            {% if rep_center.has_branches %}
              <div class="px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-700">
                {% if rep_branch %}
                  {{ rep_branch.branch_code }}
                {% else %}
                  Main Center (no specific branch)
                {% endif %}
              </div>
            {% else %}
              <div class="px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-500">This center has no branches</div>
            {% endif %}
            <!-- Keep field in DOM but hidden to preserve POST and disabled state from form -->
            <div class="hidden">{{ form.assessment_center_branch }}</div>
            <span id="branch-loading" class="text-xs text-gray-500 hidden">Loading branches...</span>
            <p id="branch-help-text" class="text-xs text-gray-500 mt-1">Your account is locked to this branch.</p>
          {% else %}
            {{ form.assessment_center_branch|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
            <span id="branch-loading" class="text-xs text-gray-500 hidden">Loading branches...</span>
            <p id="branch-help-text" class="text-xs text-gray-500 mt-1">Select the branch for this candidate</p>
          {% endif %}
        </div>
        
        <div>
          <label for="{{ form.entry_year.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.entry_year.label }}{% if form.entry_year.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.entry_year|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.intake.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.intake.label }}{% if form.intake.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.intake|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.registration_category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.registration_category.label }}{% if form.registration_category.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.registration_category|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div id="occupation-field-wrapper" class="md:col-span-2">
          <label for="{{ form.occupation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.occupation.label }}{% if form.occupation.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.occupation|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
          <span id="occupation-loading" class="text-xs text-gray-500 hidden">Loading...</span>
        </div>

        <!-- Preferred Assessment Language -->
        <div class="md:col-span-1">
          <label for="{{ form.preferred_assessment_language.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Preferred assessment language</label>
          {{ form.preferred_assessment_language|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
          <p class="text-xs text-gray-500 mt-1">Optional. Defaults to English if left blank.</p>
        </div>
      </div>
    </div>

    <!-- Assessment Dates Section -->
    <div id="section-dates" class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Assessment Dates</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.start_date.label }}{% if form.start_date.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.start_date|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.finish_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.finish_date.label }}{% if form.finish_date.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.finish_date|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
        
        <div>
          <label for="{{ form.assessment_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.assessment_date.label }}{% if form.assessment_date.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ form.assessment_date|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-target" }}
        </div>
      </div>
    </div>

    </div><!-- end pane-assessment -->

    <!-- Pane: Attachments -->
    <div id="pane-attachments" class="tab-pane">
    <!-- Relevant Documents Section (Optional) -->
    <div id="section-docs" class="bg-gray-50 p-4 rounded-lg">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Relevant Documents </h3>
      <p class="text-sm text-gray-600 mb-4">Attach supporting documents. Accepted formats: PNG, JPG, PDF</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="{{ form.identification_document.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            {{ form.identification_document.label }}
          </label>
          <p class="text-xs text-gray-500 mb-2">National ID, Birth Certificate, or other identification</p>
          {{ form.identification_document|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" }}
          <p class="text-sm text-green-600 font-medium mt-2" id="id-doc-status" style="display:none;">✓ Document uploaded and saved</p>
          {% if form.identification_document.errors %}
            <div class="text-red-600 text-sm mt-1">
              {{ form.identification_document.errors }}
            </div>
          {% endif %}
        </div>
        
        <div>
          <label for="{{ form.qualification_document.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            {{ form.qualification_document.label }}
          </label>
          <p class="text-xs text-gray-500 mb-2">Relevant qualifications (for Full Occupation candidates)</p>
          {{ form.qualification_document|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" }}
          <p class="text-sm text-green-600 font-medium mt-2" id="qual-doc-status" style="display:none;">✓ Document uploaded and saved</p>
          {% if form.qualification_document.errors %}
            <div class="text-red-600 text-sm mt-1">
              {{ form.qualification_document.errors }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row justify-between gap-3 pt-4 border-t border-gray-200 items-center">
      <div id="draft-status" class="text-xs text-gray-500 hidden"></div>
      <a id="cancel-btn" href="{% url 'candidate_list' %}" class="w-full sm:w-auto px-6 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center touch-target">
        Cancel
      </a>
      <div class="flex gap-2">
        <button type="button" id="save-draft" class="w-full sm:w-auto px-6 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
          Save as Draft
        </button>
        <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
          Register Candidate
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var dateFields = [
      'date_of_birth',
      'start_date',
      'finish_date',
      'assessment_date'
    ];
    dateFields.forEach(function(fieldName) {
      var input = document.querySelector('input[name="' + fieldName + '"]');
      if (input) {
        flatpickr(input, {
          dateFormat: "d/m/Y",
          allowInput: true,
          altInput: true,
          altFormat: "d/m/Y"
        });
      }
    });
  });

  // --- Save as Draft + Autosave (never create a draft unless user explicitly clicks Save as Draft) ---
  (function(){
    const saveBtn = document.getElementById('save-draft');
    const form = document.getElementById('candidate-form');
    const draftIdEl = document.getElementById('draft_id');
    const statusEl = document.getElementById('draft-status');
    const cancelBtn = document.getElementById('cancel-btn');
    if (!form) return;

    // If there is no draft id, autosave is disabled. It will only be enabled after the
    // user explicitly clicks "Save as Draft" (first click creates the draft).
    let autosaveEnabled = Boolean(draftIdEl && draftIdEl.value);

    function formToJSON(form){
      const data = {};
      const fd = new FormData(form);
      fd.forEach((v,k)=>{
        // Skip file inputs in autosave payload
        if (v instanceof File) {
          return;
        }
        if (data[k] !== undefined){
          if (!Array.isArray(data[k])) data[k] = [data[k]];
          data[k].push(v);
        } else {
          data[k] = v;
        }
      });
      if (draftIdEl && draftIdEl.value) data['draft_id'] = draftIdEl.value;
      return data;
    }

    let saving = false;
    async function saveDraft(force=false){
      if (saving) return; // prevent overlap
      saving = true;
      const payload = formToJSON(form);
      // Do not create a draft from autosave if none exists yet
      if (!force && !(draftIdEl && draftIdEl.value)) {
        saving = false;
        return;
      }
      try{
        const r = await fetch('{% url "save_candidate_draft" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
          },
          body: JSON.stringify(payload)
        });
        const res = await r.json();
        if (res && res.success){
          if (draftIdEl) draftIdEl.value = res.draft_id;
          
          // Move temp file paths to proper draft ID keys in localStorage
          const tempIdDoc = localStorage.getItem('temp_id_doc_path');
          const tempQualDoc = localStorage.getItem('temp_qual_doc_path');
          if (tempIdDoc) {
            localStorage.setItem('draft_id_doc_' + res.draft_id, tempIdDoc);
            localStorage.removeItem('temp_id_doc_path');
            console.log('Moved ID doc to draft key:', res.draft_id);
          }
          if (tempQualDoc) {
            localStorage.setItem('draft_qual_doc_' + res.draft_id, tempQualDoc);
            localStorage.removeItem('temp_qual_doc_path');
            console.log('Moved Qual doc to draft key:', res.draft_id);
          }
          
          // Once the user has explicitly saved once, enable autosave from now on
          autosaveEnabled = true;
          if (statusEl){
            statusEl.textContent = 'Draft saved';
            statusEl.classList.remove('hidden');
            setTimeout(()=>statusEl.classList.add('hidden'), 3000);
          }
          const url = new URL(window.location.href);
          url.searchParams.set('draft', res.draft_id);
          window.history.replaceState({}, '', url);
        }
      }catch(e){
        console.error('Save draft error', e);
      } finally {
        saving = false;
      }
    }

    // Manual save button
    if (saveBtn){
      saveBtn.addEventListener('click', function(e){
        e.preventDefault();
        // Force a save that can create a new draft if one doesn't exist yet
        saveDraft(true);
      });
    }

    // Proxy buttons in sticky bar
    const saveProxy = document.getElementById('save-draft-proxy');
    const cancelProxy = document.getElementById('cancel-proxy');
    const submitProxy = document.getElementById('submit-proxy');
    const cancelReal = document.getElementById('cancel-btn');
    if (saveProxy) saveProxy.addEventListener('click', function(e){ e.preventDefault(); if (saveBtn) saveBtn.click(); });
    if (cancelProxy && cancelReal) cancelProxy.addEventListener('click', function(e){ e.preventDefault(); cancelReal.click(); });
    if (submitProxy) submitProxy.addEventListener('click', function(e){ e.preventDefault(); form.requestSubmit(); });

    // Debounced autosave on changes
    let debounceTimer = null;
    function scheduleAutosave(){
      if (debounceTimer) clearTimeout(debounceTimer);
      if (!autosaveEnabled) return;
      debounceTimer = setTimeout(function(){ saveDraft(false); }, 1500);
    }
    form.addEventListener('input', scheduleAutosave, true);
    form.addEventListener('change', scheduleAutosave, true);

    // Periodic autosave safeguard every 25s
    const periodic = setInterval(function(){ if (autosaveEnabled) saveDraft(false); }, 25000);

    // If user clicks Cancel, disable any pending autosave and do not attempt to create drafts
    if (cancelBtn){
      cancelBtn.addEventListener('click', function(){
        autosaveEnabled = false;
        if (debounceTimer) clearTimeout(debounceTimer);
        clearInterval(periodic);
      });
    }
  })();
// --- Dynamic Occupation Filtering ---
document.addEventListener('DOMContentLoaded', function() {
  const regCatField = document.getElementById('id_registration_category');
  const occWrapper = document.getElementById('occupation-field-wrapper');
  const occLoading = document.getElementById('occupation-loading');
  if (!regCatField || !occWrapper) return;
  function setOccupationDisabled(disabled=true) {
    const occField = document.getElementById('id_occupation');
    if (occField) occField.disabled = disabled;
  }
  function loadOccupationsForCategory(cat) {
    if (!cat) {
      setOccupationDisabled(true);
      return;
    }
    setOccupationDisabled(true);
    if (occLoading) occLoading.classList.remove('hidden');
    const url = new URL(window.location.href);
    url.searchParams.set('registration_category', cat);
    fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(function(resp){ return resp.json(); })
      .then(function(data){
        if (data && data.occupation_field_html) {
          occWrapper.innerHTML = data.occupation_field_html;
        }
      })
      .catch(function(err){ console.error('Occupation load error', err); })
      .finally(function(){
        if (occLoading) occLoading.classList.add('hidden');
        setOccupationDisabled(false);
      });
  }
  // Initial state
  if (!regCatField.value) {
    setOccupationDisabled(true);
  } else {
    // If a category is already selected on load, populate occupations immediately
    loadOccupationsForCategory(regCatField.value);
  }
  regCatField.addEventListener('change', function() {
    loadOccupationsForCategory(regCatField.value);
  });
});
// --- End Dynamic Occupation Filtering ---

// --- Dynamic Village Filtering ---
document.addEventListener('DOMContentLoaded', function() {
    const districtSelect = document.getElementById('id_district');
    const villageSelect = document.getElementById('id_village');
    const villageLoadingText = "Loading villages...";
    const villageSelectText = "Select a village";
    const villageNoneText = "No villages available";
    const villagePleaseSelectDistrictText = "Select a district first";

    function updateVillageOptions(villages) {
        villageSelect.innerHTML = ''; // Clear existing options

        if (villages === null || villages.length === 0) {
            const option = new Option(villageNoneText, '');
            villageSelect.add(option);
            villageSelect.disabled = true;
            return;
        }

        villageSelect.disabled = false;
        let firstOption = new Option(`--- ${villageSelectText} ---`, '');
        villageSelect.add(firstOption);

        villages.forEach(function(village) {
            const option = new Option(village.name, village.id);
            villageSelect.add(option);
        });
    }

    if (districtSelect && villageSelect) {
        // Store the initial village value from draft
        const initialVillageValue = villageSelect.value;
        console.log('Initial village value from draft:', initialVillageValue);
        
        // Set initial state for village dropdown
        if (!districtSelect.value) {
            villageSelect.innerHTML = '';
            const option = new Option(`--- ${villagePleaseSelectDistrictText} ---`, '');
            villageSelect.add(option);
            villageSelect.disabled = true;
        } else if (initialVillageValue) {
            // If district is set and village has a value, trigger district change to load villages
            console.log('Triggering district change to load villages for draft');
            districtSelect.dispatchEvent(new Event('change'));
        }

        districtSelect.addEventListener('change', function() {
            const districtId = this.value;
            villageSelect.innerHTML = ''; // Clear existing options

            if (districtId) {
                villageSelect.disabled = true;
                const loadingOption = new Option(villageLoadingText, '');
                villageSelect.add(loadingOption);

                // The URL name is 'api_district_villages'
                // In JS, we construct it manually or pass it via a data attribute.
                // Assuming the base URL structure is consistent.
                const urlTemplate = "{% url 'api_district_villages' district_id=0 %}";
                const fetchUrl = urlTemplate.replace('/0/', `/${districtId}/`);
                fetch(fetchUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        updateVillageOptions(data);
                        // Restore village value if it was set from draft
                        if (initialVillageValue) {
                            villageSelect.value = initialVillageValue;
                            console.log('Restored village value:', initialVillageValue);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching villages:', error);
                        villageSelect.innerHTML = '';
                        const errorOption = new Option('Error loading villages', '');
                        villageSelect.add(errorOption);
                        villageSelect.disabled = true;
                    });
            } else {
                const option = new Option(`--- ${villagePleaseSelectDistrictText} ---`, '');
                villageSelect.add(option);
                villageSelect.disabled = true;
            }
        });

        // Trigger change on load if a district is already selected (e.g. form validation error re-render)
        if (districtSelect.value) {
            districtSelect.dispatchEvent(new Event('change'));
        }
    }
});
// --- End Dynamic Village Filtering ---

// --- Disability/Nature of Disability Dynamic Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const disabilityCheckbox = document.getElementById('id_disability');
    const natureGroup = document.getElementById('nature-of-disability-group');
    const specificationGroup = document.getElementById('disability-specification-group');
    
    function updateNatureVisibility() {
        if (disabilityCheckbox && disabilityCheckbox.checked) {
            natureGroup.classList.remove('hidden');
            natureGroup.classList.add('block');
            specificationGroup.classList.remove('hidden');
            specificationGroup.classList.add('block');
        } else {
            natureGroup.classList.add('hidden');
            natureGroup.classList.remove('block');
            specificationGroup.classList.add('hidden');
            specificationGroup.classList.remove('block');
        }
    }
    if (disabilityCheckbox && natureGroup) {
        updateNatureVisibility();
        disabilityCheckbox.addEventListener('change', updateNatureVisibility);
    }
});
// --- End Disability/Nature of Disability Dynamic Logic ---

// --- Begin Nature of Disability Required Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const disabilityCheckbox = document.getElementById('id_disability');
    const natureGroup = document.getElementById('nature-of-disability-group');
    const natureRequired = document.getElementById('nature-required');
    const natureCheckboxes = document.querySelectorAll('#nature-checkboxes input[type="checkbox"]');
    const form = document.querySelector('form');
    function updateNatureRequired() {
        if (disabilityCheckbox && disabilityCheckbox.checked) {
            if (natureRequired) natureRequired.style.display = 'inline';
        } else {
            if (natureRequired) natureRequired.style.display = 'none';
        }
    }
    if (disabilityCheckbox && natureRequired) {
        updateNatureRequired();
        disabilityCheckbox.addEventListener('change', updateNatureRequired);
    }
    if (form) {
        form.addEventListener('submit', function(e) {
            if (disabilityCheckbox && disabilityCheckbox.checked) {
                let anyChecked = false;
                natureCheckboxes.forEach(cb => { if (cb.checked) anyChecked = true; });
                if (!anyChecked) {
                    e.preventDefault();
                    alert('Please select at least one Nature of Disability.');
                    // Optionally, scroll to field
                    document.getElementById('nature-of-disability-group').scrollIntoView({behavior:'smooth'});
                }
            }
        });
    }
});
// --- End Nature of Disability Required Logic ---

// --- Begin Assessment Center Branch Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const assessmentCenterSelect = document.getElementById('id_assessment_center');
    const branchFieldWrapper = document.getElementById('branch-field-wrapper');
    const branchSelect = document.getElementById('id_assessment_center_branch');
    const branchLoading = document.getElementById('branch-loading');
    const branchHelpText = document.getElementById('branch-help-text');
    
    function updateBranchField() {
        const centerId = assessmentCenterSelect.value;
        
        if (!centerId) {
            // No center selected, hide branch field
            branchFieldWrapper.classList.add('hidden');
            branchSelect.innerHTML = '<option value="">Select branch</option>';
            return;
        }
        
        // Show loading state
        branchLoading.classList.remove('hidden');
        branchHelpText.classList.add('hidden');
        
        // Fetch center details to check if it has branches
        fetch(`/eims/api/assessment-centers/${centerId}/branches/`)
            .then(response => response.json())
            .then(data => {
                branchLoading.classList.add('hidden');
                
                if (data.has_branches && data.branches && data.branches.length > 0) {
                    // Center has branches, show the field and populate options
                    branchFieldWrapper.classList.remove('hidden');
                    branchSelect.innerHTML = '<option value="">Main Center (no specific branch)</option>';
                    
                    data.branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = `${branch.branch_code} - ${branch.village_name}`;
                        branchSelect.appendChild(option);
                    });
                    
                    branchHelpText.textContent = 'This center has branches. Select a specific branch or leave blank for main center.';
                    branchHelpText.classList.remove('hidden');
                    branchSelect.required = false;  // Make optional to allow main center assignment
                } else {
                    // Center doesn't have branches, hide the field
                    branchFieldWrapper.classList.add('hidden');
                    branchSelect.innerHTML = '<option value="">Main Center (no specific branch)</option>';
                    branchSelect.required = false;
                    branchSelect.value = '';
                }
            })
            .catch(error => {
                console.error('Error fetching branches:', error);
                branchLoading.classList.add('hidden');
                branchHelpText.textContent = 'Error loading branches. Please try again.';
                branchHelpText.classList.remove('hidden');
                branchFieldWrapper.classList.add('hidden');
            });
    }
    
    // Listen for assessment center changes
    if (assessmentCenterSelect) {
        assessmentCenterSelect.addEventListener('change', updateBranchField);
        
        // Check initial state if center is already selected
        if (assessmentCenterSelect.value) {
            updateBranchField();
        }
    }
});
// --- End Assessment Center Branch Logic ---

// --- Name Formatting Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const fullNameField = document.getElementById('id_full_name');
    
    function formatName(name) {
        if (!name) return name;
        
        // Split the name into parts
        const nameParts = name.trim().split(/\s+/);
        if (nameParts.length === 0) return name;
        
        // Format: First part (surname) in UPPERCASE, rest in sentence case
        const formattedParts = nameParts.map((part, index) => {
            if (index === 0) {
                // First part (surname) - all uppercase
                return part.toUpperCase();
            } else {
                // Other parts - sentence case (first letter upper, rest lower)
                return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
            }
        });
        
        return formattedParts.join(' ');
    }
    
    if (fullNameField) {
        // Format on blur (when user finishes typing)
        fullNameField.addEventListener('blur', function() {
            const formatted = formatName(this.value);
            if (formatted !== this.value) {
                this.value = formatted;
            }
        });
        
        // Also format on form submission to ensure consistency
        const form = fullNameField.closest('form');
        if (form) {
            form.addEventListener('submit', function() {
                const formatted = formatName(fullNameField.value);
                if (formatted !== fullNameField.value) {
                    fullNameField.value = formatted;
                }
            });
        }
        
        // Show formatting hint
        const nameLabel = document.querySelector('label[for="id_full_name"]');
        if (nameLabel && !nameLabel.querySelector('.name-format-hint')) {
            const hint = document.createElement('span');
            hint.className = 'name-format-hint text-xs text-gray-500 ml-2';
            hint.textContent = '(Format: SURNAME Other Names)';
            nameLabel.appendChild(hint);
        }
    }
});
// --- End Name Formatting Logic ---

// --- Begin Refugee Status Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const nationalitySelect = document.getElementById('id_nationality');
    const refugeeStatusField = document.getElementById('refugee-status-field');
    const refugeeNumberField = document.getElementById('refugee-number-field');
    const isRefugeeSelect = document.getElementById('id_is_refugee');
    
    function updateRefugeeFields() {
        const nationality = nationalitySelect.value;
        
        console.log('Nationality selected:', nationality); // Debug log
        
        // Show refugee status field only if nationality is not Uganda
        // Check for both country code 'UG' and country name 'Uganda'
        if (nationality && nationality !== 'UG' && nationality !== 'Uganda' && nationality !== '') {
            console.log('Showing refugee field for:', nationality); // Debug log
            refugeeStatusField.style.display = 'block';
            
            // Check if refugee status is selected
            const isRefugee = isRefugeeSelect.value;
            if (isRefugee === 'True') {
                refugeeNumberField.style.display = 'block';
            } else {
                refugeeNumberField.style.display = 'none';
                // Clear refugee number if not a refugee
                const refugeeNumberInput = document.getElementById('id_refugee_number');
                if (refugeeNumberInput) {
                    refugeeNumberInput.value = '';
                }
            }
        } else {
            console.log('Hiding refugee field for Uganda or empty selection'); // Debug log
            // Hide both refugee fields if nationality is Uganda (UG) or not selected
            refugeeStatusField.style.display = 'none';
            refugeeNumberField.style.display = 'none';
            
            // Clear refugee fields
            if (isRefugeeSelect) {
                isRefugeeSelect.value = '';
            }
            const refugeeNumberInput = document.getElementById('id_refugee_number');
            if (refugeeNumberInput) {
                refugeeNumberInput.value = '';
            }
        }
    }
    
    function updateRefugeeNumberField() {
        const isRefugeeValue = isRefugeeSelect.value;
        // Show refugee_number field only if is_refugee is True
        if (isRefugeeValue === 'True' || isRefugeeValue === true || isRefugeeValue === 'true') {
            refugeeNumberField.style.display = 'block';
        } else {
            refugeeNumberField.style.display = 'none';
            // Clear refugee number if not a refugee
            const refugeeNumberInput = document.getElementById('id_refugee_number');
            if (refugeeNumberInput) {
                refugeeNumberInput.value = '';
            }
        }
    }
    
    if (nationalitySelect && refugeeStatusField && refugeeNumberField && isRefugeeSelect) {
        // Initial state check
        updateRefugeeFields();
        
        // Listen for nationality changes
        nationalitySelect.addEventListener('change', updateRefugeeFields);
        
        // Listen for refugee status changes
        isRefugeeSelect.addEventListener('change', updateRefugeeNumberField);
    }
});
// --- End Refugee Status Logic ---

// --- Tab Switching, Image Preview, Upload-on-Select, Draft Restore ---
document.addEventListener('DOMContentLoaded', function() {
  // Tab switching
  const tabs = document.querySelectorAll('#candidate-tabs .tab-link');
  const panes = document.querySelectorAll('.tab-pane');
  tabs.forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      // Hide all panes
      panes.forEach(p => p.classList.remove('active'));
      // Show target pane
      const targetPane = document.getElementById(targetId);
      if (targetPane) targetPane.classList.add('active');
      // Update tab styling
      tabs.forEach(t => t.classList.remove('border-b-white', 'font-medium'));
      this.classList.add('border-b-white', 'font-medium');
    });
  });

  const fileInput = document.getElementById('id_passport_photo');
  const triggerBtn = document.getElementById('trigger-photo');
  const previewImg = document.getElementById('candidate-photo-preview');
  const placeholder = document.getElementById('candidate-photo-placeholder');
  const draftPathInput = document.getElementById('passport_photo_draft_path');

  // Restore draft photo on load
  const draftPhotoUrl = "{{ draft_photo_url|default:'' }}";
  const draftId = document.getElementById('draft_id').value;
  
  console.log('=== DRAFT PHOTO RESTORE ===');
  console.log('Draft ID:', draftId);
  console.log('Draft photo URL from backend:', draftPhotoUrl);
  console.log('Draft path input value:', draftPathInput ? draftPathInput.value : 'N/A');
  
  // Try localStorage first (most reliable)
  if (draftId && previewImg) {
    const storedUrl = localStorage.getItem('draft_photo_url_' + draftId);
    const storedPath = localStorage.getItem('draft_photo_' + draftId);
    console.log('LocalStorage URL:', storedUrl);
    console.log('LocalStorage path:', storedPath);
    
    if (storedUrl) {
      console.log('Using localStorage URL');
      previewImg.src = storedUrl;
      previewImg.classList.remove('hidden');
      if (placeholder) placeholder.classList.add('hidden');
      if (draftPathInput && storedPath) draftPathInput.value = storedPath;
      return; // Exit early
    }
  }
  
  // Fallback to backend URL
  if (draftPhotoUrl && previewImg) {
    console.log('Using backend URL');
    previewImg.src = draftPhotoUrl;
    previewImg.classList.remove('hidden');
    if (placeholder) placeholder.classList.add('hidden');
  } else if (draftPathInput && draftPathInput.value && previewImg) {
    // Fallback: construct URL from path if backend didn't provide URL
    const mediaUrl = "{{ MEDIA_URL|default:'/media/' }}";
    const photoUrl = mediaUrl + draftPathInput.value;
    console.log('Using constructed URL:', photoUrl);
    previewImg.src = photoUrl;
    previewImg.classList.remove('hidden');
    if (placeholder) placeholder.classList.add('hidden');
  } else {
    console.log('No photo to restore');
  }


  if (triggerBtn && fileInput) {
    triggerBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', function(){
      const file = this.files && this.files[0];
      if (!file) { return; }
      const valid = ['image/jpeg','image/png','image/jpg'];
      if (valid.indexOf(file.type) === -1) { return; }

      // Upload immediately to server for draft persistence
      const fd = new FormData();
      fd.append('passport_photo', file);
      fd.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);
      fetch('{% url "upload_candidate_photo_draft" %}', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.success && draftPathInput) {
            draftPathInput.value = data.path;
            // Store in localStorage as backup
            const draftId = document.getElementById('draft_id').value;
            if (draftId) {
              localStorage.setItem('draft_photo_' + draftId, data.path);
              localStorage.setItem('draft_photo_url_' + draftId, data.url);
            }
          }
        })
        .catch(e => console.error('Photo upload error', e));

      // Local preview
      const reader = new FileReader();
      reader.onload = function(e){
        previewImg.src = e.target.result;
        previewImg.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    });
  }

  // Upload-on-select for identification document
  const idDocInput = document.getElementById('id_identification_document');
  const idDocPathInput = document.getElementById('identification_document_draft_path');
  const idDocStatus = document.getElementById('id-doc-status');
  
  // Restore from localStorage on load
  if (draftId && idDocPathInput && idDocStatus) {
    const storedPath = localStorage.getItem('draft_id_doc_' + draftId);
    console.log('ID Doc - Draft ID:', draftId);
    console.log('ID Doc - Stored path:', storedPath);
    console.log('ID Doc - Status element:', idDocStatus);
    if (storedPath) {
      idDocPathInput.value = storedPath;
      idDocStatus.style.display = 'block';
      console.log('ID Doc - Status shown');
    }
  }
  
  if (idDocInput) {
    // Show status if already uploaded
    if (idDocPathInput && idDocPathInput.value && idDocStatus) {
      idDocStatus.style.display = 'block';
    }
    idDocInput.addEventListener('change', function() {
      const file = this.files && this.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('passport_photo', file); // reuse same endpoint
      fd.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);
      fetch('{% url "upload_candidate_photo_draft" %}', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.success && idDocPathInput) {
            idDocPathInput.value = data.path;
            if (idDocStatus) idDocStatus.style.display = 'block';
            // Store in localStorage with temp key, will update with draft ID later
            localStorage.setItem('temp_id_doc_path', data.path);
            console.log('ID doc uploaded, temp stored:', data.path);
          }
        })
        .catch(e => console.error('ID doc upload error', e));
    });
  }

  // Upload-on-select for qualification document
  const qualDocInput = document.getElementById('id_qualification_document');
  const qualDocPathInput = document.getElementById('qualification_document_draft_path');
  const qualDocStatus = document.getElementById('qual-doc-status');
  
  // Restore from localStorage on load
  if (draftId && qualDocPathInput && qualDocStatus) {
    const storedPath = localStorage.getItem('draft_qual_doc_' + draftId);
    if (storedPath) {
      qualDocPathInput.value = storedPath;
      qualDocStatus.style.display = 'block';
    }
  }
  
  if (qualDocInput) {
    // Show status if already uploaded
    if (qualDocPathInput && qualDocPathInput.value && qualDocStatus) {
      qualDocStatus.style.display = 'block';
    }
    qualDocInput.addEventListener('change', function() {
      const file = this.files && this.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('passport_photo', file); // reuse same endpoint
      fd.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);
      fetch('{% url "upload_candidate_photo_draft" %}', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.success && qualDocPathInput) {
            qualDocPathInput.value = data.path;
            if (qualDocStatus) qualDocStatus.style.display = 'block';
            // Store in localStorage with temp key, will update with draft ID later
            localStorage.setItem('temp_qual_doc_path', data.path);
            console.log('Qual doc uploaded, temp stored:', data.path);
          }
        })
        .catch(e => console.error('Qual doc upload error', e));
    });
  }

  // Unsaved-changes guard (skip when form successfully submits)
  const candidateForm = document.getElementById('candidate-form');
  let dirty = false;
  if (candidateForm) {
    candidateForm.addEventListener('input', () => { dirty = true; }, true);
    candidateForm.addEventListener('change', () => { dirty = true; }, true);
    candidateForm.addEventListener('submit', () => { dirty = false; });
  }
  window.addEventListener('beforeunload', function (e) {
    if (!dirty) return;
    e.preventDefault();
    e.returnValue = '';
  });
});
// --- End Tabs, Image Preview, Unsaved-Changes Guard ---
</script>
{% endblock %}
