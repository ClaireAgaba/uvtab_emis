{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto mt-12 bg-white shadow-lg p-8 rounded">
  <h2 class="text-xl font-bold mb-5">
    {% if edit_mode %}Edit Marks for{% else %}Add Marks for{% endif %} {{ candidate.full_name }}
  </h2>
  <form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="mb-4">
      <label class="block font-semibold mb-1">Assessment Series</label>
      <select name="assessment_series" class="border rounded px-3 py-2 w-full" required>
        <option value="">Select Assessment Series</option>
        {% for series in assessment_series %}
          <option value="{{ series.id }}" 
                  {% if candidate.assessment_series and series.id == candidate.assessment_series.id %}selected{% endif %}
                  {% if not candidate.assessment_series and series.is_current %}selected{% endif %}>
            {{ series.name }}
            {% if series.is_current %} (Current){% endif %}
          </option>
        {% endfor %}
      </select>
      <div class="text-sm text-gray-600 mt-1">Current candidate series: {{ candidate.assessment_series.name|default:"No series assigned" }}</div>
    </div>
    {% if is_worker_pas %}
      <table class="min-w-full mb-6 border border-gray-300">
        <thead>
          <tr class="bg-gray-100">
            <th class="py-2 px-4 text-left">Paper</th>
            <th class="py-2 px-4 text-left">Module</th>
            <th class="py-2 px-4 text-left">Mark (Practical)</th>
          </tr>
        </thead>
        <tbody>
          {% for paper, mark_field in paper_mark_fields %}
            <tr>
              <td class="py-2 px-4">{{ paper.code }} - {{ paper.name }}</td>
              <td class="py-2 px-4">{{ paper.module.name }}</td>
              <td class="py-2 px-4">
                {{ mark_field }}
                {% for error in mark_field.errors %}
                  <div class="text-red-600 text-xs">{{ error }}</div>
                {% endfor %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% elif is_modular %}
      <table class="min-w-full mb-6 border border-gray-300">
        <thead>
          <tr class="bg-gray-100">
            <th class="py-2 px-4 text-left">Module</th>
            <th class="py-2 px-4 text-left">Mark (Practical)</th>
          </tr>
        </thead>
        <tbody>
          {% for module, mark_field in module_mark_fields %}
            <tr>
              <td class="py-2 px-4">{{ module.code }} - {{ module.name }}</td>
              <td class="py-2 px-4">{{ mark_field }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% elif is_paper_based %}
      <table class="min-w-full mb-6 border border-gray-300">
        <thead>
          <tr class="bg-gray-100">
            <th class="py-2 px-4 text-left">Paper</th>
            <th class="py-2 px-4 text-left">Assessment Type</th>
            <th class="py-2 px-4 text-left">Mark</th>
          </tr>
        </thead>
        <tbody>
          {% for paper, mark_field in paper_mark_fields %}
            <tr>
              <td class="py-2 px-4">{{ paper.code }} - {{ paper.name }}</td>
              <td class="py-2 px-4">{{ paper.grade_type|title }}</td>
              <td class="py-2 px-4">
                {{ mark_field }}
                {% for error in mark_field.errors %}
                  <div class="text-red-600 text-xs">{{ error }}</div>
                {% endfor %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="mb-6 p-4 border border-gray-300 rounded bg-gray-50">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block font-semibold mb-1">Assessment Month</label>
            {{ form.month }}
            {% for error in form.month.errors %}
              <div class="text-red-600 text-xs">{{ error }}</div>
            {% endfor %}
          </div>
          <div>
            <label class="block font-semibold mb-1">Assessment Year</label>
            {{ form.year }}
            {% for error in form.year.errors %}
              <div class="text-red-600 text-xs">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
        <div class="mb-4">
          <label class="block font-semibold mb-1">Theory Mark (Combined for Level)</label>
          {{ form.theory_mark }}
          {% for error in form.theory_mark.errors %}
            <div class="text-red-600 text-xs">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="mb-4">
          <label class="block font-semibold mb-1">Practical Mark (Combined for Level)</label>
          {{ form.practical_mark }}
          {% for error in form.practical_mark.errors %}
            <div class="text-red-600 text-xs">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    <div class="mt-6 flex justify-between">
      <a href="{% url 'candidate_view' candidate.id %}" class="text-gray-600 hover:underline">Cancel</a>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Marks</button>
    </div>
  </form>
</div>
{% endblock %}
