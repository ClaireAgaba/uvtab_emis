{% extends 'base.html' %}
{% load static %}
{% load enrollment_extras %}
{% load country_extras %}

{% if request.user.is_superuser %}
  <pre>
    DEBUG: level_has_results = {{ level_has_results|pprint }}
    DEBUG: enrollment_summary = {{ enrollment_summary|pprint }}
  </pre>
{% endif %}
<pre>
DEBUG: level_has_results in context? {{ level_has_results }}
DEBUG: enrollment_summary in context? {{ enrollment_summary }}
</pre>
{% block content %}

<!-- Candidate Portal Navigation -->
{% if is_candidate_portal %}
<nav class="bg-blue-800 text-white shadow-md">
    <div class="px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <!-- Logo/Brand -->
            <div class="flex-shrink-0">
                <div class="flex items-center">
                    <img src="{% static 'images/uvtab_logo.png' %}" alt="UVTAB Logo" class="w-8 h-8 mr-3">
                    <span class="text-xl font-semibold">UVTAB Candidate Portal</span>
                </div>
            </div>
            
            <!-- Candidate Info and Logout -->
            <div class="flex items-center space-x-4">
                <span class="text-blue-200 text-sm">
                    Welcome, {{ candidate.full_name }}
                </span>
                <a href="{% url 'candidate_portal_logout' %}" 
                   class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium transition">
                    Logout
                </a>
            </div>
        </div>
    </div>
</nav>
{% endif %}

<!-- Breadcrumb -->
<div class="text-sm text-gray-500 mb-4 flex items-center justify-between">
    <div>
        {% if is_candidate_portal %}
            <span class="text-blue-600">Candidate Portal</span> /
            <span class="text-gray-700">{{ candidate.full_name }}</span>
        {% elif request.GET.from == 'results' %}
            <a href="{% url 'results_home' %}" class="text-blue-600 hover:underline">Results</a> /
            <span class="text-gray-700">{{ candidate.full_name }}</span>
        {% else %}
            <a href="{% url 'candidate_list' %}" class="text-blue-600 hover:underline">Candidates</a> /
            <span class="text-gray-700">{{ candidate.full_name }}</span>
        {% endif %}
    </div>
    <div>
        {% if is_candidate_portal %}
            <a href="{% url 'candidate_portal_logout' %}" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                </svg>
                Logout
            </a>
        {% elif request.GET.from == 'results' %}
            <a href="{% url 'results_home' %}" class="inline-flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Results
            </a>
        {% else %}
            {% if request.GET.return_to == 'enrollment_list' %}
                <a href="{% url 'enrollment_list' %}{% if request.GET.page %}?page={{ request.GET.page }}{% endif %}{% if request.GET.reg_number %}&reg_number={{ request.GET.reg_number }}{% endif %}{% if request.GET.name %}&name={{ request.GET.name }}{% endif %}{% if request.GET.center %}&center={{ request.GET.center }}{% endif %}{% if request.GET.occupation %}&occupation={{ request.GET.occupation }}{% endif %}{% if request.GET.assessment_series %}&assessment_series={{ request.GET.assessment_series }}{% endif %}{% if request.GET.registration_category %}&registration_category={{ request.GET.registration_category }}{% endif %}{% if request.GET.has_marks %}&has_marks={{ request.GET.has_marks }}{% endif %}" class="inline-flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-sm transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back to Enrollments
                </a>
            {% else %}
                <a href="{% url 'candidate_list' %}" class="inline-flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded text-sm transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back to Candidates
                </a>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="max-w-7xl w-full mx-auto mt-6 space-y-6">

  <!-- Candidate Portal Welcome Message -->
  {% if is_candidate_portal %}
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="flex items-center">
      <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div>
        <h3 class="text-lg font-semibold text-blue-800">Welcome to Your Candidate Portal</h3>
        <p class="text-blue-700 text-sm mt-1">
          View your assessment information and results below. 
          {% if not results_released %}
            <span class="font-medium">Results will be available once officially released by UVTAB.</span>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-normal mb-1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">{{ candidate.full_name }}</h1>
      <span class="text-lg text-gray-500 font-mono" data-field="reg_number">{{ candidate.reg_number }}</span>
    </div>
    <div class="flex flex-wrap gap-3 mt-2 md:mt-0 items-center">
      {% comment %}
      Hide enroll button for formal candidates who are already enrolled in a level
      since formal candidates can only belong to one level
      Also hide enroll buttons for candidate portal
      {% endcomment %}
      {% if not is_candidate_portal %}
        {% if is_center_rep %}
          {% comment %} For centers: lock Enroll for Modular if any modules already enrolled; and for Formal if a level already enrolled {% endcomment %}
          {% if candidate.registration_category == 'Modular' and candidate.candidatemodule_set.all|length > 0 %}
            <span class="flex items-center gap-2 bg-gray-400 text-white px-4 py-2 rounded shadow cursor-not-allowed" title="Center cannot enroll after modules have been added">
               Enroll (Locked)
            </span>
          {% elif candidate.registration_category == 'Formal' and candidate.candidatelevel_set.exists %}
            <span class="flex items-center gap-2 bg-gray-400 text-white px-4 py-2 rounded shadow cursor-not-allowed" title="Formal candidates can only enroll in one level">
               Already Enrolled
            </span>
          {% else %}
            <a href="{% url 'enroll_candidate' candidate.id %}" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition" title="Enroll candidate">
               Enroll
            </a>
          {% endif %}
        {% else %}
          {% if candidate.registration_category != 'Formal' or not candidate.candidatelevel_set.exists %}
          <a href="{% url 'enroll_candidate' candidate.id %}" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition" title="Enroll candidate">
             Enroll
          </a>
          {% else %}
          <!-- Formal candidate already enrolled - show disabled button with explanation -->
          <span class="flex items-center gap-2 bg-gray-400 text-white px-4 py-2 rounded shadow cursor-not-allowed" title="Formal candidates can only enroll in one level">
             Already Enrolled
          </span>
          {% endif %}
        {% endif %}
      {% endif %}
      <!-- Hide edit/testimonial buttons for candidate portal -->
      {% if not is_candidate_portal %}
        <!-- Edit button - conditional based on verification status and user role -->
        {% if is_center_rep %}
          {% if candidate.verification_status == 'verified' %}
            <!-- Verified candidates cannot be edited by center representatives -->
            <span class="flex items-center gap-2 bg-gray-400 text-white px-4 py-2 rounded shadow cursor-not-allowed" title="Cannot edit verified candidate">
              Edit (Locked)
            </span>
          {% else %}
            <!-- Pending or declined candidates can be edited by center representatives -->
            <a href="{% url 'edit_candidate' candidate.id %}" class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded shadow transition" title="Edit candidate">
              Edit
            </a>
          {% endif %}
          <!-- Testimonial button for center users -->
          <a href="{% url 'generate_testimonial' candidate.id %}" class="flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded shadow transition" title="Download testimonial">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Testimonial
          </a>
        {% else %}
          <!-- Admin/staff can always edit -->
          <a href="{% url 'edit_candidate' candidate.id %}" class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded shadow transition" title="Edit candidate">
            Edit
          </a>
        {% endif %}
      {% endif %}
      {% if not is_center_rep and not is_candidate_portal %}
      <form method="post" action="{% url 'regenerate_candidate_reg_number' candidate.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to regenerate the registration number? This cannot be undone.');" data-admin-only>
        {% csrf_token %}
        <button type="submit" class="regenerate-btn flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow transition" data-admin-only title="Regenerate registration number">
          Regenerate Reg. Number
        </button>
      </form>
      {% if candidate.passport_photo %}
      <button id="addRegnoOnPhotoBtn" type="button" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow transition" data-admin-only title="Add Regno on Photo">
        Add Regno on Photo
      </button>
      <span id="addRegnoOnPhotoStatus" class="ml-2 text-sm text-gray-500"></span>
      {% endif %}
      
      <!-- Verification Button (Admin only) -->
      {% if not is_center_rep and not is_candidate_portal %}
      {% if candidate.verification_status == 'pending' %}
      <button id="verifyBtn" type="button" class="verify-btn flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded shadow transition" data-admin-only title="Verify candidate">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Verify
      </button>
      {% elif candidate.verification_status == 'verified' %}
      <button id="declineBtn" type="button" class="decline-btn flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow transition" data-admin-only title="Decline candidate">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Decline
      </button>
      {% elif candidate.verification_status == 'declined' %}
      <button id="verifyBtn" type="button" class="verify-btn flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded shadow transition" data-admin-only title="Verify candidate">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Verify
      </button>
      {% endif %}
      
      <!-- Transcript Button - Only for formal/modular candidates who have passed all papers -->
      {% if can_generate_transcript %}
      <a href="{% url 'generate_transcript' candidate.id %}" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow transition" title="Download transcript">
         Print Transcript
      </a>
      {% elif candidate.registration_category == 'Formal' %}
      <!-- Disabled transcript button for formal candidates who haven't passed all papers -->
      <span class="flex items-center gap-2 bg-gray-400 text-white px-4 py-2 rounded shadow cursor-not-allowed" title="Cannot generate transcript - candidate has failed papers (Ms/CTR)">
         Print Transcript (Disabled)
      </span>
      {% endif %}
      
      <a href="{% url 'generate_verified_results' candidate.id %}" class="flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow transition" title="Download verified results">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
         </svg>
         Verified Results
      </a>
      
      <!-- Certificate Button - Only for formal/modular candidates who have passed all papers -->
      {% if can_generate_certificate %}
      <a href="#" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow transition" title="View certificate">
         Certificate
      </a>
      {% elif candidate.registration_category == 'Formal' %}
      <!-- Disabled certificate button for formal candidates who haven't passed all papers -->
      <span class="flex items-center gap-2 bg-gray-400 text-white px-4 py-2 rounded shadow cursor-not-allowed" title="Cannot generate certificate - candidate has failed papers (Ms/CTR)">
         Certificate (Disabled)
      </span>
      {% endif %}
      {% endif %}
      {% endif %}
      <!-- Action Dropdown (Hidden from center representatives and candidate portal) -->
      {% if not is_center_rep and not is_candidate_portal %}
      <div class="relative inline-block text-left ml-2">
        <button id="actionDropdownBtn" type="button" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded shadow transition focus:outline-none" aria-haspopup="true" aria-expanded="false">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
          Action
        </button>
        <div id="actionDropdownMenu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
          <div class="py-1">
            {% if not candidate.is_enrolled %}

            {% endif %}
            <a href="#" id="changeCenterAction" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Change Assessment Center</a>
            <a href="#" id="changeOccupationAction" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Change Occupation</a>
            <a href="#" id="changeRegCatAction" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Change Registration Category</a>

            
          </div>
        </div>
      </div>
      {% endif %}
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const btn = document.getElementById('actionDropdownBtn');
          const menu = document.getElementById('actionDropdownMenu');
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            menu.classList.toggle('hidden');
          });
          document.addEventListener('click', function(e) {
            if (!menu.classList.contains('hidden')) {
              menu.classList.add('hidden');
            }
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var regnoBtn = document.getElementById('addRegnoOnPhotoBtn');
          var regnoStatus = document.getElementById('addRegnoOnPhotoStatus');
          var regnoImgId = 'regnoStampedImg';
          if (regnoBtn) {
            regnoBtn.addEventListener('click', function() {
              regnoStatus.innerText = 'Generating...';
              regnoBtn.disabled = true;
              fetch("{% url 'add_regno_to_photo' candidate.id %}", {
                method: 'POST',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}',
                  'X-Requested-With': 'XMLHttpRequest',
                },
              })
              .then(resp => resp.json())
              .then(data => {
                regnoBtn.disabled = false;
                if (data.success && data.url) {
                  // Find the main candidate photo img and update its src
                  var photoDiv = regnoBtn.closest('.grid').querySelector('.flex.flex-col.items-center.justify-center.relative');
                  var mainImg = photoDiv.querySelector('img');
                  if (mainImg) {
                    // Add fade-out, update src, then fade-in
                    mainImg.style.transition = 'opacity 0.2s';
                    mainImg.style.opacity = 0.2;
                    setTimeout(function() {
                      mainImg.src = data.url + '?t=' + new Date().getTime();
                      mainImg.onload = function() {
                        mainImg.style.opacity = 1;
                      };
                    }, 150);
                  }
                  // Remove any additional regno-stamped image if present
                  var oldStamped = photoDiv.querySelector('#regnoStampedImg');
                  if (oldStamped && oldStamped !== mainImg) oldStamped.remove();
                  regnoStatus.innerText = 'Done!';
                  setTimeout(function() { regnoStatus.innerText = ''; }, 1200);
                } else {
                  regnoStatus.innerText = data.error || 'Failed.';
                }
              })
              .catch(() => {
                regnoBtn.disabled = false;
                regnoStatus.innerText = 'Failed.';
                setTimeout(function() { regnoStatus.innerText = ''; }, 2000);
              });
            });
          }
        });
      </script>
      
      <!-- Verification System JavaScript -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const verifyBtn = document.getElementById('verifyBtn');
          const declineBtn = document.getElementById('declineBtn');
          
          // Verify button handler
          if (verifyBtn) {
            verifyBtn.addEventListener('click', function() {
              // Show confirmation dialog
              const confirmed = confirm('Are you sure you want to VERIFY this candidate?\n\nClick OK to verify or Cancel to decline.');
              
              if (confirmed) {
                // User clicked OK - Verify
                verifyCandidate();
              } else {
                // User clicked Cancel - Show decline reason dialog
                const reason = prompt('Please provide a reason for declining this candidate:');
                if (reason && reason.trim()) {
                  declineCandidate(reason.trim());
                }
              }
            });
          }
          
          // Decline button handler (for already verified candidates)
          if (declineBtn) {
            declineBtn.addEventListener('click', function() {
              const reason = prompt('Please provide a reason for declining this candidate:');
              if (reason && reason.trim()) {
                declineCandidate(reason.trim());
              }
            });
          }
          
          function verifyCandidate() {
            fetch("{% url 'verify_candidate' candidate.id %}", {
              method: 'POST',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
              },
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('Candidate verified successfully!');
                location.reload(); // Refresh page to show updated status
              } else {
                alert('Error: ' + (data.error || 'Failed to verify candidate'));
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while verifying the candidate.');
            });
          }
          
          function declineCandidate(reason) {
            const formData = new FormData();
            formData.append('decline_reason', reason);
            
            fetch("{% url 'decline_candidate' candidate.id %}", {
              method: 'POST',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('Candidate declined successfully.');
                location.reload(); // Refresh page to show updated status
              } else {
                alert('Error: ' + (data.error || 'Failed to decline candidate'));
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while declining the candidate.');
            });
          }
        });
      </script>
    </div>
  </div>

  {% if request.user.is_superuser or request.user.is_staff %}
  <!-- Activity Log Sidebar (visible on large screens) -->
  <aside class="hidden lg:block float-right w-96 ml-6 mt-2 sticky top-24">
    <div class="bg-white p-4 rounded shadow">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Activity Log</h2>
        <span class="text-xs text-gray-500">Most recent 50</span>
      </div>
      {% if change_logs %}
        <div class="overflow-y-auto max-h-[70vh] pr-1">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-gray-600 border-b">
                <th class="py-2 pr-3">When</th>
                <th class="py-2 pr-3">User</th>
                <th class="py-2 pr-3">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for log in change_logs %}
                <tr class="border-b last:border-0 align-top">
                  <td class="py-2 pr-3 whitespace-nowrap text-gray-700">{{ log.created_at|date:"Y-m-d H:i" }}</td>
                  <td class="py-2 pr-3 whitespace-nowrap">{{ log.performed_by.username|default:"System" }}</td>
                  <td class="py-2 pr-3">
                    <div class="font-medium">{{ log.get_action_display }}</div>
                    <div class="text-gray-600 text-xs whitespace-pre-wrap break-words">{{ log.details|default:"(no details)" }}</div>
                    <div class="text-gray-400 text-[10px] mt-1">IP: {{ log.ip_address|default:"-" }}</div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-sm text-gray-500">No activity recorded yet.</div>
      {% endif %}
    </div>
  </aside>
  {% endif %}

  <!-- Summary Info + Photo -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8 bg-white p-8 rounded-xl shadow-lg">
    <!-- Info -->
    <div class="md:col-span-2 space-y-2">
      <div class="grid grid-cols-2 gap-x-8 gap-y-2">
        <p><span class="font-semibold text-gray-700">Gender:</span> 
          {% if candidate.gender == 'M' %}
            Male
          {% elif candidate.gender == 'F' %}
            Female
          {% else %}
            {{ candidate.gender }}
          {% endif %}
        </p>
        <p><span class="font-semibold text-gray-700">Date of Birth:</span> {{ candidate.date_of_birth }}</p>
        <p><span class="font-semibold text-gray-700">Nationality:</span> {{ candidate.nationality|country_name }}</p>
        <p><span class="font-semibold text-gray-700">Contact:</span> {{ candidate.contact }}</p>
        <p><span class="font-semibold text-gray-700">Assessment Center:</span> <span data-field="assessment_center">{{ candidate.assessment_center.center_name }}</span>
          {% if candidate.assessment_center_branch %}
            <br><span class="text-sm text-gray-600">Branch: <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800" data-field="assessment_center_branch">{{ candidate.assessment_center_branch.branch_code }}</span></span>
          {% elif candidate.assessment_center.has_branches %}
            <br><span class="text-sm text-gray-600">Branch: <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">Main Center</span></span>
          {% endif %}
        </p>
        <p><span class="font-semibold text-gray-700">Occupation:</span> <span data-field="occupation">{{ candidate.occupation.name }}</span></p>
        <p><span class="font-semibold text-gray-700">Registration Category:</span> <span data-field="registration_category">{{ candidate.registration_category }}</span></p>
        {% if candidate.registration_category == 'Formal' %}
          <p><span class="font-semibold text-gray-700">Level:</span> {% if level_enrollment %}{{ level_enrollment.level.name }}{% else %}<span class="text-gray-400">-</span>{% endif %}</p>
        {% endif %}
        <p><span class="font-semibold text-gray-700">Entry Year:</span> {{ candidate.entry_year }}</p>
        <p><span class="font-semibold text-gray-700">Intake:</span> {{ candidate.intake }}</p>
        <p><span class="font-semibold text-gray-700">Registration Number:</span> <span data-field="reg_number">{{ candidate.reg_number }}</span></p>
        <p><span class="font-semibold text-gray-700">Fees Balance:</span> 
          <span class="{% if candidate.fees_balance > 0 %}text-red-600 font-semibold{% else %}text-green-600{% endif %}">
            UGX {{ candidate.get_formatted_fees_balance }}
          </span>
        </p>
        <p><span class="font-semibold text-gray-700">Invoice Status:</span> 
          {% comment %}
          Logic: 
          - If candidate has any fees_balance > 0, they have an unpaid invoice
          - If candidate has fees_balance = 0 but has enrollments (any type), they have a paid invoice
          - If no enrollments and no fees = No Invoice Set
          {% endcomment %}
          {% if candidate.fees_balance > 0 %}
            <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
              <svg class="w-3 h-3 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
              Unpaid Invoice
            </span>
          {% elif candidate.fees_balance == 0 and level_enrollment or module_enrollments %}
            <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
              <svg class="w-3 h-3 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Paid Invoice
            </span>
          {% else %}
            <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600">
              <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              No Invoice Set
            </span>
          {% endif %}
        </p>
        
        <!-- Decline Reason (if candidate is declined) -->
        {% if candidate.verification_status == 'declined' and candidate.decline_reason %}
        <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm">
            <span class="font-semibold text-red-800">Reason for Decline:</span>
            <span class="text-red-700 ml-2">{{ candidate.decline_reason }}</span>
          </p>
          <p class="text-xs text-red-600 mt-1">
            Please address the above issue and save your changes for re-verification.
          </p>
        </div>
        {% endif %}
      </div>
    </div>
    <!-- Image + Badge -->
    <div class="flex flex-col items-center justify-center relative">
      {# Show regno-stamped photo if available, else fallback to original, else show No photo #}
      {% if candidate.passport_photo_with_regno %}
        <img src="{{ candidate.passport_photo_with_regno.url }}" alt="Candidate Photo with Regno" style="max-width: 160px; max-height: 160px; border-radius: 8px; border: 2px solid #e0e7ef;">
      {% elif candidate.passport_photo %}
        <img src="{{ candidate.passport_photo.url }}" alt="Candidate Photo" style="max-width: 160px; max-height: 160px; border-radius: 8px; border: 2px solid #e0e7ef;">
      {% else %}
        <div class="w-56 h-56 bg-gray-100 flex items-center justify-center rounded-lg shadow-lg border-2 border-gray-200">
          <span class="text-gray-400 text-lg">No photo</span>
        </div>
      {% endif %}
      
      <!-- Verification Status Diagonal Banner -->
      {% if candidate.verification_status == 'verified' %}
        <div class="absolute top-0 right-0 w-20 h-20 overflow-hidden">
          <div class="absolute top-3 -right-6 bg-green-500 text-white text-xs font-bold px-8 py-1 transform rotate-45 shadow-lg">
            VERIFIED
          </div>
        </div>
      {% elif candidate.verification_status == 'declined' %}
        <div class="absolute top-0 right-0 w-20 h-20 overflow-hidden">
          <div class="absolute top-3 -right-6 bg-red-500 text-white text-xs font-bold px-8 py-1 transform rotate-45 shadow-lg">
            DECLINED
          </div>
        </div>
      {% endif %}
      
      {% if candidate.is_enrolled %}
        <div class="absolute top-2 left-2 bg-green-600 text-white text-xs font-bold px-3 py-1 rounded shadow">
          Registered
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Bio Data (always visible, now after header/summary) -->
  <div class="bg-white p-4 rounded shadow mt-4">
    <h2 class="text-lg font-semibold mb-2"> General Information </h2>
    <p><strong>Village:</strong> {{ candidate.village.name }}</p>
    <p><strong>District:</strong> {{ candidate.district.name }}</p>
    <p><strong>Start Date:</strong> {{ candidate.start_date }}</p>
    <p><strong>Finish Date:</strong> {{ candidate.finish_date }}</p>
    <p><strong>Assessment Date:</strong> {{ candidate.assessment_date }}</p>
    {% if candidate.disability %}
      <p><strong>Disability:</strong> Yes</p>
      <p><strong>Nature of Disability:</strong>
        {% if candidate.nature_of_disability.all|length > 0 %}
          {% for nature in candidate.nature_of_disability.all %}
            <span class="inline-block bg-gray-200 rounded px-2 py-1 text-xs mr-1">{{ nature.name }}</span>
          {% endfor %}
        {% else %}
          <span class="text-gray-500">Not specified</span>
        {% endif %}
      </p>
      {% if candidate.disability_specification %}
        <p><strong class="text-gray-800">Disability Details:</strong></p>
        <div class="bg-purple-50 border-l-4 border-purple-800 p-3 mt-2 rounded-r-md max-w-2xl">
          <div class="text-sm text-gray-700 break-words">
            {{ candidate.disability_specification|linebreaks }}
          </div>
        </div>
      {% endif %}
    {% else %}
      <p><strong>Disability:</strong> No</p>
    {% endif %}
    
    <!-- Refugee Status -->
    {% if candidate.is_refugee %}
      <p><strong>Refugee Status:</strong> Yes</p>
      {% if candidate.refugee_number %}
        <p><strong>Refugee Number:</strong> {{ candidate.refugee_number }}</p>
      {% endif %}
    {% else %}
      <p><strong>Refugee Status:</strong> No</p>
    {% endif %}
  </div>

  <!-- Relevant Documents Section -->
  {% if candidate.identification_document or candidate.qualification_document %}
  <div class="bg-white p-4 rounded shadow mt-4">
    <div class="flex items-center mb-4">
      <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      <h2 class="text-lg font-semibold text-gray-900">Relevant Documents</h2>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% if candidate.identification_document %}
      <div class="border rounded-lg p-4 bg-gray-50">
        <h3 class="font-medium text-gray-800 mb-2">Identification Document</h3>
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            {% if candidate.identification_document.name|slice:"-4:" == ".pdf" %}
              <svg class="w-6 h-6 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
              </svg>
            {% else %}
              <svg class="w-6 h-6 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
            {% endif %}
            <span class="text-sm text-gray-700 truncate max-w-xs">{{ candidate.identification_document.name|slice:"50:" }}</span>
          </div>
          <a href="{% url 'serve_candidate_document' candidate_id=candidate.id document_type='identification' %}" target="_blank" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            View
          </a>
        </div>
      </div>
      {% endif %}
      
      {% if candidate.qualification_document %}
      <div class="border rounded-lg p-4 bg-gray-50">
        <h3 class="font-medium text-gray-800 mb-2">Qualification Document</h3>
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            {% if candidate.qualification_document.name|slice:"-4:" == ".pdf" %}
              <svg class="w-6 h-6 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
              </svg>
            {% else %}
              <svg class="w-6 h-6 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
            {% endif %}
            <span class="text-sm text-gray-700 truncate max-w-xs">{{ candidate.qualification_document.name|slice:"50:" }}</span>
          </div>
          <a href="{% url 'serve_candidate_document' candidate_id=candidate.id document_type='qualification' %}" target="_blank" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            View
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Enrollment Summary -->
<div class="bg-white p-4 rounded shadow mt-4">
    <div class="flex items-center justify-between mb-2">
  <h2 class="text-lg font-semibold">Enrollment</h2>
  {% if not is_candidate_portal and not is_center_rep %}
  {% if request.user.is_superuser or request.user.is_staff %}
    <div class="flex flex-col items-end max-w-md w-full">
      <div class="flex flex-wrap gap-2 justify-end w-full">
        <form method="post" action="{% url 'clear_enrollment' candidate.id %}" class="inline-block m-0">
          {% csrf_token %}
          <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" onclick="return confirm('Are you sure you want to clear all enrollment for this candidate? This cannot be undone.');">
            Clear Enrollment
          </button>
        </form>
        <form method="post" action="{% url 'clear_enrollment_and_results' candidate.id %}" class="inline-block m-0">
          {% csrf_token %}
          <button type="submit" class="bg-red-700 hover:bg-red-800 text-white px-3 py-1 rounded text-sm" onclick="return confirm('WARNING: This will clear ALL enrollment records AND ALL results for this candidate. This action cannot be undone.\n\nProceed?');">
            Clear Enrollment and Results
          </button>
        </form>
      </div>
      <p class="mt-2 text-xs text-gray-600 text-right max-w-md">
        <span class="font-semibold">Clear Enrollment</span> removes enrollments only (preserves Modular billing & assessment series).
        <br/>
        <span class="font-semibold">Clear Enrollment and Results</span> also removes results and resets billing & assessment series for a clean restart.
      </p>
    </div>
  {% endif %}
  {% endif %}
</div>

  <!-- Assessment Series Information -->
  <div class="mb-4 p-3 bg-gray-50 rounded border-l-4 border-purple-500">
    <div class="flex items-center mb-2">
      <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
      </svg>
      <h3 class="font-semibold text-gray-800">Assessment Series</h3>
    </div>
    {% if candidate.assessment_series %}
      <p class="text-sm">
        <span class="font-medium text-purple-700">{{ candidate.assessment_series.name }}</span>
        {% if candidate.assessment_series.is_current %}
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 ml-2">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Current
          </span>
        {% endif %}
      </p>
      <p class="text-xs text-gray-600 mt-1">
        Period: {{ candidate.assessment_series.start_date|date:"M d, Y" }} - {{ candidate.assessment_series.end_date|date:"M d, Y" }}
      </p>
    {% else %}
      <p class="text-sm text-orange-600">
        Not enrolled in any assessment series
      </p>
    {% endif %}
  </div>
  
    {% if candidate.registration_category == 'Formal' and level_enrollment %}
      <div class="mb-3">
        <h4 class="font-medium text-gray-700 mb-1">Enrolled in:</h4>
        <p class="text-sm bg-blue-50 p-2 rounded">{{ level_enrollment.level.name }}</p>
      </div>
  
    {% elif candidate.registration_category == 'Informal' or candidate.registration_category == "Worker's PAS" or candidate.registration_category == 'Workers PAS' %}
      {% if enrollment_history and enrollment_history|length > 0 %}
        {% for enrollment in enrollment_history %}
          <div class="mb-3 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
            <div class="flex items-center justify-between mb-2">
              <span class="font-semibold text-blue-800">{{ enrollment.series_name }}</span>
              <span class="text-sm text-blue-600">{{ enrollment.level.name }}</span>
            </div>
            {% if enrollment.modules and enrollment.modules|length > 0 %}
              <ul class="list-disc ml-4 space-y-1">
                {% for mod in enrollment.modules %}
                  <li class="text-sm">
                    <span class="font-medium">{{ mod.module.name }}</span>
                    {% if mod.papers and mod.papers|length > 0 %}
                      <ul class="list-circle ml-4 mt-1">
                        {% for paper in mod.papers %}
                          <li class="text-xs text-gray-600">{{ paper.name }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-gray-400 text-xs">No modules selected.</span>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <span class="text-gray-400 text-xs">No enrollment history for this candidate.</span>
      {% endif %}
    {% elif candidate.registration_category == 'Modular' %}
      {% if module_enrollments %}
        <p>Enrolled in {{ module_enrollments.count }} Module{{ module_enrollments.count|pluralize }}</p>
        <ul class="list-disc ml-6">
          {% for enrollment in module_enrollments %}
            <li>{{ enrollment.module.name }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No modules selected.</p>
      {% endif %}
  
    {% else %}
      <p>Not enrolled yet.</p>
    {% endif %}
  </div>
  
  <!-- Modular Enrollment Section (for Modular candidates only) -->
  {% if candidate.registration_category == 'Modular' %}
  <div class="bg-white p-4 rounded shadow mt-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold flex items-center">
        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
        </svg>
        Module Enrollment Progress
      </h2>
      
      <!-- Qualification Status -->
      {% if candidate.is_qualified_for_level_1 %}
      <div class="bg-green-100 border border-green-400 text-green-700 px-3 py-2 rounded-lg flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="font-semibold">Candidate qualified for Level 1</span>
      </div>
      {% endif %}
    </div>
    
    <!-- Progress Overview -->
    {% with completion_status=candidate.get_modular_completion_status %}
    {% if completion_status %}
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-gray-700">Overall Progress</span>
        <span class="text-sm text-gray-600">{{ completion_status.passed_modules }}/{{ completion_status.total_modules }} modules completed</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div class="bg-green-600 h-2 rounded-full progress-bar" data-width="{{ completion_status.completion_percentage|floatformat:0 }}"></div>
      </div>
      <div class="mt-2 text-xs text-gray-600">
        {{ completion_status.completion_percentage|floatformat:1 }}% complete
        {% if completion_status.remaining_modules > 0 %}
          â€¢ {{ completion_status.remaining_modules }} module(s) remaining
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% endwith %}
    
    {% comment %}
    Module enrollment details are already shown in the main Enrollment section above.
    This section focuses only on progress tracking and qualification status.
    {% endcomment %}
    
    {% comment %}
    Available modules and enrollment constraints are handled in the enrollment form.
    This section focuses only on progress tracking.
    {% endcomment %}
  </div>
  {% endif %}
  
  <!-- Results Section -->
  {% if not results_released %}
    <!-- Results Not Released Message (Only shown to center representatives) -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">
            Results Not Yet Released
          </h3>
        </div>
      </div>
    </div>
  {% else %}
  {% if candidate.registration_category == 'Informal' or candidate.registration_category == "Worker's PAS" or candidate.registration_category == 'Workers PAS' %}
    {% if results_summary and results_summary|length > 0 %}
      {% for lvl in results_summary %}
        <div class="bg-white p-4 rounded shadow mt-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Results for {{ lvl.level.name }}</h2>
            {% if request.user.is_superuser or user_department == 'Admin' or user_department == 'IT' or user_department == 'Data' %}
              {% if level_has_results|get_item:lvl.level.id|stringformat:"s" %}
                {% if request.user.is_superuser or user_department == 'Admin' or user_department == 'IT' %}
                  <a href="{% url 'edit_result' candidate.id %}?level={{ lvl.level.id }}" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">Edit Marks</a>
                {% else %}
                  <button class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled title="Only IT and Admin can edit marks">Edit Marks</button>
                {% endif %}
              {% elif lvl.modules and lvl.modules|length > 0 %}
                <a href="{% url 'add_result' candidate.id %}?level={{ lvl.level.id }}" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Add Marks</a>
              {% else %}
                <button class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled title="Candidate is not enrolled">Add Marks</button>
                <span class="text-red-600 text-sm ml-2">Candidate is not enrolled. Please enroll candidate to add marks.</span>
              {% endif %}
            {% endif %}
          </div>
          <table class="min-w-full mb-4 border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="py-2 px-4 text-left">Assessment Series</th>
                <th class="py-2 px-4 text-left">Level</th>
                <th class="py-2 px-4 text-left">Module</th>
                <th class="py-2 px-4 text-left">Paper</th>
                <th class="py-2 px-4 text-left">Type</th>
                <th class="py-2 px-4 text-left">Assessment</th>
                <th class="py-2 px-4 text-left">Mark</th>
                <th class="py-2 px-4 text-left">Grade</th>
                <th class="py-2 px-4 text-left">Comment</th>
                <th class="py-2 px-4 text-left">Status</th>
                <th class="py-2 px-4 text-left">Assessment Series</th>

                
                <th class="py-2 px-4 text-left">User</th>
              </tr>
            </thead>
            <tbody>
              {% for result in results %}
                {% if result.level_id == lvl.level.id %}
                  <tr>
                    <td class="py-2 px-4">{{ result.assessment_series.name|default:"No Series" }}</td>
                    <td class="py-2 px-4">{{ result.level.name }}</td>
                    <td class="py-2 px-4">{{ result.module.name }}</td>
                    <td class="py-2 px-4">{{ result.paper.name }}</td>
                    <td class="py-2 px-4">{{ result.paper.type|capfirst }}</td>
                    <td class="py-2 px-4">{{ result.assessment_type }}</td>
                    <td class="py-2 px-4">
                      {% if is_center_rep or is_candidate_portal %}
                        <span class="text-green-600 font-medium">Uploaded</span>
                      {% else %}
                        {{ result.mark }}
                      {% endif %}
                    </td>
                    <td class="py-2 px-4">
                      {% if result.grade == 'Ms' or result.grade == 'F' %}
                        <span class="text-red-600 font-semibold">{{ result.grade }}</span>
                      {% else %}
                        {{ result.grade }}
                      {% endif %}
                    </td>
                    <td class="py-2 px-4">
                      {% if result.comment == 'Missing' or result.comment == 'Fail' %}
                        <span class="font-bold text-red-600">{{ result.comment }}</span>
                      {% elif result.comment == 'CTR' %}
                        <span class="font-bold text-orange-600">{{ result.comment }}</span>
                      {% else %}
                        {{ result.comment }}
                      {% endif %}
                    </td>
                    <td class="py-2 px-4">{{ result.status }}</td>
                    <td class="py-2 px-4">{{ result.created|date:"Y-m-d H:i" }}</td>
                    <td class="py-2 px-4">{{ result.user.username }}</td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="12" class="text-center text-gray-400">No results for this level.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    {% else %}
      <div class="bg-white p-4 rounded shadow mt-4 text-gray-400">No results for this candidate.</div>
    {% endif %}
  {% else %}
    <div class="bg-white p-4 rounded shadow mt-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Results</h2>
        {% if request.user.is_superuser or user_department == 'Admin' or user_department == 'IT' or user_department == 'Data' %}
          {% if candidate.registration_category == 'Informal' or candidate.registration_category == "Worker's PAS" or candidate.registration_category == 'Workers PAS' %}
            {% if results and results.count %}
              {% if request.user.is_superuser or user_department == 'Admin' or user_department == 'IT' %}
                <a href="{% url 'edit_result' candidate.id %}" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">Edit Marks</a>
              {% else %}
                <button class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled title="Only IT and Admin can edit marks">Edit Marks</button>
              {% endif %}
            {% else %}
              <a href="{% url 'add_result' candidate.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Add Marks</a>
            {% endif %}
          {% elif candidate.registration_category == 'Modular' %}
            {% if results and results.count %}
              {% if request.user.is_superuser or user_department == 'Admin' or user_department == 'IT' %}
                <a href="{% url 'edit_result' candidate.id %}" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">Edit Marks</a>
              {% else %}
                <button class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled title="Only IT and Admin can edit marks">Edit Marks</button>
              {% endif %}
            {% elif module_enrollments.count > 0 %}
              <a href="{% url 'add_result' candidate.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Add Marks</a>
            {% else %}
              <button class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled title="Candidate is not enrolled">Add Marks</button>
              <span class="text-red-600 text-sm ml-2">Candidate is not enrolled. Please enroll candidate to add marks.</span>
            {% endif %}
          {% else %}
            {% if results and results.count %}
              {% if request.user.is_superuser or user_department == 'Admin' or user_department == 'IT' %}
                <a href="{% url 'edit_result' candidate.id %}" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">Edit Marks</a>
              {% else %}
                <button class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled title="Only IT and Admin can edit marks">Edit Marks</button>
              {% endif %}
            {% elif level_enrollment %}
              <a href="{% url 'add_result' candidate.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Add Marks</a>
            {% else %}
              <button class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled title="Candidate is not enrolled">Add Marks</button>
              <span class="text-red-600 text-sm ml-2">Candidate is not enrolled. Please enroll candidate to add marks.</span>
            {% endif %}
          {% endif %}
        {% else %}
          <button class="bg-blue-300 text-white px-3 py-1 rounded text-sm cursor-not-allowed" disabled>Add Marks</button>
        {% endif %}
    </div>
    {% if results and results.count %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border border-gray-200 rounded">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-3 py-2 border">Assessment Series</th>
              <th class="px-3 py-2 border">Level</th>
              <th class="px-3 py-2 border">Module</th>
              <th class="px-3 py-2 border">Paper</th>
              <th class="px-3 py-2 border">Type</th>
              <th class="px-3 py-2 border">Assessment</th>
              <th class="px-3 py-2 border">Mark</th>
              <th class="px-3 py-2 border">Grade</th>
              <th class="px-3 py-2 border">Comment</th>
              <th class="px-3 py-2 border">Status</th>
              <th class="px-3 py-2 border">Assessment Series</th>
              <th class="px-3 py-2 border">User</th>
            </tr>
          </thead>
          <tbody>
            {% for result in results %}
            <tr>
              <td class="px-3 py-2 border">{{ result.assessment_series.name|default:"No Series" }}</td>
              <td class="px-3 py-2 border">
                {% if result.level %}
                  {{ result.level.name }}
                {% elif level_enrollment %}
                  {{ level_enrollment.level.name }}
                {% else %}
                  <span class="text-gray-400">â€”</span>
                {% endif %}
              </td>
              <td class="px-3 py-2 border">
                 {% if result.paper %}
                   {{ result.paper.code }} - {{ result.paper.name }}
                 {% elif result.module %}
                   {{ result.module.code }} - {{ result.module.name }}
                 {% else %}
                   &mdash;
                 {% endif %}
               </td>
               <td class="px-3 py-2 border">
                 {% if result.paper %}
                   {{ result.paper.grade_type|title }}
                 {% else %}
                   &mdash;
                 {% endif %}
               </td>
               <td class="px-3 py-2 border">{{ result.get_result_type_display }}</td>
               <td class="px-3 py-2 border">{{ result.get_assessment_type_display }}</td>
               <td class="px-3 py-2 border">
                  {% if is_center_rep or is_candidate_portal %}
                    <span class="text-green-600 font-medium">Uploaded</span>
                  {% else %}
                    {{ result.mark }}
                  {% endif %}
                </td>
               <td class="px-3 py-2 border">
                 {% if result.grade == 'Ms' or result.grade == 'F' %}
                   <span class="text-red-600 font-semibold">{{ result.grade }}</span>
                 {% else %}
                   {{ result.grade }}
                 {% endif %}
               </td>
               <td class="px-3 py-2 border">
                 {% if result.comment == 'Missing' or result.comment == 'Fail' %}
                   <span class="font-bold text-red-600">{{ result.comment }}</span>
                 {% elif result.comment == 'CTR' %}
                   <span class="font-bold text-orange-600">{{ result.comment }}</span>
                 {% else %}
                   {{ result.comment }}
                 {% endif %}
               </td>
               <td class="px-3 py-2 border">{{ result.status|default:"â€”" }}</td>
               <td class="px-3 py-2 border">{{ result.date|date:'Y-m-d H:i' }}</td>
               <td class="px-3 py-2 border">{{ result.user.username|default:"â€”" }}</td>
             </tr>
             {% endfor %}
           </tbody>
         </table>
       </div>
     {% else %}
       <p class="text-gray-500 italic">No results recorded yet.</p>
     {% endif %}
   </div>
   {% endif %}

  <!-- Messages -->
  {% if messages %}
    <div>
      {% for message in messages %}
        <div class="p-3 rounded text-white {% if message.tags == 'success' %}bg-green-500{% elif message.tags == 'error' %}bg-red-500{% else %}bg-gray-500{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}


  <!-- Audit Trail -->
  <div class="text-xs text-gray-500 mt-4 text-right">
    <p>Created: {{ candidate.created_at|date:'Y-m-d H:i' }}{% if candidate.created_by %} by {{ candidate.created_by }}{% endif %}</p>
    <p>Last updated: {{ candidate.updated_at|date:'Y-m-d H:i' }}{% if candidate.updated_by %} by {{ candidate.updated_by }}{% endif %}</p>
    {% if candidate.verification_status != 'pending' and candidate.verification_date %}
    <p>{{ candidate.verification_status|capfirst }}: {{ candidate.verification_date|date:'Y-m-d H:i' }}{% if candidate.verified_by %} by {{ candidate.verified_by.get_full_name|default:candidate.verified_by.username }}{% endif %}{% if candidate.verification_status == 'declined' and candidate.decline_reason %} - {{ candidate.decline_reason }}{% endif %}</p>
    {% endif %}
  </div>

</div>


<!-- Change Occupation Modal -->  
<div id="changeOccupationModal"
     class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button type="button" id="closeOccupationModalBtn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">&times;</button>
    <h3 class="text-lg font-semibold mb-4">Change Occupation</h3>
    <form id="changeOccupationForm">
      <label for="occupationSelect" class="block mb-2 font-medium">Select New Occupation</label>
      <select id="occupationSelect" name="occupation" class="w-full border rounded px-3 py-2 mb-4">
        <option value="">-- Select Occupation --</option>
        {% for occ in occupations %}
          <option value="{{ occ.id }}" {% if candidate.occupation.id == occ.id %}disabled selected{% endif %}>
            {{ occ.name }}
          </option>
        {% endfor %}
      </select>
      <div id="occupationChangeError" class="text-red-600 text-sm mb-2 hidden"></div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Apply</button>
    </form>
  </div>
</div>

<!-- Change Assessment Center Modal -->
<div id="changeCenterModal"
     class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button type="button" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
            onclick="closeCenterModal()">&times;</button>
    <h3 class="text-lg font-semibold mb-4">Change Assessment Center</h3>
    <form id="changeCenterForm">
      <label for="centerSelect" class="block mb-2 font-medium">Select New Assessment Center</label>
      <select id="centerSelect" name="assessment_center" class="w-full border rounded px-3 py-2 mb-4" required>
        <option value="">-- Select Center --</option>
        {% for center in centers %}
          <option value="{{ center.id }}" data-has-branches="{{ center.has_branches|yesno:'true,false' }}" {% if center.id == candidate.assessment_center.id and not center.has_branches %}disabled selected{% elif center.id == candidate.assessment_center.id %}selected{% endif %}>
            {{ center.center_number }} - {{ center.center_name }}{% if center.id == candidate.assessment_center.id %} (Current){% endif %}
          </option>
        {% endfor %}
      </select>
      
      <!-- Branch Selection (shown only when center has branches) -->
      <div id="branchSelectContainer" class="hidden">
        <label for="branchSelect" class="block mb-2 font-medium">Select Branch</label>
        <select id="branchSelect" name="assessment_center_branch" class="w-full border rounded px-3 py-2 mb-4">
          <option value="">-- Select Branch --</option>
        </select>
      </div>
      
      <div id="centerChangeError" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex justify-between mt-2">
        <button type="button" id="centerCancelBtn" class="text-gray-600 hover:underline">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Apply</button>
      </div>
    </form>
  </div>
</div>

<!-- Change Registration Category Modal -->
<div id="changeRegCatModal"
     class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button type="button" id="closeRegCatModalBtn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">&times;</button>
    <h3 class="text-lg font-semibold mb-4">Change Registration Category</h3>
    <form id="changeRegCatForm">
      <label for="regCatSelect" class="block mb-2 font-medium">Select New Registration Category</label>
      <select id="regCatSelect" name="registration_category" class="w-full border rounded px-3 py-2 mb-4">
        <option value="">-- Select Category --</option>
        <option value="Formal" {% if candidate.registration_category == 'Formal' %}disabled selected{% endif %}>Formal</option>
        <option value="Modular" {% if candidate.registration_category == 'Modular' %}disabled selected{% endif %}>Modular</option>
        <option value="Informal" {% if candidate.registration_category == 'Informal' %}disabled selected{% endif %}>Informal</option>
      </select>
      <div id="regCatChangeError" class="text-red-600 text-sm mb-2 hidden"></div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Apply</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Change Occupation Modal
  var changeOccupationBtn = document.getElementById('changeOccupationAction');
  if (changeOccupationBtn) {
    changeOccupationBtn.onclick = function(e) {
      e.preventDefault();
      openOccupationModal();
      document.getElementById('actionDropdownMenu').classList.add('hidden');
    };
  }
  function openOccupationModal() {
    document.getElementById('changeOccupationModal').classList.remove('hidden');
    document.getElementById('occupationChangeError').classList.add('hidden');
    document.getElementById('occupationChangeError').innerText = '';
  }
  function closeOccupationModal() {
    document.getElementById('changeOccupationModal').classList.add('hidden');
  }
  
  // Add event listener for close button
  var closeOccupationBtn = document.getElementById('closeOccupationModalBtn');
  if (closeOccupationBtn) {
    closeOccupationBtn.addEventListener('click', closeOccupationModal);
  }
  var occForm = document.getElementById('changeOccupationForm');
  if (occForm) {
    occForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var occId = document.getElementById('occupationSelect').value;
      var err = document.getElementById('occupationChangeError');
      if (!occId) {
        err.innerText = 'Please select an occupation.';
        err.classList.remove('hidden');
        return;
      }
      fetch("{% url 'change_occupation' candidate.id %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({occupation: occId})
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          document.querySelector('[data-field="occupation"]').innerText = data.occupation_name;
          document.querySelectorAll('[data-field="reg_number"]').forEach(function(el) { el.innerText = data.reg_number; });
          closeOccupationModal();
        } else {
          err.innerText = data.error || 'Failed to change occupation.';
          err.classList.remove('hidden');
        }
      })
      .catch(() => {
        err.innerText = 'Failed to change occupation.';
        err.classList.remove('hidden');
      });
    });
  }

  // Change Registration Category Modal
  var changeRegCatBtn = document.getElementById('changeRegCatAction');
  if (changeRegCatBtn) {
    changeRegCatBtn.onclick = function(e) {
      e.preventDefault();
      openRegCatModal();
      document.getElementById('actionDropdownMenu').classList.add('hidden');
    };
  }
  function openRegCatModal() {
    document.getElementById('changeRegCatModal').classList.remove('hidden');
    document.getElementById('regCatChangeError').classList.add('hidden');
    document.getElementById('regCatChangeError').innerText = '';
  }
  function closeRegCatModal() {
    document.getElementById('changeRegCatModal').classList.add('hidden');
  }
  var closeRegCatModalBtn = document.getElementById('closeRegCatModalBtn');
  if (closeRegCatModalBtn) {
    closeRegCatModalBtn.addEventListener('click', closeRegCatModal);
  }
  var regCatForm = document.getElementById('changeRegCatForm');
  if (regCatForm) {
    regCatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var regCat = document.getElementById('regCatSelect').value;
      var err = document.getElementById('regCatChangeError');
      if (!regCat) {
        err.innerText = 'Please select a registration category.';
        err.classList.remove('hidden');
        return;
      }
      fetch("{% url 'change_registration_category' candidate.id %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({registration_category: regCat})
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          var regCatField = document.querySelector('[data-field="registration_category"]');
          if (regCatField) {
            regCatField.innerText = data.registration_category;
          }
          document.querySelectorAll('[data-field="reg_number"]').forEach(function(el) { el.innerText = data.reg_number; });
          closeRegCatModal();
          alert('Registration category updated successfully.');
        } else {
          err.innerText = data.error || 'Failed to change registration category.';
          err.classList.remove('hidden');
        }
      })
      .catch(() => {
        err.innerText = 'Failed to change registration category.';
        err.classList.remove('hidden');
      });
    });
  }

  // Change Assessment Center Modal
  var centerBtn = document.getElementById('changeCenterAction');
  if (centerBtn) {
    centerBtn.addEventListener('click', function (e) {
      e.preventDefault();
      openCenterModal();
      document.getElementById('actionDropdownMenu').classList.add('hidden');
    });
  }
  
  function openCenterModal() {
    document.getElementById('changeCenterModal').classList.remove('hidden');
    // Reset branch selection
    document.getElementById('branchSelectContainer').classList.add('hidden');
    document.getElementById('branchSelect').innerHTML = '<option value="">-- Select Branch --</option>';
    
    // Check if current center has branches and auto-load them
    setTimeout(function() {
      const centerSelect = document.getElementById('centerSelect');
      const currentCenterId = '{{ candidate.assessment_center.id }}';
      
      // Find the current center option and check if it has branches
      console.log('Looking for center ID:', currentCenterId);
      console.log('Available options:', centerSelect.options.length);
      
      for (let i = 0; i < centerSelect.options.length; i++) {
        const option = centerSelect.options[i];
        console.log('Option', i, '- Value:', option.value, 'Text:', option.text, 'Has branches attr:', option.getAttribute('data-has-branches'));
        
        if (option.value == currentCenterId) {
          const hasBranches = option.getAttribute('data-has-branches') === 'true';
          console.log('Found current center! Has branches:', hasBranches);
          console.log('Current center option:', option);
          
          if (hasBranches) {
            console.log('Loading branches for center:', currentCenterId);
            loadBranchesForCenter(currentCenterId, true);
          } else {
            console.log('Current center does not have branches enabled');
          }
          break;
        }
      }
    }, 100);
  }
  
  // Expose close function globally so inline onclick works
  window.closeCenterModal = function() {
    document.getElementById('changeCenterModal').classList.add('hidden');
  }
  
  // Function to load branches for a center
  function loadBranchesForCenter(centerId, isCurrentCenter = false) {
    console.log('loadBranchesForCenter called with:', centerId, 'isCurrentCenter:', isCurrentCenter);
    const branchContainer = document.getElementById('branchSelectContainer');
    const branchSelect = document.getElementById('branchSelect');
    
    if (!centerId) {
      console.log('No center ID provided, hiding branch container');
      branchContainer.classList.add('hidden');
      branchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
      return;
    }
    
    console.log('Showing branch container and loading branches...');
    // Show branch selection and load branches
    branchContainer.classList.remove('hidden');
    branchSelect.innerHTML = '<option value="">Loading branches...</option>';
    
    fetch('/eims/api/center-branches/?center_id=' + centerId)
      .then(response => response.json())
      .then(data => {
        if (data.has_branches && data.branches) {
          branchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
          
          // Add "Main Branch" option for centers with branches
          const mainOption = document.createElement('option');
          mainOption.value = 'main';
          mainOption.textContent = 'Main Branch (No specific branch)';
          
          // Pre-select main branch if current candidate has no branch
          if (isCurrentCenter && '{{ candidate.assessment_center_branch.id|default:"" }}' === '') {
            mainOption.selected = true;
            mainOption.textContent += ' (Current)';
          }
          
          branchSelect.appendChild(mainOption);
          
          data.branches.forEach(function(branch) {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = branch.branch_code;
            
            // Pre-select current branch if this is the current center
            if (isCurrentCenter && '{{ candidate.assessment_center_branch.id|default:"" }}' == branch.id) {
              option.selected = true;
              option.textContent += ' (Current)';
            }
            
            branchSelect.appendChild(option);
          });
        } else {
          branchSelect.innerHTML = '<option value="">No branches available</option>';
        }
      })
      .catch(error => {
        console.error('Error loading branches:', error);
        branchSelect.innerHTML = '<option value="">Error loading branches</option>';
      });
  }

  // Handle center selection change to load branches
  var centerSelect = document.getElementById('centerSelect');
  if (centerSelect) {
    centerSelect.addEventListener('change', function() {
      const centerId = this.value;
      const selectedOption = this.options[this.selectedIndex];
      const hasBranches = selectedOption.getAttribute('data-has-branches') === 'true';
      
      if (centerId && hasBranches) {
        const isCurrentCenter = centerId == '{{ candidate.assessment_center.id }}';
        loadBranchesForCenter(centerId, isCurrentCenter);
      } else {
        // Hide branch selection for centers without branches
        document.getElementById('branchSelectContainer').classList.add('hidden');
        document.getElementById('branchSelect').innerHTML = '<option value="">-- Select Branch --</option>';
      }
    });
  }
  
  var centerForm = document.getElementById('changeCenterForm');
  if (centerForm) {
    centerForm.onsubmit = function (e) {
      e.preventDefault();
      const centerId = document.getElementById('centerSelect').value;
      const branchId = document.getElementById('branchSelect').value;
      const selectedOption = document.getElementById('centerSelect').options[document.getElementById('centerSelect').selectedIndex];
      const hasBranches = selectedOption.getAttribute('data-has-branches') === 'true';
      const errorDiv = document.getElementById('centerChangeError');
      
      // Clear previous errors
      errorDiv.classList.add('hidden');
      
      if (!centerId) {
        errorDiv.innerText = 'Please select a center.';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      if (hasBranches && !branchId) {
        errorDiv.innerText = 'Please select a branch for this center.';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      const requestData = { assessment_center: centerId };
      if (branchId) {
        requestData.assessment_center_branch = branchId;
      }
      
      fetch("{% url 'change_center' candidate.id %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(requestData)
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          document.querySelector('[data-field="assessment_center"]').innerText = data.center_name;
          document.querySelectorAll('[data-field="reg_number"]').forEach(function(el) { el.innerText = data.reg_number; });
          window.closeCenterModal();
          // Refresh page to show updated branch information
          window.location.reload();
        } else {
          errorDiv.innerText = data.error || 'Failed to change center.';
          errorDiv.classList.remove('hidden');
        }
      })
      .catch(() => {
        errorDiv.innerText = 'An error occurred.';
        errorDiv.classList.remove('hidden');
      });
    };
  }
  
  // Cancel button closes the modal
  var centerCancelBtn = document.getElementById('centerCancelBtn');
  if (centerCancelBtn) {
    centerCancelBtn.addEventListener('click', function() {
      window.closeCenterModal();
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Simple and reliable fee formatting
    var feesBalance = document.getElementById('fees-balance');
    if (feesBalance && feesBalance.textContent) {
        var amount = parseFloat(feesBalance.textContent.trim());
        if (!isNaN(amount)) {
            feesBalance.textContent = amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    }
    
    // Set progress bar widths for modular enrollment
    document.querySelectorAll('.progress-bar').forEach(function(bar) {
        var width = bar.getAttribute('data-width');
        if (width) {
            bar.style.width = width + '%';
        }
    });
});
</script>

{% endif %}

{% endblock %}
