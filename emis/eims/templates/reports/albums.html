{% extends "base.html" %}
{% load static %}

{% block content %}

{# ------------------------------------------------------------------ #}
{# 1Ô∏è‚É£  ‚ÄúBack‚Äù link                                                    #}
{# ------------------------------------------------------------------ #}
<div class="w-full mb-6">
  <a href="{% url 'report_list' %}"
     class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">
    &larr; Back to Reports
  </a>
</div>

{# ------------------------------------------------------------------ #}
{# 2Ô∏è‚É£  Page heading + helper text                                     #}
{# ------------------------------------------------------------------ #}
<div class="max-w-2xl mx-auto mb-8">
  <h1 class="text-3xl font-bold text-gray-900">Generate Registration List</h1>
  <p class="mt-1 text-sm text-gray-600">
    Select parameters to generate the registration list
  </p>
</div>

{# ------------------------------------------------------------------ #}
{# 3Ô∏è‚É£  üîç  Parameter-selection form                                   #}
{# ------------------------------------------------------------------ #}
<div class="bg-white max-w-2xl mx-auto rounded shadow p-6 mb-10">
  <form method="post" class="space-y-6">
    {% csrf_token %}

    {# ‚Äî‚Äî‚Äî Assessment Center ‚Äî‚Äî‚Äî #}
    <div>
      <label for="center" class="block text-sm font-medium text-gray-700">Assessment Center</label>
      <select id="center" name="center" required
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
        <option value="">Select Assessment Center</option>
        {% for c in centers %}
          <option value="{{ c.id }}">{{ c.center_name }}</option>
        {% endfor %}
      </select>
    </div>

    {# ‚Äî‚Äî‚Äî Occupation ‚Äî‚Äî‚Äî #}
    <div>
      <label for="occupation" class="block text-sm font-medium text-gray-700">Occupation</label>
      <select id="occupation" name="occupation" required
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
        <option value="">Select Occupation</option>
        {% for o in occupations %}
          <option value="{{ o.id }}">{{ o.name }}</option>
        {% endfor %}
      </select>
    </div>

    {# ‚Äî‚Äî‚Äî Registration Category ‚Äî‚Äî‚Äî #}
    <div>
      <label for="reg_cat" class="block text-sm font-medium text-gray-700">Registration Category</label>
      <select id="reg_cat" name="registration_category" required
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500"
              onchange="toggleLevelField()">
        <option value="">Select Category</option>
        <option value="Formal">Formal</option>
        <option value="Informal">Informal</option>
        <option value="Modular">Modular</option>
      </select>
    </div>

    {# ‚Äî‚Äî‚Äî Level (shown only for Formal / Informal) ‚Äî‚Äî‚Äî #}
    <div id="level_wrapper" class="hidden">
      <label for="level" class="block text-sm font-medium text-gray-700">Level</label>
      <select id="level" name="level"
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
        {% for lvl in levels %}
          <option value="{{ lvl.id }}">{{ lvl.name }}</option>
        {% endfor %}
      </select>
      <p id="level_note" class="text-xs text-gray-500 mt-1 hidden">
        Not applicable for <strong>Modular</strong> candidates
      </p>
    </div>

    {# ‚Äî‚Äî‚Äî Month / Year selectors ‚Äî‚Äî‚Äî #}
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="ass_month" class="block text-sm font-medium text-gray-700">Assessment Month</label>
        <select id="ass_month" name="assessment_month" required
        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
  <option value="">Select Month</option>
  <option value="1">January</option>
  <option value="2">February</option>
  <option value="3">March</option>
  <option value="4">April</option>
  <option value="5">May</option>
  <option value="6">June</option>
  <option value="7">July</option>
  <option value="8">August</option>
  <option value="9">September</option>
  <option value="10">October</option>
  <option value="11">November</option>
  <option value="12">December</option>
</select>
      </div>

      <div>
        <label for="ass_year" class="block text-sm font-medium text-gray-700">Assessment Year</label>
        <select id="ass_year" name="assessment_year" required
        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
  <option value="">Select Year</option>
  <option value="2025">2025</option>
  <option value="2024">2024</option>
  <option value="2023">2023</option>
  <option value="2022">2022</option>
  <option value="2021">2021</option>
</select>
      </div>
    </div>

    {# ‚Äî‚Äî‚Äî Buttons ‚Äî‚Äî‚Äî #}
    <div class="flex justify-end gap-4 pt-6 border-t">
      <a href="{% url 'report_list' %}"
         class="text-sm px-4 py-2 rounded hover:underline">Cancel</a>
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
        Generate PDF
      </button>
    </div>
  </form>
</div>

{# ------------------------------------------------------------------ #}
{# 4Ô∏è‚É£  PDF PREVIEW SECTION  (only shown after POST)                  #}
{# ------------------------------------------------------------------ #}

{% if pages %}
  <style>
    /* Prevent rows / images splitting across pages */
    table, tr, img      { page-break-inside: avoid; }
    tbody               { display: table-row-group; }
    table               { width: 100%; border-collapse: collapse; }
    th, td              { border: 1px solid #000; padding: .25rem .4rem; }
    th                  { background: #0060c0; color: #fff; font-size: 0.9rem; }
    td                  { font-size: 0.85rem; }
    @media print {
      thead { display: table-row-group !important; }
    }
    /* --- WeasyPrint/PrinceXML: True page numbers in footer --- */
    @page {
      size: A4;
      margin: 1cm 1.5cm 2cm 1.5cm;
      @bottom-center {
        content: "Page " counter(page) " of " counter(pages);
        font-size: 0.9em;
        color: #888;
      }
    }
  </style>

  {# ---- Optional report title / logo (only once) ---- #}
  <div class="text-center mb-6">
    <img src="{% static 'images/uvtab_logo.png' %}" class="inline h-16" alt="UVTAB" />
    <h2 class="font-bold text-lg mt-2">UGANDA VOCATIONAL AND TECHNICAL ASSESSMENT BOARD</h2>
    <h3 class="text-md">Registered Candidates ‚Äì {{ assessment_month }}/{{ assessment_year }}</h3>
  </div>

  <table>
    {% for candidate_page in pages %}
      {% if forloop.first %}
        <thead>
          <tr>
            <th>S/N</th>
            <th>Photo</th>
            <th>Reg&nbsp;No.</th>
            <th>Full&nbsp;Name</th>
            <th>Occupation</th>
            <th>Reg&nbsp;Type</th>
            <th>Signature</th>
          </tr>
        </thead>
      {% endif %}
      <tbody>
        {% for cand in candidate_page %}
          <tr>
            <td>{{ forloop.parentloop.counter0|add:forloop.counter }}</td>
            <td>
              {# Show regno-stamped photo if available, else fallback to original, else N/A #}
              {% if cand.passport_photo_with_regno %}
                <img src="{{ cand.passport_photo_with_regno.url }}" style="height:60px;" alt="">
              {% elif cand.passport_photo %}
                <img src="{{ cand.passport_photo.url }}" style="height:60px;" alt="">
              {% else %} N/A {% endif %}
            </td>
            <td>{{ cand.reg_number }}</td>
            <td>{{ cand.full_name }}</td>
            <td>{{ cand.occupation.name }}</td>
            <td>{{ cand.registration_category }}</td>
            <td></td>
          </tr>
        {% endfor %}
      </tbody>

    {% endfor %}
  </table>
  <style>
    table, tr, img      { page-break-inside: avoid; }
    /* thead { display: table-header-group; } */
    tbody               { display: table-row-group; }
    table               { width: 100%; border-collapse: collapse; }
    th, td              { border: 1px solid #000; padding: .25rem .4rem; }
    th                  { background: #0060c0; color: #fff; font-size: 0.9rem; }
    td                  { font-size: 0.85rem; }
    .page-number-row    { page-break-after: always; }
    @media print {
      thead { display: table-row-group !important; }
      .page-number-row { page-break-after: always !important; }
    }
  </style>
{% endif %}

{# ------------------------------------------------------------------ #}
{# 5Ô∏è‚É£  Little JS to hide / show level field                           #}
{# ------------------------------------------------------------------ #}
<script>
  function toggleLevelField () {
    const sel   = document.getElementById('reg_cat');
    const wrap  = document.getElementById('level_wrapper');
    const note  = document.getElementById('level_note');

    if (sel.value === 'Modular') {
      wrap.classList.add('hidden');
      note.classList.remove('hidden');
    } else if (sel.value) {
      wrap.classList.remove('hidden');
      note.classList.add('hidden');
    } else {
      wrap.classList.add('hidden');
      note.classList.add('hidden');
    }
  }
  // run once on load (for browser back button etc.)
  document.addEventListener('DOMContentLoaded', toggleLevelField);
</script>

</div>
{% endblock %}
