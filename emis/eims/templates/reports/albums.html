{% extends "base.html" %}
{% load static %}

{% block content %}

{# ------------------------------------------------------------------ #}
{# 1Ô∏è‚É£  ‚ÄúBack‚Äù link                                                    #}
{# ------------------------------------------------------------------ #}
<div class="w-full mb-6">
  <a href="{% url 'report_list' %}"
     class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">
    &larr; Back to Reports
  </a>
</div>

{# ------------------------------------------------------------------ #}
{# 2Ô∏è‚É£  Page heading + helper text                                     #}
{# ------------------------------------------------------------------ #}
<div class="max-w-2xl mx-auto mb-8">
  <h1 class="text-3xl font-bold text-gray-900">Generate Registration List</h1>
  <p class="mt-1 text-sm text-gray-600">
    Select parameters to generate the registration list
  </p>
</div>

{# ------------------------------------------------------------------ #}
{# 3Ô∏è‚É£  üîç  Parameter-selection form                                   #}
{# ------------------------------------------------------------------ #}
<div class="bg-white max-w-2xl mx-auto rounded shadow p-6 mb-10">
  <form method="post" class="space-y-6">
    {% csrf_token %}
    {# Server-provided fallback JSON for Assessment Series #}
    {% if series_fallback %}
      {{ series_fallback|json_script:"series-fallback-data" }}
    {% endif %}

    {# ‚Äî‚Äî‚Äî Assessment Center ‚Äî‚Äî‚Äî #}
    <div>
      <label for="center" class="block text-sm font-medium text-gray-700">Assessment Center</label>
      <select id="center" name="center" required
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500"
              {% if centers|length == 1 and selected_center_id %}disabled{% endif %}>
        <option value="">Select Assessment Center</option>
        {% for c in centers %}
          <option value="{{ c.id }}" data-has-branches="{{ c.has_branches|yesno:'true,false' }}" {% if selected_center_id and c.id == selected_center_id %}selected{% endif %}>{{ c.center_name }}</option>
        {% endfor %}
      </select>
      {% if centers|length == 1 and selected_center_id %}
        <input type="hidden" name="center" value="{{ selected_center_id }}">
      {% endif %}
    </div>

    {# ‚Äî‚Äî‚Äî Branch (shown only when center has branches) ‚Äî‚Äî‚Äî #}
    <div id="branch_wrapper" class="hidden">
      <label for="branch_id" class="block text-sm font-medium text-gray-700">Branch</label>
      <select id="branch_id" name="branch_id"
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
        <option value="">Select Branch</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">Required when the selected center has branches.</p>
    </div>

    {# ‚Äî‚Äî‚Äî Assessment Series ‚Äî‚Äî‚Äî #}
    <div>
      <label for="assessment_series" class="block text-sm font-medium text-gray-700">Assessment Series</label>
      <select id="assessment_series" name="assessment_series" required
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
        <option value="">Loading series...</option>
      </select>
    </div>

    {# ‚Äî‚Äî‚Äî Registration Category ‚Äî‚Äî‚Äî #}
    <div>
      <label for="reg_cat" class="block text-sm font-medium text-gray-700">Registration Category</label>
      <select id="reg_cat" name="registration_category" required
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500"
              onchange="toggleLevelField()">
        <option value="">Select Category</option>
        <option value="Formal">Formal</option>
        <option value="Informal">Informal</option>
        <option value="Modular">Modular</option>
      </select>
    </div>

    {# ‚Äî‚Äî‚Äî Occupation (filtered by Registration Category) ‚Äî‚Äî‚Äî #}
    <div>
      <label for="occupation" class="block text-sm font-medium text-gray-700">Occupation</label>
      <select id="occupation" name="occupation" required
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
        <option value="">Select Occupation</option>
        {% for o in occupations %}
          <option value="{{ o.id }}">{{ o.name }}</option>
        {% endfor %}
      </select>
    </div>

    {# ‚Äî‚Äî‚Äî Level (shown only for Formal / Informal) ‚Äî‚Äî‚Äî #}
    <div id="level_wrapper" class="hidden">
      <label for="level" class="block text-sm font-medium text-gray-700">Level</label>
      <select id="level" name="level"
              class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
        {% for lvl in levels %}
          <option value="{{ lvl.id }}">{{ lvl.name }}</option>
        {% endfor %}
      </select>
      <p id="level_note" class="text-xs text-gray-500 mt-1 hidden">
        Not applicable for <strong>Modular</strong> candidates
      </p>
    </div>


    {# ‚Äî‚Äî‚Äî Buttons ‚Äî‚Äî‚Äî #}
    <div class="flex justify-end gap-4 pt-6 border-t">
      <a href="{% url 'report_list' %}"
         class="text-sm px-4 py-2 rounded hover:underline">Cancel</a>
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
        Generate PDF
      </button>
    </div>
  </form>
</div>

{# ------------------------------------------------------------------ #}
{# 4Ô∏è‚É£  PDF PREVIEW SECTION  (only shown after POST)                  #}
{# ------------------------------------------------------------------ #}

{% if pages %}
  <style>
    /* Prevent rows / images splitting across pages */
    table, tr, img      { page-break-inside: avoid; }
    tbody               { display: table-row-group; }
    table               { width: 100%; border-collapse: collapse; }
    th, td              { border: 1px solid #000; padding: .25rem .4rem; }
    th                  { background: #0060c0; color: #fff; font-size: 0.9rem; }
    td                  { font-size: 0.85rem; }
    @media print {
      thead { display: table-row-group !important; }
    }
    /* --- WeasyPrint/PrinceXML: True page numbers in footer --- */
    @page {
      size: A4;
      margin: 1cm 1.5cm 2cm 1.5cm;
      @bottom-center {
        content: "Page " counter(page) " of " counter(pages);
        font-size: 0.9em;
        color: #888;
      }
    }
  </style>

  {# ---- Optional report title / logo (only once) ---- #}
  <div class="text-center mb-6">
    <img src="{% static 'images/uvtab_logo.png' %}" class="inline h-16" alt="UVTAB" />
    <h2 class="font-bold text-lg mt-2">UGANDA VOCATIONAL AND TECHNICAL ASSESSMENT BOARD</h2>
    <h3 class="text-md">Registered Candidates ‚Äì {{ assessment_month }}/{{ assessment_year }}</h3>
  </div>

  <table>
    {% for candidate_page in pages %}
      {% if forloop.first %}
        <thead>
          <tr>
            <th>S/N</th>
            <th>Photo</th>
            <th>Reg&nbsp;No.</th>
            <th>Full&nbsp;Name</th>
            <th>Occupation</th>
            <th>Reg&nbsp;Type</th>
            <th>Signature</th>
          </tr>
        </thead>
      {% endif %}
      <tbody>
        {% for cand in candidate_page %}
          <tr>
            <td>{{ forloop.parentloop.counter0|add:forloop.counter }}</td>
            <td>
              {# Show regno-stamped photo if available, else fallback to original, else N/A #}
              {% if cand.passport_photo_with_regno %}
                <img src="{{ cand.passport_photo_with_regno.url }}" style="height:60px;" alt="">
              {% elif cand.passport_photo %}
                <img src="{{ cand.passport_photo.url }}" style="height:60px;" alt="">
              {% else %} N/A {% endif %}
            </td>
            <td>{{ cand.reg_number }}</td>
            <td>{{ cand.full_name }}</td>
            <td>{{ cand.occupation.name }}</td>
            <td>{{ cand.registration_category }}</td>
            <td></td>
          </tr>
        {% endfor %}
      </tbody>

    {% endfor %}
  </table>
  <style>
    table, tr, img      { page-break-inside: avoid; }
    /* thead { display: table-header-group; } */
    tbody               { display: table-row-group; }
    table               { width: 100%; border-collapse: collapse; }
    th, td              { border: 1px solid #000; padding: .25rem .4rem; }
    th                  { background: #0060c0; color: #fff; font-size: 0.9rem; }
    td                  { font-size: 0.85rem; }
    .page-number-row    { page-break-after: always; }
    @media print {
      thead { display: table-row-group !important; }
      .page-number-row { page-break-after: always !important; }
    }
  </style>
{% endif %}

{# ------------------------------------------------------------------ #}
{# 5Ô∏è‚É£  Page scripts (series, occupations, levels)                    #}
{# ------------------------------------------------------------------ #}

<script>
// Load branches dynamically for a selected center
async function loadBranchesForCenter(centerId){
  const wrap = document.getElementById('branch_wrapper');
  const sel  = document.getElementById('branch_id');
  if (!wrap || !sel){ return; }
  if (!centerId){
    wrap.classList.add('hidden');
    sel.innerHTML = '<option value="">Select Branch</option>';
    return;
  }
  try{
    // Build URL from named route template with a placeholder
    const tpl = '{% url "api_assessment_center_branches" 0 %}';
    const url = tpl.replace('/0/', '/' + encodeURIComponent(centerId) + '/');
    sel.innerHTML = '<option value="">Loading branches...</option>';
    const r = await fetch(url);
    const data = await r.json();
    sel.innerHTML = '<option value="">Select Branch</option>';
    const list = (data && Array.isArray(data.branches)) ? data.branches : [];
    if (data && data.has_branches){
      // Add Main Center option first
      const mainOpt = document.createElement('option');
      mainOpt.value = 'main';
      mainOpt.textContent = 'Main Center';
      sel.appendChild(mainOpt);
      // Then append branch items (if any)
      list.forEach(function(b){
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.branch_code} - ${b.village_name}`;
        sel.appendChild(opt);
      });
      wrap.classList.remove('hidden');
    } else {
      wrap.classList.add('hidden');
    }
  }catch(e){
    console.error('Failed to load branches', e);
    sel.innerHTML = '<option value="">Failed to load branches</option>';
    wrap.classList.remove('hidden');
  }
}
// Populate levels based on the selected occupation (only when reg category is Formal/Informal)
async function refreshLevelsForOccupation() {
  var regCatSel = document.getElementById('reg_cat');
  var occSel = document.getElementById('occupation');
  var levelSel = document.getElementById('level');
  var levelWrap = document.getElementById('level_wrapper');
  if (!regCatSel || !occSel || !levelSel) return;
  var regcat = (regCatSel.value || '').toLowerCase();
  // Hide for modular
  if (regcat === 'modular') {
    if (levelWrap) levelWrap.classList.add('hidden');
    return;
  }
  if (levelWrap) levelWrap.classList.remove('hidden');
  var occId = occSel.value;
  if (!occId) {
    levelSel.innerHTML = '';
    return;
  }
  try {
    levelSel.innerHTML = '<option value="">Loading levels...</option>';
    var url = '{% url "api_levels_for_occupation" %}?occupation_id=' + encodeURIComponent(occId);
    var r = await fetch(url);
    var data = await r.json();
    levelSel.innerHTML = '';
    if (data && data.levels && data.levels.length) {
      data.levels.forEach(function (lvl) {
        var opt = document.createElement('option');
        opt.value = lvl.id;
        opt.textContent = lvl.name;
        levelSel.appendChild(opt);
      });
    } else {
      levelSel.innerHTML = '<option value="">No levels found</option>';
    }
  } catch (e) {
    console.error('Failed to load levels', e);
    levelSel.innerHTML = '<option value="">Failed to load levels</option>';
  }
}

function toggleLevelField () {
  const sel   = document.getElementById('reg_cat');
  const wrap  = document.getElementById('level_wrapper');
  const note  = document.getElementById('level_note');
  if (!sel || !wrap || !note) return;
  if (sel.value === 'Modular') {
    wrap.classList.add('hidden');
    note.classList.remove('hidden');
  } else if (sel.value) {
    wrap.classList.remove('hidden');
    note.classList.add('hidden');
    refreshLevelsForOccupation();
  } else {
    wrap.classList.add('hidden');
    note.classList.add('hidden');
  }
}

// Populate Assessment Series dropdown from API and preselect current
async function populateAssessmentSeriesDropdown() {
  const seriesSelect = document.getElementById('assessment_series');
  const info = document.getElementById('series_info');
  if (!seriesSelect) return;
  try {
    seriesSelect.innerHTML = '<option value="">Loading series...</option>';
    const resp = await fetch('{% url "api_assessment_series" %}');
    const data = await resp.json();
    seriesSelect.innerHTML = '<option value="">Select Assessment Series</option>';
    var seriesArr = (data && (data.series || data.assessment_series)) ? (data.series || data.assessment_series) : [];
    if ((!seriesArr || !seriesArr.length)) {
      var fbEl = document.getElementById('series-fallback-data');
      if (fbEl && fbEl.textContent) {
        try { seriesArr = JSON.parse(fbEl.textContent); } catch (e) { seriesArr = []; }
      }
    }
    if (seriesArr && seriesArr.length) {
      seriesArr.forEach(function (s) {
        const opt = document.createElement('option');
        opt.value = s.id;
        var name = s.display_name || s.name;
        opt.textContent = name;
        if (s.is_current) opt.selected = true;
        seriesSelect.appendChild(opt);
      });
      const current = seriesArr.find(function (s) { return s.is_current; });
      if (current && info) {
        var title = current.name || current.display_name || '';
        var range = current.date_range || (current.start_date && current.end_date ? (current.start_date + ' - ' + current.end_date) : '');
        info.textContent = title + (range ? ' ‚Ä¢ ' + range : '');
      } else if (info) {
        info.textContent = '';
      }
    } else {
      seriesSelect.innerHTML = '<option value="">No assessment series found</option>';
      if (info) info.textContent = '';
    }
  } catch (e) {
    console.error('Failed to load assessment series', e);
    seriesSelect.innerHTML = '<option value="">Failed to load series</option>';
    var fbEl = document.getElementById('series-fallback-data');
    if (fbEl && fbEl.textContent) {
      try {
        var seriesArr = JSON.parse(fbEl.textContent);
        if (seriesArr && seriesArr.length) {
          seriesSelect.innerHTML = '<option value="">Select Assessment Series</option>';
          seriesArr.forEach(function (s) {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.display_name || s.name;
            if (s.is_current) opt.selected = true;
            seriesSelect.appendChild(opt);
          });
          if (info) info.textContent = '';
          return;
        }
      } catch (err) {}
    }
    if (info) info.textContent = 'Could not load assessment series. Please refresh.';
  }
}

// Filter occupations based on registration category
async function refreshOccupationsByCategory() {
  var regCat = document.getElementById('reg_cat');
  var occ = document.getElementById('occupation');
  if (!regCat || !occ) return;
  var category = (regCat.value || '').toLowerCase();
  try {
    occ.innerHTML = '<option value="">Loading occupations...</option>';
    var url = '{% url "api_occupations_by_category" %}';
    if (category) {
      url += '?registration_category=' + encodeURIComponent(category);
    }
    var r = await fetch(url);
    var data = await r.json();
    occ.innerHTML = '<option value="">Select Occupation</option>';
    if (data && data.occupations && data.occupations.length) {
      data.occupations.forEach(function (o) {
        var opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = o.display_name || (o.code + ' - ' + o.name);
        occ.appendChild(opt);
      });
    } else {
      occ.innerHTML = '<option value="">No occupations found</option>';
    }
  } catch (e) {
    console.error('Failed to load occupations', e);
    occ.innerHTML = '<option value="">Failed to load occupations</option>';
  }
}

// Initialize once DOM is loaded
document.addEventListener('DOMContentLoaded', function () {
  populateAssessmentSeriesDropdown();
  // When center changes, attempt to load branches; API will tell us if none
  const centerSel = document.getElementById('center');
  function handleCenterChange(){
    if (!centerSel) return;
    const val = centerSel.value;
    if (val){
      loadBranchesForCenter(val);
    } else {
      const wrap = document.getElementById('branch_wrapper');
      const sel  = document.getElementById('branch_id');
      if (wrap) wrap.classList.add('hidden');
      if (sel) sel.innerHTML = '<option value="">Select Branch</option>';
    }
  }
  if (centerSel){
    centerSel.addEventListener('change', handleCenterChange);
    // Fire once on load to populate branches for the preselected center
    handleCenterChange();
  }
  var regCatSel = document.getElementById('reg_cat');
  if (regCatSel) {
    regCatSel.addEventListener('change', function(){
      refreshOccupationsByCategory();
      toggleLevelField();
    });
    refreshOccupationsByCategory();
  }
  var occSel = document.getElementById('occupation');
  if (occSel) {
    occSel.addEventListener('change', refreshLevelsForOccupation);
  }
});
</script>
{% endblock %}
