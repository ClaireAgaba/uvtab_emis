{% extends 'base.html' %}
{% load result_extras %}

{% block content %}
<style>
  @media print {
    .page-break-before {
      page-break-before: always;
    }
    .center-page {
      page-break-after: always;
    }
    .center-page:last-child {
      page-break-after: auto;
    }
  }
  @media screen {
    .page-break-before {
      border-top: 2px dashed #ccc;
      margin-top: 2rem;
      padding-top: 2rem;
    }
  }
</style>
<div class="w-full mb-6">
  <a href="{% url 'report_list' %}"
     class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">
    &larr; Back to Reports
  </a>
</div>

<div class="max-w-2xl mx-auto mb-8">
  <h1 class="text-3xl font-bold text-gray-900">Generate Result List</h1>
  <p class="mt-1 text-sm text-gray-600">
    Select parameters to generate the result list
  </p>
</div>

<div class="bg-white max-w-2xl mx-auto rounded shadow p-6 mb-10">
  {% if errors %}
    <div class="bg-red-100 text-red-700 p-3 mb-4 rounded border border-red-300">
      {% for error in errors %}<div>{{ error }}</div>{% endfor %}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Month -->
      <div>
        <label for="assessment_month" class="block text-sm font-medium text-gray-700">Assessment Month</label>
        <select id="assessment_month" name="assessment_month" class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
          <option value="">Select Month</option>
          {% for m in months %}
            <option value="{{ m.value }}" {% if form_data.month == m.value|stringformat:'s' %}selected{% endif %}>{{ m.name }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Year -->
      <div>
        <label for="assessment_year" class="block text-sm font-medium text-gray-700">Assessment Year</label>
        <select id="assessment_year" name="assessment_year" class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
          <option value="">Select Year</option>
          {% for y in years %}
            <option value="{{ y }}" {% if form_data.year == y|stringformat:'s' %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Registration Category -->
      <div>
        <label for="reg_category" class="block text-sm font-medium text-gray-700">Registration Category</label>
        <select id="reg_category" name="registration_category" class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
          <option value="">Select Category</option>
          <option value="modular" {% if form_data.regcat == "modular" %}selected{% endif %}>Modular</option>
          <option value="formal" {% if form_data.regcat == "formal" %}selected{% endif %}>Formal</option>
          <option value="informal" {% if form_data.regcat == "informal" %}selected{% endif %}>Informal/Worker's PAS</option>
        </select>
      </div>
      <!-- Occupation -->
      <div>
        <label for="occupation" class="block text-sm font-medium text-gray-700">Occupation</label>
        <select id="occupation" name="occupation" class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
          <option value="">Select Occupation</option>
          {% for occ in occupations %}
            <option value="{{ occ.id }}" {% if form_data.occupation_id == occ.id|stringformat:'s' %}selected{% endif %}>{{ occ.name }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Level -->
      <div id="level_wrapper" class="{% if form_data.regcat == 'formal' or form_data.regcat == 'informal' %}{% else %}hidden{% endif %}">
        <label for="level" class="block text-sm font-medium text-gray-700">Level</label>
        <select id="level" name="level" class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
          <option value="">Select Level</option>
          {% for lvl in levels %}
            <option value="{{ lvl.id }}" {% if form_data.level_id == lvl.id|stringformat:'s' %}selected{% endif %}>{{ lvl.name }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Center -->
      <div>
        <label for="assessment_center" class="block text-sm font-medium text-gray-700">Assessment Center (Optional)</label>
        <select id="assessment_center" name="assessment_center" class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500">
          <option value="">All Centers</option>
          {% for c in centers %}
            <option value="{{ c.id }}" {% if form_data.center_id == c.id|stringformat:'s' %}selected{% endif %}>{{ c.center_name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="flex justify-end gap-4 pt-6 border-t mt-8">
      <a href="{% url 'report_list' %}" class="text-sm px-4 py-2 rounded hover:underline">Cancel</a>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">Generate Preview</button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const regCategorySelect = document.getElementById('reg_category');
      const levelWrapper = document.getElementById('level_wrapper');
      
      function toggleLevelField() {
        const val = regCategorySelect.value;
        console.log('Registration category changed to:', val);
        if (val === 'formal' || val === 'informal') {
          levelWrapper.classList.remove('hidden');
        } else {
          levelWrapper.classList.add('hidden');
        }
      }
      
      // Set initial state
      toggleLevelField();
      
      // Listen for changes
      regCategorySelect.addEventListener('change', toggleLevelField);
    });
  </script>
</div>

{% if preview and centered_result_data %}
<div class="flex justify-end mb-2">
  <a href="{% url 'download_result_list_pdf' %}?assessment_month={{ form_data.month }}&assessment_year={{ form_data.year }}&registration_category={{ form_data.regcat }}&occupation={{ form_data.occupation_id }}&level={{ form_data.level_id }}&assessment_center={{ form_data.center_id }}" class="no-print bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow inline-block">Download PDF</a>
</div>
<div id="result-list-preview" class="bg-white rounded shadow p-8 mt-8 mb-8">
  {% if centered_result_data %}
    {% for center, data in centered_result_data.items %}
    <!-- Each center gets its own page with full header -->
    <div class="center-page{% if not forloop.first %} page-break-before{% endif %}">
      <!-- Full UVTAB Header for each center -->
      <div class="flex items-center justify-between mb-4">
        <img src="{{ logo_path }}" alt="UVTAB Logo" class="h-14">
        <div class="text-center flex-1">
          <div class="text-lg font-bold tracking-wide">UGANDA VOCATIONAL AND TECHNICAL ASSESSMENT BOARD</div>
          <div class="text-md font-semibold">PROVISIONAL ASSESSMENT RESULTS FOR</div>
          <div class="text-md font-semibold">ASSESSMENT PERIOD: {{ formatted_period }}</div>
        </div>
        <div class="text-right text-xs text-gray-500">Preview Mode</div>
      </div>
      
      <!-- Center-specific information -->
      <div class="mb-2 font-semibold">
        Category: {{ form_data.regcat|title }}<br>
        Occupation: {{ form_data.occupation_name }}<br>
        {% if form_data.level_name and form_data.regcat != 'modular' %}Level: {{ form_data.level_name }}<br>{% endif %}
        Assessment Center: {{ center }}
      </div>
    {% if data and data|length > 0 %}
      <div class="overflow-x-auto">
        {% if form_data.regcat == 'modular' %}
          <table class="w-full border text-base" style="font-size: 14px; width: 100%; table-layout: fixed;">
            <thead>
              <tr class="bg-gray-100">
                <th class="border p-3" style="width: 8%; font-weight: bold; font-size: 14px;">S/N</th>
                <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Photo</th>
                <th class="border p-3" style="width: 18%; font-weight: bold; font-size: 14px;">Reg No</th>
                <th class="border p-3" style="width: 25%; font-weight: bold; font-size: 14px;">Name</th>
                <th class="border p-3" style="width: 10%; font-weight: bold; font-size: 14px;">Gender</th>
                <th class="border p-3" style="width: 15%; font-weight: bold; font-size: 14px;">Practical</th>
                <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Comment</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in data %}
                <tr>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ forloop.counter }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">
                    {% if entry.candidate.passport_photo_with_regno %}
                      <img src="{{ entry.candidate.passport_photo_with_regno }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                    {% elif entry.candidate.passport_photo %}
                      <img src="{{ entry.candidate.passport_photo }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                    {% else %}
                      <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">No Photo</div>
                    {% endif %}
                  </td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.reg_number }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.full_name }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.gender }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">
                    {% for r in entry.results %}
                      <span class="inline-block px-2 py-1 rounded {% if r.grade == 'F' or r.grade == 'Ms' or r.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %} mr-1 mb-1">{{ r.grade }}</span>
                    {% endfor %}
                  </td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">
                    {% for r in entry.results %}
                      {% if r.comment == 'Missing' or r.comment == 'Fail' %}
                        <span class="font-bold text-red-600">{{ r.comment }}</span>
                      {% elif r.comment == 'CTR' %}
                        <span class="font-bold text-red-600">Fail</span>
                      {% else %}
                        {{ r.comment|default:"Successful" }}
                      {% endif %}
                      {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% elif form_data.regcat == 'formal' %}
          <table class="w-full border text-base" style="font-size: 14px; width: 100%; table-layout: fixed;">
            <thead>
              <tr class="bg-gray-100">
                <th class="border p-3" style="width: 8%; font-weight: bold; font-size: 14px;">S/N</th>
                <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Photo</th>
                <th class="border p-3" style="width: 18%; font-weight: bold; font-size: 14px;">Reg No</th>
                <th class="border p-3" style="width: 22%; font-weight: bold; font-size: 14px;">Name</th>
                <th class="border p-3" style="width: 10%; font-weight: bold; font-size: 14px;">Gender</th>
                {% if papers_list and papers_list|length > 0 %}
                  {% for paper in papers_list %}
                    <th class="border p-3" style="font-weight: bold; font-size: 14px;">{{ paper.code }}<br><span class="text-xs">({{ paper.type }})</span></th>
                  {% endfor %}
                {% else %}
                  <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Theory</th>
                  <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Practical</th>
                {% endif %}
                <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Comment</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in data %}
                <tr>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ forloop.counter }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">
                    {% if entry.candidate.passport_photo_with_regno %}
                      <img src="{{ entry.candidate.passport_photo_with_regno }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                    {% elif entry.candidate.passport_photo %}
                      <img src="{{ entry.candidate.passport_photo }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                    {% else %}
                      <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">No Photo</div>
                    {% endif %}
                  </td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.reg_number }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.full_name }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.gender }}</td>
                  {% if papers_list and papers_list|length > 0 %}
                    {% for paper in papers_list %}
                      <td class="border p-3" style="font-size: 13px; text-align: center;">
                        {% for r in entry.results %}
                          {% if r.paper_code == paper.code %}
                            <span class="inline-block px-2 py-1 rounded {% if r.grade == 'F' or r.grade == 'Ms' or r.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %} mr-1 mb-1">{{ r.grade }}</span>
                          {% endif %}
                        {% endfor %}
                      </td>
                    {% endfor %}
                  {% else %}
                    <td class="border p-3" style="font-size: 13px; text-align: center;">
                      {% for r in entry.results %}
                        {% if r.assessment_type == 'theory' %}
                          <span class="inline-block px-2 py-1 rounded {% if r.grade == 'F' or r.grade == 'Ms' or r.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %} mr-1 mb-1">{{ r.grade }}</span>
                        {% endif %}
                      {% endfor %}
                    </td>
                    <td class="border p-3" style="font-size: 13px; text-align: center;">
                      {% for r in entry.results %}
                        {% if r.assessment_type == 'practical' %}
                          <span class="inline-block px-2 py-1 rounded {% if r.grade == 'F' or r.grade == 'Ms' or r.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %} mr-1 mb-1">{{ r.grade }}</span>
                        {% endif %}
                      {% endfor %}
                    </td>
                  {% endif %}
                  <td class="border p-3" style="font-size: 13px; text-align: center;">
                    {% for r in entry.results %}
                      {% if r.comment == 'Missing' or r.comment == 'Fail' %}
                        <span class="font-bold text-red-600">{{ r.comment }}</span>
                      {% elif r.comment == 'CTR' %}
                        <span class="font-bold text-red-600">Fail</span>
                      {% else %}
                        {{ r.comment|default:"Successful" }}
                      {% endif %}
                      {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% elif form_data.regcat == 'informal' %}
          {% if informal_module_data %}
            {% for center_name, center_modules in informal_module_data.items %}
              <!-- Center Header -->
              <div class="mb-4 mt-6">
                <h2 class="text-xl font-bold text-center bg-blue-100 p-3 border">
                  ASSESSMENT CENTER: {{ center_name }}
                </h2>
              </div>
              
              {% for module_name, module_info in center_modules.items %}
                {% if module_info.candidates %}
                  <!-- Module Header -->
                  <div class="mb-4 mt-6">
                    <h3 class="text-lg font-bold text-center bg-gray-100 p-3 border">
                      MODULE: {{ module_name }}
                    </h3>
                  </div>
                  
                  <!-- Module Table -->
                  <table class="w-full border text-base mb-6" style="font-size: 14px; width: 100%; table-layout: fixed;">
                    <thead>
                      <tr class="bg-gray-100">
                        <th class="border p-3" style="width: 6%; font-weight: bold; font-size: 14px;">S/N</th>
                        <th class="border p-3" style="width: 10%; font-weight: bold; font-size: 14px;">Photo</th>
                        <th class="border p-3" style="width: 15%; font-weight: bold; font-size: 14px;">Reg No</th>
                        <th class="border p-3" style="width: 20%; font-weight: bold; font-size: 14px;">Name</th>
                        <th class="border p-3" style="width: 8%; font-weight: bold; font-size: 14px;">Gender</th>
                        {% for paper in module_info.papers %}
                          <th class="border p-3" style="width: 8%; font-weight: bold; font-size: 14px;">{{ paper.code }}</th>
                        {% endfor %}
                        <th class="border p-3" style="width: 10%; font-weight: bold; font-size: 14px;">Comment</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for candidate in module_info.candidates %}
                        <tr>
                          <td class="border p-3" style="font-size: 13px; text-align: center;">{{ forloop.counter }}</td>
                          <td class="border p-3" style="font-size: 13px; text-align: center;">
                            {% if candidate.passport_photo_with_regno %}
                              <img src="{{ candidate.passport_photo_with_regno }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                            {% elif candidate.passport_photo %}
                              <img src="{{ candidate.passport_photo }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                            {% else %}
                              <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">No Photo</div>
                            {% endif %}
                          </td>
                          <td class="border p-3" style="font-size: 13px; text-align: center;">{{ candidate.reg_number }}</td>
                          <td class="border p-3" style="font-size: 13px; text-align: center;">{{ candidate.full_name }}</td>
                          <td class="border p-3" style="font-size: 13px; text-align: center;">{{ candidate.gender }}</td>
                          {% for paper in module_info.papers %}
                            <td class="border p-3" style="font-size: 13px; text-align: center;">
                              {% with paper_result=candidate.paper_results|lookup:paper.id %}
                                {% if paper_result %}
                                  <span class="inline-block px-2 py-1 rounded {% if paper_result.grade == 'F' or paper_result.grade == 'Ms' or paper_result.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ paper_result.grade }}
                                  </span>
                                {% else %}
                                  <span class="text-gray-400">N/A</span>
                                {% endif %}
                              {% endwith %}
                            </td>
                          {% endfor %}
                          <td class="border p-3" style="font-size: 13px; text-align: center;">
                            {% for r in candidate.paper_results.values %}
                              {% if r.comment == 'Missing' or r.comment == 'Fail' %}
                                <span class="font-bold text-red-600">{{ r.comment }}</span>
                              {% elif r.comment == 'CTR' %}
                                <span class="font-bold text-red-600">Fail</span>
                              {% else %}
                                {{ r.comment|default:"Successful" }}
                              {% endif %}
                              {% if not forloop.last %}, {% endif %}
                            {% endfor %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% endif %}
              {% endfor %}
              
              <!-- Page break after each center -->
              <div class="page-break-after"></div>
            {% endfor %}
          {% else %}
            <div class="border rounded p-6 text-gray-400 text-center">No informal results found for the selected parameters.</div>
          {% endif %}
          
      </div>
        {% endif %}
    {% else %}
      <div class="border rounded p-6 text-gray-400 text-center">No candidates with results found for this center.</div>
    {% endif %}
    </div> <!-- End center-page -->
    {% empty %}
    <div class="border rounded p-6 text-gray-400 text-center">No candidates with results found for the selected parameters.</div>
    {% endfor %}
  {% else %}
    <!-- Single center display with full header -->
    <div class="flex items-center justify-between mb-4">
      <img src="{{ logo_path }}" alt="UVTAB Logo" class="h-14">
      <div class="text-center flex-1">
        <div class="text-lg font-bold tracking-wide">UGANDA VOCATIONAL AND TECHNICAL ASSESSMENT BOARD</div>
        <div class="text-md font-semibold">PROVISIONAL ASSESSMENT RESULTS FOR</div>
        <div class="text-md font-semibold">ASSESSMENT PERIOD: {{ formatted_period }}</div>
      </div>
      <div class="text-right text-xs text-gray-500">Preview Mode</div>
    </div>
    <!-- Single center display -->
    <div class="mb-2 font-semibold">
      Category: {{ form_data.regcat|title }}
      {% if form_data.level_name and form_data.regcat == 'formal' %} | Level: {{ form_data.level_name }}{% elif form_data.level_name and form_data.regcat == 'informal' %} | Level: {{ form_data.level_name }}{% endif %}<br>
      Occupation: {{ form_data.occupation_name }}<br>
      {% if form_data.center_id %}Assessment Center: {{ form_data.center_name }}{% endif %}
    </div>
    {% if result_data and result_data|length > 0 %}
      <div class="overflow-x-auto">
        {% if form_data.regcat == 'formal' %}
          <table class="w-full border text-base" style="font-size: 14px; width: 100%; table-layout: fixed;">
            <thead>
              <tr class="bg-gray-100">
                <th class="border p-3" style="width: 8%; font-weight: bold; font-size: 14px;">S/N</th>
                <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Photo</th>
                <th class="border p-3" style="width: 18%; font-weight: bold; font-size: 14px;">Reg No</th>
                <th class="border p-3" style="width: 22%; font-weight: bold; font-size: 14px;">Name</th>
                <th class="border p-3" style="width: 10%; font-weight: bold; font-size: 14px;">Gender</th>
                {% if papers_list and papers_list|length > 0 %}
                  {% for paper in papers_list %}
                    <th class="border p-3" style="font-weight: bold; font-size: 14px;">{{ paper.code }}<br>({{ paper.type }})</th>
                  {% endfor %}
                {% else %}
                  <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Theory</th>
                  <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Practical</th>
                {% endif %}
                <th class="border p-3" style="width: 12%; font-weight: bold; font-size: 14px;">Comment</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in result_data %}
                <tr>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ forloop.counter }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">
                    {% if entry.candidate.passport_photo_with_regno %}
                      <img src="{{ entry.candidate.passport_photo_with_regno }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                    {% elif entry.candidate.passport_photo %}
                      <img src="{{ entry.candidate.passport_photo }}" alt="Photo" class="w-12 h-12 object-cover rounded">
                    {% else %}
                      <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">No Photo</div>
                    {% endif %}
                  </td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.reg_no }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.name }}</td>
                  <td class="border p-3" style="font-size: 13px; text-align: center;">{{ entry.candidate.gender }}</td>
                  {% if papers_list and papers_list|length > 0 %}
                    {% for paper in papers_list %}
                      <td class="border p-3" style="font-size: 13px; text-align: center;">
                        {% for r in entry.results %}
                          {% if r.paper_code == paper.code %}
                            <span class="inline-block px-2 py-1 rounded {% if r.grade == 'F' or r.grade == 'Ms' or r.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %} mr-1 mb-1">{{ r.grade }}</span>
                          {% endif %}
                        {% endfor %}
                      </td>
                    {% endfor %}
                  {% else %}
                    <td class="border p-3" style="font-size: 13px; text-align: center;">
                      {% for r in entry.results %}
                        {% if r.assessment_type == 'theory' %}
                          <span class="inline-block px-2 py-1 rounded {% if r.grade == 'F' or r.grade == 'Ms' or r.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %} mr-1 mb-1">{{ r.grade }}</span>
                        {% endif %}
                      {% endfor %}
                    </td>
                    <td class="border p-3" style="font-size: 13px; text-align: center;">
                      {% for r in entry.results %}
                        {% if r.assessment_type == 'practical' %}
                          <span class="inline-block px-2 py-1 rounded {% if r.grade == 'F' or r.grade == 'Ms' or r.comment == 'CTR' %}bg-red-500 text-white{% else %}bg-green-100 text-green-800{% endif %} mr-1 mb-1">{{ r.grade }}</span>
                        {% endif %}
                      {% endfor %}
                    </td>
                  {% endif %}
                  <td class="border p-3" style="font-size: 13px; text-align: center;">
                    {% for r in entry.results %}
                      {% if r.comment == 'Missing' or r.comment == 'Fail' %}
                        <span class="font-bold text-red-600">{{ r.comment }}</span>
                      {% elif r.comment == 'CTR' %}
                        <span class="font-bold text-red-600">Fail</span>
                      {% else %}
                        {{ r.comment|default:"Successful" }}
                      {% endif %}
                      {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
      </div>
    {% else %}
      <div class="border rounded p-6 text-gray-400 text-center">No candidates with results found.</div>
    {% endif %}
  {% endif %}
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const occupationSelect = document.getElementById('occupation');
    const levelSelect = document.getElementById('level');
    const levelWrapper = document.getElementById('level_wrapper');
    const regCategorySelect = document.getElementById('reg_category');
    
    // Function to load levels for selected occupation
    function loadLevelsForOccupation(occupationId) {
        if (!occupationId) {
            levelSelect.innerHTML = '<option value="">Select Level</option>';
            return;
        }
        
        // Show loading state
        levelSelect.innerHTML = '<option value="">Loading levels...</option>';
        
        // Fetch levels via AJAX
        fetch(`/eims/api/levels-for-occupation/?occupation_id=${occupationId}`)
            .then(response => response.json())
            .then(data => {
                // Clear existing options
                levelSelect.innerHTML = '<option value="">Select Level</option>';
                
                // Add new options
                data.levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.id;
                    option.textContent = level.name;
                    
                    // Preserve selected value if it exists
                    const selectedLevelId = '{{ form_data.level_id|default:"" }}';
                    if (selectedLevelId && level.id == selectedLevelId) {
                        option.selected = true;
                    }
                    
                    levelSelect.appendChild(option);
                });
                
                // Show message if no levels found
                if (data.levels.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No levels available for this occupation';
                    option.disabled = true;
                    levelSelect.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading levels:', error);
                levelSelect.innerHTML = '<option value="">Error loading levels</option>';
            });
    }
    
    // Function to toggle level visibility based on registration category
    function toggleLevelVisibility() {
        const regCategory = regCategorySelect.value;
        if (regCategory === 'formal' || regCategory === 'informal') {
            levelWrapper.classList.remove('hidden');
        } else {
            levelWrapper.classList.add('hidden');
            levelSelect.innerHTML = '<option value="">Select Level</option>';
        }
    }
    
    // Event listeners
    occupationSelect.addEventListener('change', function() {
        const occupationId = this.value;
        loadLevelsForOccupation(occupationId);
    });
    
    regCategorySelect.addEventListener('change', function() {
        toggleLevelVisibility();
        // Clear level selection when category changes
        levelSelect.innerHTML = '<option value="">Select Level</option>';
    });
    
    // Load levels on page load if occupation is already selected
    if (occupationSelect.value) {
        loadLevelsForOccupation(occupationSelect.value);
    }
    
    // Set initial level visibility
    toggleLevelVisibility();
});
</script>

{% endblock %}
