{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 px-4">
  <!-- Header Section -->
  <div class="mb-8">
      <a href="{% url 'occupation_list' %}" class="text-blue-600 hover:underline mb-4 inline-block">
        ‚Üê Back to Occupations
      </a>
    <div class="flex justify-between items-center mt-4">
      <h1 class="text-3xl font-normal" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">{{ occupation.name }} <span class="text-gray-500">({{ occupation.code }})</span></h1>
      <a href="{% url 'occupation_edit' pk=occupation.pk %}" 
         class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
        Edit
      </a>
    </div>
  </div>

  <!-- General Info Card -->
  <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
    <h2 class="text-xl font-normal mb-4" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">General Information</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <p class="text-gray-600">Category</p>
        <p class="text-lg">{{ occupation.category.name }}</p>
      </div>
      <div>
        <p class="text-gray-600">Occupation Fees</p>
        <div class="space-y-2">
          {% if occupation.has_modular %}
            <!-- Modular Fees (if occupation supports modular) -->
            <div class="flex items-center justify-between bg-blue-50 px-3 py-2 rounded">
              <span class="text-sm font-medium text-blue-800">Single Module Fee:</span>
              <span class="text-sm font-semibold text-blue-900">UGX {{ levels.0.modular_fee_single|floatformat:2 }}</span>
            </div>
            <div class="flex items-center justify-between bg-blue-50 px-3 py-2 rounded">
              <span class="text-sm font-medium text-blue-800">Double Module Fee:</span>
              <span class="text-sm font-semibold text-blue-900">UGX {{ levels.0.modular_fee_double|floatformat:2 }}</span>
            </div>
          {% endif %}
          
          {% if occupation.category.name == 'Formal' %}
            <!-- Level Fees for Formal occupations -->
            {% for level in levels %}
              <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                <span class="text-sm font-medium text-gray-700">{{ level.name }} Formal Fee:</span>
                <span class="text-sm font-semibold text-gray-900">UGX {{ level.formal_fee|floatformat:2 }}</span>
              </div>
            {% endfor %}
          {% elif occupation.category.name == 'Informal' or 'Worker' in occupation.category.name or 'PAS' in occupation.category.name %}
            <!-- Single per-module fee for Worker's PAS -->
            <div class="flex items-center justify-between bg-orange-50 px-3 py-2 rounded border-l-4 border-orange-400">
              <div>
                <span class="text-sm font-medium text-orange-700">Per-Module Fee:</span>
              </div>
              <span class="text-sm font-semibold text-orange-900">UGX {{ levels.0.workers_pas_module_fee|floatformat:2 }}</span>
            </div>
          {% endif %}
          
          <!-- Edit Fees Button -->
          <div class="mt-3">
            <button onclick="toggleFeesEdit()" class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Edit Fees
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div class="border-b border-gray-200">
    <ul class="flex -mb-px">
      {% for level in levels %}
        <li class="mr-6">
          <a class="tab-link py-4 px-1 border-b-2 {% if forloop.first %}border-blue-500 text-blue-600{% else %}border-transparent{% endif %} hover:border-gray-300" 
             href="#level-{{ level.id }}">{{ level.name }}</a>
        </li>
      {% endfor %}
    </ul>
  </div>

<!-- Level Content Tabs -->
{% for row in level_data %}
  <div id="level-{{ row.level.id }}" class="tab-content mt-8 bg-white rounded-lg shadow-sm p-6">
  <!--   <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-semibold">{{ row.level.name }} Content</h2>
      {% if occupation.structure_type == 'modules' %}
        <a href="{% url 'add_module' row.level.id %}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
          + Add Module
        </a>
      {% else %}
        <a href="{% url 'add_paper' row.level.id %}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
          + Add Paper
        </a>
      {% endif %}
    </div> -->

    
<div class="bg-gray-50 rounded-lg p-6">
      {% if row.structure_type == 'modules' %}
        {% if row.content %}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for module in row.content %}
              <div class="bg-white p-4 rounded-md shadow-sm">
                <p class="font-medium">{{ module.name }}</p>
                
                {% if module.papers|length %}
                  <ul class="list-disc list-inside mt-2 text-gray-700">
                    {% for paper in module.papers %}
                      <li><span class="font-mono">{{ paper.code }}</span>: {{ paper.name }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  {% if occupation.category.name == "Worker's PAS" %}
                    <p class="text-gray-400 text-sm mt-2">No papers added yet.</p>
                  {% endif %}
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-gray-400 text-sm mt-2">No modules added yet.</p>
        {% endif %}
      {% else %}
        {% if row.content %}
          <ul class="list-disc ml-6">
            {% for paper in row.content %}
              <li>{{ paper.code }} - {{ paper.name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-gray-400 text-sm mt-2">No papers added yet.</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endfor %}
</div>

<!-- Audit Trail -->
<div class="text-xs text-gray-500 mt-4 text-right">
  <p>Created: {{ occupation.created_at|date:'Y-m-d H:i' }}{% if occupation.created_by %} by {{ occupation.created_by }}{% endif %}</p>
  <p>Last updated: {{ occupation.updated_at|date:'Y-m-d H:i' }}{% if occupation.updated_by %} by {{ occupation.updated_by }}{% endif %}</p>
</div>

<!-- Tab switching script -->
<script>
  const tabLinks = document.querySelectorAll(".tab-link");
  const tabContents = document.querySelectorAll(".tab-content");

  tabLinks.forEach(link => {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      const target = link.getAttribute("href").substring(1);

      tabContents.forEach(tc => tc.style.display = "none");
      document.getElementById(target).style.display = "block";

      tabLinks.forEach(l => {
        l.classList.remove("border-blue-500", "text-blue-600");
        l.classList.add("border-transparent");
      });
      link.classList.remove("border-transparent");
      link.classList.add("border-blue-500", "text-blue-600");
    });
  });

  // Initialize first tab
  tabContents.forEach((tc, i) => tc.style.display = i === 0 ? "block" : "none");

  // Fees editing functionality
  function toggleFeesEdit() {
    const modal = document.getElementById('feesEditModal');
    if (modal) {
      modal.style.display = 'block';
    } else {
      createFeesEditModal();
    }
  }

  function createFeesEditModal() {
    const modalHTML = `
      <div id="feesEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
          <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Occupation Fees</h3>
            <form id="feesEditForm">
              {% csrf_token %}
              
              {% if occupation.has_modular %}
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Single Module Fee (UGX)</label>
                  <input type="number" name="modular_fee_single" step="0.01" min="0" 
                         value="{{ levels.0.modular_fee_single }}" 
                         class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Double Module Fee (UGX)</label>
                  <input type="number" name="modular_fee_double" step="0.01" min="0" 
                         value="{{ levels.0.modular_fee_double }}" 
                         class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              {% endif %}
              
              {% if occupation.category.name == 'Formal' %}
                <!-- Formal occupation: show fees per level -->
                {% for level in levels %}
                  <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ level.name }} Formal Fee (UGX)</label>
                    <input type="number" name="formal_fee_{{ level.id }}" step="0.01" min="0" 
                           value="{{ level.formal_fee }}" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                {% endfor %}
              {% elif occupation.category.name == 'Informal' or 'Worker' in occupation.category.name or 'PAS' in occupation.category.name %}
                <!-- Worker's PAS: show single per-module fee -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Per-Module Fee (UGX)</label>
                  <input type="number" name="workers_pas_module_fee" step="0.01" min="0" 
                         value="{{ levels.0.workers_pas_module_fee }}" 
                         class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <p class="text-xs text-gray-500 mt-1">This fee will be multiplied by the number of modules each candidate enrolls in</p>
                </div>
              {% endif %}
              
              <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeFeesModal()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                  Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add form submission handler
    document.getElementById('feesEditForm').addEventListener('submit', function(e) {
      e.preventDefault();
      submitFeesUpdate();
    });
  }

  function closeFeesModal() {
    const modal = document.getElementById('feesEditModal');
    if (modal) {
      modal.remove();
    }
  }

  function submitFeesUpdate() {
    const form = document.getElementById('feesEditForm');
    const formData = new FormData(form);
    
    fetch('{% url "update_occupation_fees" occupation.id %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Reload the page to show updated fees
        window.location.reload();
      } else {
        alert('Error updating fees: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating fees. Please try again.');
    });
  }

  // Close modal when clicking outside
  document.addEventListener('click', function(e) {
    const modal = document.getElementById('feesEditModal');
    if (modal && e.target === modal) {
      closeFeesModal();
    }
  });
</script>
{% endblock %}
